<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ReadUp! ‚Äî Transforming Youth Inc.</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --sun: #FFD93D; --sky: #6BCB77; --ocean: #4D96FF;
    --coral: #FF6B6B; --purple: #A259FF; --cloud: #FFF8F0;
    --ink: #2D2A3E; --soft: #F0EBF8;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Nunito', sans-serif; background: #FFF8F0; min-height: 100vh; overflow-x: hidden; }

.bg { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; }
.blob { position: absolute; border-radius: 50%; opacity: 0.15; filter: blur(60px); animation: drift 12s ease-in-out infinite alternate; }
.blob1 { width: 400px; height: 400px; background: #4D96FF; top: -100px; left: -100px; }
.blob2 { width: 300px; height: 300px; background: #FFD93D; top: 60%; right: -80px; animation-delay: -4s; }
.blob3 { width: 350px; height: 350px; background: #6BCB77; bottom: -80px; left: 30%; animation-delay: -8s; }
@keyframes drift { from { transform: translate(0,0) scale(1); } to { transform: translate(30px,20px) scale(1.08); } }

.app { position: relative; z-index: 1; max-width: 780px; margin: 0 auto; padding: 20px 20px 60px; }

header { text-align: center; padding: 24px 0 16px; }
.logo { font-family: 'Fredoka One', cursive; font-size: 3rem; color: #4D96FF; text-shadow: 4px 4px 0 #FFD93D; animation: popIn 0.6s cubic-bezier(0.34,1.56,0.64,1) both; }
.tagline { font-size: 0.95rem; color: #555; font-weight: 700; margin-top: 4px; }
.nonprofit-badge { display: inline-block; margin-top: 6px; background: #6BCB77; color: white; font-size: 0.72rem; font-weight: 800; letter-spacing: 1px; padding: 4px 14px; border-radius: 20px; text-transform: uppercase; }
.dedication { display: block; margin-top: 8px; font-size: 0.82rem; font-weight: 800; color: #FF6B6B; font-style: italic; }
.dedication span { color: #A259FF; }
@keyframes popIn { from { opacity:0; transform: scale(0.5); } to { opacity:1; transform: scale(1); } }

.screen { display: none; animation: fadeUp 0.4s ease both; }
.screen.active { display: block; }
@keyframes fadeUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

.card { background: #ffffff; border-radius: 24px; box-shadow: 0 8px 32px rgba(45,42,62,0.12); padding: 28px; margin-top: 20px; border: 1px solid #eee; }
.card-title { font-family: 'Fredoka One', cursive; font-size: 1.6rem; color: #2D2A3E; margin-bottom: 18px; }
.section-label { font-weight: 800; color: #666; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }

.option-row { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
.opt-btn {
  flex: 1; min-width: 56px; padding: 10px 6px;
  border: 3px solid #E0D8F0; border-radius: 14px;
  background: #ffffff; font-family: 'Nunito'; font-weight: 800;
  font-size: 0.88rem; cursor: pointer; transition: all 0.2s;
  color: #2D2A3E; text-align: center;
}
.opt-btn:hover { border-color: #aaa; background: #f5f5f5; }
.opt-btn.sel-grade { border-color: #6BCB77; background: #EFFFF4; color: #1B7A3E; }
.opt-btn.sel-words { border-color: #4D96FF; background: #EEF5FF; color: #1A5CC8; }

.categories { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.cat-btn {
  background: #F0EBF8; border: 3px solid transparent;
  border-radius: 18px; padding: 16px 10px;
  cursor: pointer; transition: all 0.2s;
  text-align: center; font-family: 'Nunito';
  font-weight: 800; font-size: 0.9rem; color: #2D2A3E;
}
.cat-btn .emoji { font-size: 2rem; display: block; margin-bottom: 5px; }
.cat-btn:hover { border-color: #4D96FF; background: #EEF5FF; transform: translateY(-3px); box-shadow: 0 6px 18px rgba(77,150,255,0.2); }
.cat-btn.selected { border-color: #4D96FF; background: #EEF5FF; transform: translateY(-3px); box-shadow: 0 6px 18px rgba(77,150,255,0.2); }

.btn-main {
  display: block; width: 100%; margin-top: 16px; padding: 16px;
  border-radius: 18px; border: none;
  background: linear-gradient(135deg, #4D96FF, #6A5AFF);
  color: #ffffff; font-family: 'Fredoka One', cursive;
  font-size: 1.3rem; cursor: pointer; transition: all 0.2s;
  box-shadow: 0 6px 20px rgba(77,150,255,0.45);
  -webkit-appearance: none;
}
.btn-main:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(77,150,255,0.55); }
.btn-main:active { transform: translateY(0); }
.btn-main:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-green { background: linear-gradient(135deg, #6BCB77, #1BA053) !important; box-shadow: 0 6px 20px rgba(107,203,119,0.45) !important; color: #ffffff !important; }
.btn-coral { background: linear-gradient(135deg, #FF6B6B, #FF9A3C) !important; box-shadow: 0 6px 20px rgba(255,107,107,0.45) !important; color: #ffffff !important; }
.btn-purple { background: linear-gradient(135deg, #A259FF, #FF6FD8) !important; box-shadow: 0 6px 20px rgba(162,89,255,0.4) !important; color: #ffffff !important; }
.btn-yellow { background: linear-gradient(135deg, #FFD93D, #FFA500) !important; box-shadow: 0 6px 20px rgba(255,165,0,0.4) !important; color: #2D2A3E !important; }
.btn-gray { background: linear-gradient(135deg, #aaa, #888) !important; box-shadow: 0 4px 14px rgba(0,0,0,0.2) !important; color: #ffffff !important; }
.btn-outline {
  background: #ffffff !important; color: #4D96FF !important;
  border: 3px solid #4D96FF !important; box-shadow: none !important; font-size: 1rem;
}
.btn-outline:hover { background: #EEF5FF !important; transform: translateY(-2px); }

.or-divider { display: flex; align-items: center; gap: 12px; margin: 6px 0 0; }
.or-divider::before, .or-divider::after { content:''; flex:1; height:2px; background: #e8e0f4; border-radius:2px; }
.or-divider span { font-weight: 800; color: #bbb; font-size: 0.85rem; }

#story-text { font-size: 1.4rem; line-height: 2.2rem; color: #2D2A3E; font-weight: 700; }
.word { display: inline-block; padding: 3px 5px; border-radius: 7px; transition: background 0.05s, transform 0.05s, color 0.05s; cursor: default; }
.word.highlight { background: #FFD93D !important; color: #2D2A3E !important; transform: scale(1.15) !important; box-shadow: 0 2px 8px rgba(255,180,0,0.5); }
.word.done { color: #6BCB77; }

/* ‚îÄ‚îÄ Voice selector ‚îÄ‚îÄ */
.voice-row { display: flex; gap: 10px; margin: 14px 0 4px; align-items: center; }
.voice-label { font-weight: 800; color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; flex-shrink: 0; }
.voice-btn {
  flex: 1; padding: 9px 6px; border-radius: 12px;
  border: 3px solid #e0d8f0; background: #ffffff;
  font-family: 'Nunito'; font-weight: 800; font-size: 0.9rem;
  color: #2D2A3E; cursor: pointer; transition: all 0.2s; text-align: center;
}
.voice-btn:hover { border-color: #aaa; }
.voice-btn.sel-voice { border-color: #A259FF; background: #F5EEFF; color: #6A1FCC; }

/* ‚îÄ‚îÄ Speed slider ‚îÄ‚îÄ */
.speed-slider-row { margin: 16px 0 4px; }
.speed-slider-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.speed-slider-label { font-weight: 800; color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
.speed-value-badge { background: #EEF5FF; border: 2px solid #4D96FF; border-radius: 10px; padding: 2px 10px; font-family: 'Fredoka One'; font-size: 1rem; color: #4D96FF; }
input[type=range].speed-slider {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 10px; border-radius: 10px;
  background: linear-gradient(90deg, #4D96FF 0%, #6BCB77 100%);
  outline: none; cursor: pointer;
}
input[type=range].speed-slider::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: 28px; height: 28px; border-radius: 50%;
  background: #ffffff; border: 4px solid #4D96FF;
  box-shadow: 0 2px 8px rgba(77,150,255,0.4);
  cursor: pointer; transition: border-color 0.2s;
}
input[type=range].speed-slider::-webkit-slider-thumb:hover { border-color: #A259FF; }
.speed-emoji-row { display: flex; justify-content: space-between; font-size: 0.78rem; font-weight: 800; color: #bbb; margin-top: 4px; padding: 0 2px; }

/* ‚îÄ‚îÄ TTS controls ‚îÄ‚îÄ */
.tts-controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 14px; }
.tts-controls .btn-main { margin-top: 0; font-size: 1rem; padding: 14px 8px; }

.listening-badge { display: none; align-items: center; gap: 8px; background: #FFF0F0; border: 2px solid #FF6B6B; border-radius: 14px; padding: 10px 16px; margin-top: 14px; font-weight: 800; color: #FF6B6B; }
.listening-badge.active { display: flex; }
.mic-pulse { width: 14px; height: 14px; border-radius: 50%; background: #FF6B6B; animation: pulse 0.9s ease infinite; }
@keyframes pulse { 0%,100%{transform:scale(1);opacity:1;} 50%{transform:scale(1.4);opacity:0.5;} }

.processing-badge { display: none; align-items: center; gap: 8px; background: #F0EBF8; border: 2px solid #A259FF; border-radius: 14px; padding: 10px 16px; margin-top: 14px; font-weight: 800; color: #A259FF; }
.processing-badge.active { display: flex; }

.room-code-display { background: linear-gradient(135deg, #EEF5FF, #F0EBF8); border-radius: 20px; padding: 22px; text-align: center; margin: 14px 0; }
.room-code-number { font-family: 'Fredoka One'; font-size: 4rem; color: #4D96FF; letter-spacing: 12px; line-height: 1; }
.room-code-label { font-weight: 800; color: #888; font-size: 0.82rem; margin-top: 8px; text-transform: uppercase; letter-spacing: 1px; }

.code-input { width: 100%; padding: 16px; border: 3px solid #E0D8F0; border-radius: 16px; font-family: 'Fredoka One'; font-size: 2rem; text-align: center; letter-spacing: 8px; color: #2D2A3E; outline: none; transition: border 0.2s; margin: 14px 0 4px; }
.code-input:focus { border-color: #4D96FF; }

.player-slots { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 14px 0; }
.player-slot { border: 3px solid #E0D8F0; border-radius: 18px; padding: 18px; text-align: center; transition: all 0.3s; }
.player-slot.joined { border-color: #6BCB77; background: #EFFFF4; }
.player-slot.me { border-color: #4D96FF; background: #EEF5FF; }
.slot-icon { font-size: 2rem; display: block; margin-bottom: 6px; }
.slot-name { font-family: 'Fredoka One'; font-size: 1rem; color: #2D2A3E; }
.slot-status { font-size: 0.76rem; font-weight: 800; color: #aaa; margin-top: 4px; }
.player-slot.joined .slot-status, .player-slot.me .slot-status { color: #6BCB77; }

.waiting-dots span { animation: blink 1.2s ease infinite; display: inline-block; }
.waiting-dots span:nth-child(2) { animation-delay: 0.2s; }
.waiting-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%,100%{opacity:0.2;} 50%{opacity:1;} }

.countdown-wrap { text-align: center; padding: 50px 0; }
.countdown-number { font-family: 'Fredoka One'; font-size: 8rem; color: #4D96FF; line-height: 1; animation: countPop 0.4s cubic-bezier(0.34,1.56,0.64,1) both; }
.countdown-go { font-family: 'Fredoka One'; font-size: 5rem; color: #6BCB77; animation: countPop 0.4s cubic-bezier(0.34,1.56,0.64,1) both; }
@keyframes countPop { from { opacity:0; transform:scale(0.3); } to { opacity:1; transform:scale(1); } }

.stars { font-size: 2.8rem; text-align: center; letter-spacing: 8px; margin: 10px 0; }
.wpm-block { background: linear-gradient(135deg, #EEF5FF, #F0EBF8); border-radius: 20px; padding: 20px; text-align: center; margin: 14px 0; }
.wpm-number { font-family: 'Fredoka One'; font-size: 4.5rem; color: #4D96FF; line-height: 1; display: block; }
.wpm-unit { font-weight: 800; color: #555; font-size: 1.05rem; margin-top: 6px; }
.wpm-context { font-size: 0.82rem; color: #999; font-weight: 700; margin-top: 6px; }

.results-vs { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin: 14px 0; }
.result-player { border-radius: 20px; padding: 18px 10px; text-align: center; }
.result-player.winner { background: linear-gradient(135deg, #FFFDE7, #FFF9C4); border: 3px solid #FFD93D; }
.result-player.loser { background: #F0EBF8; border: 3px solid #ddd; }
.result-player.tie { background: linear-gradient(135deg, #EEF5FF, #F0EBF8); border: 3px solid #4D96FF; }
.result-player-name { font-family: 'Fredoka One'; font-size: 0.95rem; color: #2D2A3E; margin-bottom: 6px; }
.result-player-wpm { font-family: 'Fredoka One'; font-size: 2.8rem; color: #4D96FF; line-height: 1; }
.result-player-unit { font-size: 0.75rem; font-weight: 800; color: #aaa; }
.vs-divider { font-family: 'Fredoka One'; font-size: 1.3rem; color: #ccc; text-align: center; }
.encouragement { background: #F0EBF8; border-radius: 16px; padding: 14px 18px; font-weight: 700; color: #2D2A3E; text-align: center; font-size: 1rem; margin-bottom: 16px; }

.progress-wrap { background: #E8E0F4; border-radius: 20px; height: 14px; margin: 14px 0; overflow: hidden; }
.progress-bar { height: 100%; border-radius: 20px; background: linear-gradient(90deg, #4D96FF, #6BCB77); transition: width 0.15s; width: 0%; }
.vs-progress { margin: 12px 0; }
.vs-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.vs-name { font-weight: 800; font-size: 0.82rem; width: 52px; flex-shrink: 0; }
.vs-bar-wrap { flex: 1; background: #E8E0F4; border-radius: 20px; height: 10px; overflow: hidden; }
.vs-bar { height: 100%; border-radius: 20px; transition: width 0.4s; width: 0%; }
.vs-bar.me-bar { background: linear-gradient(90deg, #4D96FF, #6A5AFF); }
.vs-bar.them-bar { background: linear-gradient(90deg, #FF6B6B, #FF9A3C); }
.vs-pct { font-weight: 800; font-size: 0.8rem; width: 36px; text-align: right; color: #888; flex-shrink: 0; }

.spinner { text-align: center; padding: 40px; }
.spin-circle { width: 52px; height: 52px; border-radius: 50%; border: 6px solid #E8E0F4; border-top-color: #4D96FF; animation: spin 0.8s linear infinite; margin: 0 auto 14px; }
@keyframes spin { to { transform: rotate(360deg); } }
.spin-label { font-family: 'Fredoka One'; font-size: 1.2rem; color: #4D96FF; }
.ai-badge { display: inline-block; background: linear-gradient(135deg, #A259FF, #4D96FF); color: white; font-size: 0.72rem; font-weight: 800; letter-spacing: 1px; padding: 3px 10px; border-radius: 20px; text-transform: uppercase; margin-left: 8px; vertical-align: middle; }

footer { text-align: center; margin-top: 40px; color: #aaa; font-size: 0.78rem; font-weight: 600; }
footer strong { color: #4D96FF; }

@media (max-width: 480px) {
  .logo { font-size: 2.4rem; }
  .categories { grid-template-columns: repeat(2, 1fr); }
  #story-text { font-size: 1.15rem; line-height: 1.95rem; }
  .card { padding: 20px 14px; }
  .wpm-number { font-size: 3.5rem; }
  .result-player-wpm { font-size: 2.2rem; }
  .countdown-number { font-size: 6rem; }
  .tts-controls { grid-template-columns: 1fr 1fr 1fr; }
}
</style>
</head>
<body>
<div class="bg">
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>
  <div class="blob blob3"></div>
</div>

<div class="app">
  <header>
    <div class="logo">üìñ ReadUp!</div>
    <div class="tagline">Stories made just for you</div>
    <div class="nonprofit-badge">Transforming Youth Inc.</div>
    <span class="dedication">‚ú® Inspired by <span>Kamryn</span> &amp; <span>Christopher II</span> ‚ú®</span>
  </header>

  <!-- SCREEN: Pick -->
  <div class="screen active" id="screen-pick">
    <div class="card">
      <div class="card-title">Build your story! üåü</div>
      <div class="section-label">Your grade:</div>
      <div class="option-row" id="grade-row">
        <button class="opt-btn sel-grade" data-grade="1">1st</button>
        <button class="opt-btn" data-grade="2">2nd</button>
        <button class="opt-btn" data-grade="3">3rd</button>
      </div>
      <div class="section-label">Story length (words):</div>
      <div class="option-row" id="words-row">
        <button class="opt-btn" data-words="50">50</button>
        <button class="opt-btn sel-words" data-words="100">100</button>
        <button class="opt-btn" data-words="150">150</button>
        <button class="opt-btn" data-words="200">200</button>
        <button class="opt-btn" data-words="300">300</button>
        <button class="opt-btn" data-words="500">500</button>
      </div>
      <div class="section-label">Pick a topic:</div>
      <div class="categories">
        <button class="cat-btn selected" data-cat="animals"><span class="emoji">üêæ</span>Animals</button>
        <button class="cat-btn" data-cat="space"><span class="emoji">üöÄ</span>Space</button>
        <button class="cat-btn" data-cat="dinosaurs"><span class="emoji">ü¶ï</span>Dinosaurs</button>
        <button class="cat-btn" data-cat="ocean"><span class="emoji">üê†</span>Ocean</button>
        <button class="cat-btn" data-cat="superheroes"><span class="emoji">ü¶∏</span>Superheroes</button>
        <button class="cat-btn" data-cat="magic"><span class="emoji">üè∞</span>Magic</button>
        <button class="cat-btn" data-cat="sports"><span class="emoji">‚öΩ</span>Sports</button>
        <button class="cat-btn" data-cat="cooking"><span class="emoji">üçï</span>Cooking</button>
        <button class="cat-btn" data-cat="friendship"><span class="emoji">ü§ù</span>Friends</button>
      </div>
      <button class="btn-main" id="btn-generate">‚ú® Make My Story!</button>
      <div class="or-divider"><span>or</span></div>
      <button class="btn-main btn-purple" id="btn-race-start">üèÅ Race a Friend</button>
    </div>
  </div>

  <!-- SCREEN: Loading -->
  <div class="screen" id="screen-loading">
    <div class="card">
      <div class="spinner"><div class="spin-circle"></div><div class="spin-label" id="loading-msg">Getting your story ready...</div></div>
    </div>
  </div>

  <!-- SCREEN: Join -->
  <div class="screen" id="screen-join">
    <div class="card">
      <div class="card-title">Join the Race! üèÅ</div>
      <p style="color:#555;font-weight:700;margin-bottom:4px;">Type your friend's room code:</p>
      <input class="code-input" id="join-code-input" type="text" maxlength="4" placeholder="1234" inputmode="numeric">
      <div id="join-error" style="background:#FFF0F0;border:2px solid #FF6B6B;border-radius:14px;padding:12px 16px;color:#FF6B6B;font-weight:700;margin-top:10px;display:none;"></div>
      <button class="btn-main btn-green" id="btn-join-room">Join Room ‚Üí</button>
      <button class="btn-main btn-outline" id="btn-back-join" style="margin-top:10px;">‚Üê Back</button>
    </div>
  </div>

  <!-- SCREEN: Waiting host -->
  <div class="screen" id="screen-waiting-host">
    <div class="card">
      <div class="card-title">Waiting for your friend <span class="waiting-dots"><span>.</span><span>.</span><span>.</span></span></div>
      <p style="color:#555;font-weight:700;margin-bottom:6px;">Share this code:</p>
      <div class="room-code-display">
        <div class="room-code-number" id="display-room-code">----</div>
        <div class="room-code-label">Room Code</div>
      </div>
      <div class="player-slots">
        <div class="player-slot me"><span class="slot-icon">üßë</span><div class="slot-name">You</div><div class="slot-status">‚úì Ready</div></div>
        <div class="player-slot" id="slot-guest"><span class="slot-icon">üë§</span><div class="slot-name">Friend</div><div class="slot-status">Waiting...</div></div>
      </div>
      <button class="btn-main btn-outline" id="btn-cancel-host" style="margin-top:10px;">Cancel</button>
    </div>
  </div>

  <!-- SCREEN: Waiting guest -->
  <div class="screen" id="screen-waiting-guest">
    <div class="card">
      <div class="card-title">You're in! Get ready... üéâ</div>
      <div class="player-slots">
        <div class="player-slot joined"><span class="slot-icon">üßë</span><div class="slot-name">Host</div><div class="slot-status">‚úì Ready</div></div>
        <div class="player-slot me"><span class="slot-icon">üßë</span><div class="slot-name">You</div><div class="slot-status">‚úì Joined!</div></div>
      </div>
      <p style="text-align:center;color:#aaa;font-weight:700;margin-top:10px;">Starting soon...</p>
    </div>
  </div>

  <!-- SCREEN: Countdown -->
  <div class="screen" id="screen-countdown">
    <div class="card"><div class="countdown-wrap"><div id="countdown-display" class="countdown-number">3</div></div></div>
  </div>

  <!-- SCREEN: Read -->
  <div class="screen" id="screen-read">
    <div class="card">
      <div class="card-title" id="story-title">Your Story</div>

      <div class="vs-progress" id="vs-progress" style="display:none;">
        <div class="vs-row">
          <div class="vs-name" style="color:#4D96FF;">You</div>
          <div class="vs-bar-wrap"><div class="vs-bar me-bar" id="my-progress-bar"></div></div>
          <div class="vs-pct" id="my-pct">0%</div>
        </div>
        <div class="vs-row">
          <div class="vs-name" style="color:#FF6B6B;">Friend</div>
          <div class="vs-bar-wrap"><div class="vs-bar them-bar" id="their-progress-bar"></div></div>
          <div class="vs-pct" id="their-pct">0%</div>
        </div>
      </div>

      <div class="progress-wrap" id="solo-progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>

      <div id="story-text"></div>

      <!-- Voice selector -->
      <div class="voice-row">
        <span class="voice-label">Voice:</span>
        <button class="voice-btn sel-voice" data-voice="female">üë© Female</button>
        <button class="voice-btn" data-voice="male">üë® Male</button>
      </div>

      <!-- Speed slider -->
      <div class="speed-slider-row">
        <div class="speed-slider-label-row">
          <span class="speed-slider-label">‚ö° Speed</span>
          <span class="speed-value-badge" id="speed-display">1.0√ó</span>
        </div>
        <input type="range" class="speed-slider" id="speed-slider" min="0.5" max="2.0" step="0.1" value="1.0">
        <div class="speed-emoji-row">
          <span>üê¢ 0.5√ó</span>
          <span>üö∂ 1.0√ó</span>
          <span>üöÄ 2.0√ó</span>
        </div>
      </div>

      <!-- TTS controls -->
      <div class="tts-controls">
        <button class="btn-main btn-green" id="btn-play">‚ñ∂ Play</button>
        <button class="btn-main btn-yellow" id="btn-pause" disabled>‚è∏ Pause</button>
        <button class="btn-main btn-gray" id="btn-stop-tts" disabled>‚èπ Stop</button>
      </div>

      <div class="listening-badge" id="listening-badge"><div class="mic-pulse"></div>Listening... Read out loud!</div>
      <div class="processing-badge" id="processing-badge"><div class="spin-circle" style="width:20px;height:20px;border-width:3px;margin:0;"></div>&nbsp;Checking your reading...</div>
      <button class="btn-main btn-coral" id="btn-record" style="margin-top:14px;">üé§ My Turn! Read Aloud</button>
      <button class="btn-main btn-outline" id="btn-new" style="margin-top:14px;">‚Üê Pick New Topic</button>
    </div>
  </div>

  <!-- SCREEN: Solo results -->
  <div class="screen" id="screen-solo-results">
    <div class="card">
      <div class="card-title" style="text-align:center;">You did it! üéâ</div>
      <div class="stars" id="solo-stars">‚≠ê‚≠ê‚≠ê</div>
      <div class="wpm-block">
        <span class="wpm-number" id="solo-wpm">--</span>
        <div class="wpm-unit">words per minute</div>
        <div class="wpm-context" id="solo-context"></div>
      </div>
      <div class="encouragement" id="solo-msg"></div>
      <button class="btn-main btn-green" id="btn-solo-retry">üîÑ Read It Again</button>
      <button class="btn-main" id="btn-solo-new" style="margin-top:10px;">üìö New Story</button>
    </div>
  </div>

  <!-- SCREEN: Race results -->
  <div class="screen" id="screen-race-results">
    <div class="card">
      <div class="card-title" style="text-align:center;" id="race-result-title">Race Over!</div>
      <div class="results-vs">
        <div class="result-player" id="rp-left"><div class="result-player-name">You</div><div class="result-player-wpm" id="rp-left-wpm">--</div><div class="result-player-unit">wpm</div></div>
        <div class="vs-divider">VS</div>
        <div class="result-player" id="rp-right"><div class="result-player-name">Friend</div><div class="result-player-wpm" id="rp-right-wpm">--</div><div class="result-player-unit">wpm</div></div>
      </div>
      <div class="encouragement" id="race-msg"></div>
      <button class="btn-main btn-green" id="btn-race-retry">üîÑ Race Again</button>
      <button class="btn-main" id="btn-race-new" style="margin-top:10px;">üìö New Story</button>
    </div>
  </div>
</div>

<footer>
  <strong>ReadUp!</strong> by Transforming Youth Inc. &nbsp;|&nbsp; Free for all kids &nbsp;|&nbsp; Grades 1‚Äì3<br>
  <span style="color:#FF6B6B;font-style:italic;">‚ú® Inspired by Kamryn &amp; Christopher II ‚ú®</span>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseApp = initializeApp({
  apiKey: "AIzaSyCIiKxtE5YV8GV0Fk3HEAO46rEGKEuFfFc",
  authDomain: "readup-transforming-youth.firebaseapp.com",
  databaseURL: "https://readup-transforming-youth-default-rtdb.firebaseio.com",
  projectId: "readup-transforming-youth",
  storageBucket: "readup-transforming-youth.firebasestorage.app",
  messagingSenderId: "394068331923",
  appId: "1:394068331923:web:d00704316cf6ba4b002c66"
});
const db = getDatabase(firebaseApp);

const CF_BASE = "https://us-central1-readup-transforming-youth.cloudfunctions.net";
const CF_STORY = `${CF_BASE}/generateStory`;
const CF_TTS   = `${CF_BASE}/synthesizeSpeech`;
const CF_STT   = `${CF_BASE}/transcribeSpeech`;

// ‚îÄ‚îÄ AI Story Generation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateAIStory(grade, category, wordTarget) {
  const gradeNames = { "1": "1st", "2": "2nd", "3": "3rd" };
  const response = await fetch(CF_STORY, {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      grade: gradeNames[grade] || grade,
      topic: category,
      wordCount: wordTarget,
      instructions: `Write a story that is exactly ${wordTarget} words long. Do NOT include a title, heading, label, or any text before the story. Start the story immediately with the first word. Use natural paragraph breaks every 3-5 sentences to break up the story. Do not use markdown formatting.`
    })
  });
  if (!response.ok) throw new Error("Cloud function error: " + response.status);
  const data = await response.json();
  if (!data.story) throw new Error("No story in response");
  return data.story;
}

// ‚îÄ‚îÄ Fallback stories ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STORIES = {
  animals:{1:[{words:50,title:"Max the Dog",body:"Max is a big brown dog. He loves to run and jump. Every day Max plays in the yard. He barks at birds and chases cats. Max has a red ball. It is his best toy. At night Max sleeps by the door. He is a good dog. Think about it: What is your favorite animal?"},{words:100,title:"The Little Cat",body:"Luna is a small gray cat. She lives in a big yellow house. Every morning Luna wakes up and stretches her legs. She walks to her bowl and eats her food. Then she sits by the window. Luna loves to watch the birds outside. She makes a funny sound when she sees them. In the afternoon Luna takes a long nap on the soft couch. She curls up into a ball and purrs. At night she sleeps with her family. They love her very much. Luna is a happy cat. Think about it: What do you think Luna dreams about?"}],2:[{words:100,title:"Ella the Elephant",body:"Ella was the youngest elephant in the herd. She had giant ears that flopped when she walked. The other elephants said her ears were too big, but Ella did not mind. One hot afternoon the herd got lost in the tall grass. Ella lifted her huge ears and listened carefully. She heard the river far away. She led everyone straight to the cool water. The herd splashed and played until sunset. From that day on, everyone agreed that Ella's ears were the best ears in the whole savanna. Think about it: How can something you feel different about become your greatest strength?"}],3:[{words:150,title:"Ocean Giants",body:"Blue whales are the largest animals ever known to have lived on Earth. A single blue whale can grow longer than three school buses lined up end to end. Their hearts are so large a small child could crawl through the arteries. Yet despite their enormous size, blue whales eat some of the tiniest creatures in the ocean. They feed almost entirely on krill, small shrimp-like animals no bigger than your finger. A blue whale must eat up to four tons of krill every single day just to survive. Blue whales were once nearly hunted to extinction, but international protection has helped their numbers slowly recover. Think about it: What does the blue whale teach us about how big and small things depend on each other?"}]},
  space:{1:[{words:50,title:"A Trip to the Moon",body:"Sam wants to go to the moon. The moon is very far away. You need a big rocket to get there. The rocket goes up, up, up into the dark sky. The moon has no air and no trees. It is cold and gray. But the view of Earth is amazing from up there. Think about it: Would you want to visit the moon?"}],2:[{words:100,title:"Mars, Our Red Neighbor",body:"Mars is the fourth planet from the sun and our closest planetary neighbor. It looks red because its soil is full of iron oxide, which is basically rust. Mars has the tallest volcano in our entire solar system called Olympus Mons. It is three times the height of Mount Everest. Scientists have sent robotic rovers to explore Mars. These rovers drive slowly across the rocky surface, taking photos and testing soil. They have found signs that water once flowed on Mars billions of years ago. Think about it: What would be the hardest part about living on Mars?"}],3:[{words:150,title:"Black Holes",body:"A black hole is one of the strangest objects in the universe. It forms when a massive star runs out of fuel and collapses under its own gravity. The collapse creates a point of such extreme density that nothing, not even light, can escape its gravitational pull. In 2019, a global team of astronomers captured the first actual image of a black hole. It required linking radio telescopes across multiple continents to create a lens the size of Earth. The image showed a glowing ring of superheated gas surrounding a dark center. Think about it: Why do you think capturing an image of something invisible required such a massive worldwide effort?"}]},
  dinosaurs:{1:[{words:50,title:"Big Rex",body:"Rex is a big dinosaur. He has sharp teeth and tiny arms. Rex walks on two strong legs. He roars very loud. All the other dinosaurs run away. Rex is the king of the land. At night Rex looks at the stars. He wonders what they are. Rex is big but he can dream small dreams. Think about it: What would you do if you met a T-Rex?"},{words:100,title:"Dino Friends",body:"Tara the triceratops had three horns on her head. Bron the brontosaurus had a very long neck. They were best friends even though they looked very different. Every day they ate plants by the river. Tara used her horns to break tough branches. Bron used her long neck to reach the tallest leaves. They always shared their food. One afternoon a loud roar shook the ground. A big meat eater was coming their way. Tara lowered her horns and stomped her feet. The big dinosaur ran away. Think about it: How did Tara and Bron help each other?"}],2:[{words:100,title:"The Last Egg",body:"Deep in a muddy nest, one egg remained long after the others had hatched. The mother had stopped coming back. The sun warmed the egg each day until finally a crack appeared. A small raptor pushed its way out into a noisy world. Everything was enormous and strange. The little raptor was alone but not afraid. It had hatched with sharp instincts. By nightfall it had found water and shelter under a fallen tree. Scientists who study dinosaur fossils believe many young dinosaurs hatched this way, surviving on instinct from their very first breath. Think about it: What instincts do you think humans are born with?"}],3:[{words:150,title:"The Day the Sky Went Dark",body:"Sixty-six million years ago, a rock from space about six miles wide slammed into what is now Mexico. The impact released more energy than every nuclear weapon on Earth combined. The explosion sent billions of tons of dust and ash into the atmosphere. Within weeks the sky went dark across the entire planet. Without sunlight, temperatures plummeted and plants began to die. About three quarters of all species on Earth went extinct. But small mammals survived in burrows underground. From those survivors, all the mammals alive today eventually evolved. The extinction was an ending, but it was also a beginning. Think about it: How does this story change the way you think about disasters?"}]},
  ocean:{1:[{words:50,title:"Under the Sea",body:"The ocean is very deep and blue. Many fish live there. Some fish are big. Some fish are tiny. Coral looks like a rainbow under the water. Sea turtles swim slowly past. A dolphin jumps high into the air. The ocean is full of life. We must keep it clean. Think about it: What ocean animal would you like to swim with?"}],2:[{words:100,title:"The Deep Dark Zone",body:"Most of the ocean is completely dark. Sunlight only reaches the top few hundred feet of water. Below that is absolute darkness for miles. Scientists used to think nothing could live there. They were very wrong. Strange glowing creatures drift through the deep ocean. The anglerfish has a built-in light on its head to lure prey. Tube worms grow near volcanic vents on the ocean floor, surviving without any sunlight at all. We have explored less than twenty percent of the deep ocean. Think about it: Why do you think we know so little about the deep ocean?"}],3:[{words:150,title:"Coral Reefs in Danger",body:"Coral reefs cover less than one percent of the ocean floor, yet they support about twenty-five percent of all marine species. They are among the most biodiverse ecosystems on Earth. But coral reefs around the world are in serious trouble. Rising ocean temperatures cause bleaching, where corals expel the algae that give them color and nutrition. Without those algae, corals turn white and can die within weeks. Some researchers are now experimenting with growing heat-resistant coral in labs and replanting them on damaged reefs. Once a reef ecosystem collapses, recovery takes decades if it happens at all. Think about it: What do you think individuals can do to help protect coral reefs, even from far away?"}]},
  superheroes:{1:[{words:50,title:"Zoom the Superhero",body:"Zoom can fly very fast. He wears a blue cape. When someone needs help Zoom zooms to the rescue. He helps cats stuck in trees. He helps people cross the street. Zoom is kind to everyone. He says being a hero means helping others. You do not need powers to be a hero. Think about it: How can you be a hero today?"},{words:100,title:"Maya Saves the Day",body:"Maya had a special power. She could talk to animals. One afternoon a little dog got lost in the park. It was whimpering under a bush. Maya crouched down and spoke softly. The dog told her he had followed a butterfly and got confused. Maya asked a sparrow to fly ahead and find the dog's house. Then she followed the sparrow with the dog trotting beside her. Three blocks away a girl was crying on her porch. The dog barked and ran to her. Maya smiled all the way home. Think about it: If you could talk to any animal what would you ask it?"}],2:[{words:100,title:"The Hero Without Powers",body:"Everyone at River City Elementary knew about the superhero league. Marcus could not fly or bend steel or move at super speed. But Marcus noticed things others missed. He noticed when someone was sitting alone at lunch. He noticed when the new kid looked confused in the hallway. He noticed when the quiet girl in math class got the right answer but was too shy to raise her hand. Marcus told her she was right. She started raising her hand after that. By the end of the year Marcus had the most friends of anyone. Think about it: What superpower does Marcus actually have?"}],3:[{words:150,title:"The Weight of the Mask",body:"Priya had been able to generate force fields since she was nine years old. She had trained for years and genuinely wanted to help people. But nobody warned her about the interviews. After her first public rescue, reporters crowded around asking questions. Priya had only thought about the people trapped on the bridge. That night she realized that being a hero in public was completely different from the private moment of helping someone. One felt like herself. The other felt like a performance. She decided she would keep her mask on, not to hide, but to protect the quiet version of herself that actually cared. Think about it: Why might it be important to protect your private self even when you do something publicly?"}]},
  magic:{1:[{words:50,title:"The Magic Door",body:"There was a little door in the back of the garden. No one had opened it in years. One day Lily found the key. She turned it slowly. The door opened to a land of flying horses and talking trees. A tiny dragon sat on a mushroom. It smiled at her. Lily smiled back. She knew she had found something wonderful. Think about it: What would be behind your magic door?"},{words:100,title:"Pip the Small Wizard",body:"Pip wanted to be a wizard more than anything. But his spells never worked right. His fire spell made snow. His flying spell made worms float. The other students laughed but Pip kept trying. One day a storm trapped everyone in the castle. All the big wizards tried to clear it but could not. Pip raised his wand and thought of warmth. Out came a giant rainbow that reached across the sky. The clouds parted and sunshine poured in. Sometimes the wrong spell is exactly the right one. Think about it: Why might making mistakes be part of learning?"}],2:[{words:100,title:"The Girl Who Collected Wishes",body:"Every time someone in the village made a wish and forgot about it, the wish floated away as a tiny glowing seed. Most people never noticed. But Rosa could see them. She had been collecting wishes in a glass jar since she was small. One winter the river froze and the village ran out of food. Rosa opened her jar and let all the wishes go at once. They rose in a swirling cloud of light. By morning the snow had melted from the southern fields and early vegetables had pushed through the soil. Think about it: What wish would you put in Rosa's jar?"}],3:[{words:150,title:"The Last Cartographer",body:"In a kingdom where magic had faded, one old woman still made maps that worked. Not road maps, but maps of people. She could trace the invisible lines that connected a person to their fears, their hopes, and the places that had shaped them. She only drew maps for those who truly wanted to understand themselves. Her last visitor was a young girl who had lost her voice in an accident and could no longer tell her own story. The cartographer spent three days mapping her. When she unrolled the finished parchment, the girl stared at it for a long time. Then she picked up a pen and began to write. Think about it: What would your personal map show about who you are?"}]},
  sports:{1:[{words:50,title:"The Big Game",body:"Today is the big soccer game. Mia is nervous. Her legs feel like jelly. Coach says just do your best. In the second half Mia gets the ball. She runs fast. She kicks hard. Goal! Her team cheers. Mia laughs. Nerves are gone now. She just loves to play. Think about it: How do you feel before something important?"},{words:100,title:"Learning to Swim",body:"Jordan did not like putting his face in the water. Every swim lesson he stood at the edge of the pool and watched the other kids. His teacher Miss Rosa never pushed him. She just showed him again and again. One day Jordan held his nose and went under for one second. Then two. Then five. By the end of summer he could swim across the whole pool. He looked at the pool that had scared him so much. It looked smaller now. Not because it had changed but because he had. Think about it: What is something that felt scary until you tried it?"}],2:[{words:100,title:"The Fastest Kid",body:"Everyone said Leo was the fastest kid at Riverside Elementary. He had never lost a race. On field day he lined up for the fifty meter sprint with total confidence. But when he crossed the line he heard cheering that was not for him. A new girl named Amara had crossed a full second ahead. Leo walked over and held out his hand. That was fast, he said. She grinned. Want to train together? Leo said yes immediately. Think about it: How did losing change Leo's life for the better?"}],3:[{words:150,title:"The Mental Game",body:"Elite athletes often say that ninety percent of their sport is mental. Physical talent reaches a ceiling. At the highest levels of competition, almost everyone is physically capable. The athletes who win consistently manage pressure better and recover from mistakes faster. Visualization is one of the most powerful tools athletes use. Before a competition, many close their eyes and mentally rehearse every moment. Research shows this actually activates the same neural pathways as physically practicing the skill. Basketball players who only visualized free throws for a month improved almost as much as those who physically practiced every day. Think about it: How could you use visualization in your own life outside of sports?"}]},
  cooking:{1:[{words:50,title:"Making Pancakes",body:"Sam helps mom make pancakes. First they mix the batter. It is lumpy and white. Then mom pours it on the hot pan. It sizzles and bubbles. When the bubbles pop it is time to flip. Sam wants to try. He flips it perfectly. The pancake is round and golden. They put butter and syrup on top. It is the best breakfast ever. Think about it: What is your favorite food to make?"},{words:100,title:"Grandma's Secret Recipe",body:"Every Sunday Grandma made her special tomato soup. The whole house smelled amazing. One day she let Nora help. First they cut the tomatoes into small pieces. Then they cooked onions in butter until they were soft and golden. They added the tomatoes and a cup of broth and let it simmer slowly. When the soup was done she let Nora taste it. It was the most delicious thing Nora had ever eaten. Grandma smiled. Now you know the secret, she said. The secret is time and love. Think about it: What recipe would you want to pass down someday?"}],2:[{words:100,title:"The Science of Bread",body:"Baking bread seems like cooking but it is really more like science. When you mix flour, water, and yeast together, something invisible begins to happen. Yeast is a tiny living organism. It eats the sugars in the flour and releases carbon dioxide gas. That gas gets trapped in the sticky dough, forming thousands of tiny bubbles. As the dough sits in a warm place, the yeast keeps eating and the bubbles multiply. The dough rises and nearly doubles in size. When you put it in the hot oven, the heat kills the yeast and bakes the bubbles into the bread's soft spongy structure. Think about it: What other foods do you think involve living organisms?"}],3:[{words:150,title:"Food as Culture",body:"Every culture on Earth has developed its own cuisine, and those foods carry more history than most people realize. Spices that seem ordinary today were once so rare and valuable they launched wars and funded empires. Chili peppers originated in the Americas and only reached Asia and Europe after 1492, yet today they are central to the cuisines of India, Thailand, and China. Tomatoes, also native to the Americas, became the foundation of Italian cooking within two hundred years of arriving in Europe. Food travels with people and adapts to new environments. When you eat a dish from another culture, you are tasting centuries of human movement, trade, and creativity. Think about it: What does your favorite food tell you about where it came from?"}]},
  friendship:{1:[{words:50,title:"My Best Friend",body:"My best friend is named Jay. We like the same things. We both love dogs and pizza. Jay makes me laugh every day. When I am sad Jay sits with me. When Jay is scared I hold his hand. That is what friends do. Friends make every day better. I am glad Jay is my friend. Think about it: What makes someone a good friend?"},{words:100,title:"The New Kid",body:"On Monday a new girl came to class. Her name was Zoe. She sat alone at lunch with her tray and looked at the table. Everyone else was already talking with their friends. Kira noticed. She picked up her lunch and walked over. Can I sit here? she asked. Zoe looked up surprised. Yes please, she said quietly. They talked the whole lunch. Zoe was funny and liked the same books as Kira. By Friday they were walking to school together every morning. Think about it: Have you ever been the new kid or sat with someone who was?"}],2:[{words:100,title:"The Argument",body:"Diego and Sam had been best friends since kindergarten. But in fourth grade they had their first real fight. It started over something small and grew into something bigger until they stopped talking completely. For two weeks they sat on opposite sides of the classroom. One afternoon it rained and they both took shelter in the same doorway. They stood there awkwardly. Then Diego laughed a little. Sam laughed too. By the time the rain stopped they had been talking for twenty minutes. Some friendships are strong enough to survive the silences. Think about it: What do you think made it easier for them to make up?"}],3:[{words:150,title:"The Loyalty Question",body:"There is an old idea that loyalty means always defending your friend no matter what. But some of the most important thinkers in history have argued the opposite. True loyalty means telling your friend the truth even when it is uncomfortable. It means caring more about who they become than about keeping things easy between you. The friendships that last decades are rarely the ones built on constant agreement. They are built on trust that runs deep enough to survive honest conversations. People who have friends willing to challenge them tend to make better decisions over time. There is a difference between a friend who makes you feel good and a friend who helps you be good. Think about it: Can you think of a time when a friend told you something hard to hear that turned out to be important?"}]}
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function getStory(cat, grade, wordTarget) {
  const pool = STORIES[cat]?.[grade] || STORIES[cat]?.['2'] || STORIES['animals']['1'];
  let best = pool[0];
  pool.forEach(s => { if (Math.abs(s.words - wordTarget) < Math.abs(best.words - wordTarget)) best = s; });
  return best;
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  grade: "1", wordTarget: 100, category: "animals",
  story: "", storyTitle: "",
  wordEls: [], recordStart: null,
  isRace: false, myRole: null,
  roomCode: null, roomRef: null, unsubscribers: [],
  voiceGender: "female",
  speed: 1.0,
  isAIStory: false,
};

function cleanupRoom() {
  S.unsubscribers.forEach(fn => { try { fn(); } catch(e) {} });
  S.unsubscribers = []; S.roomRef = null; S.roomCode = null; S.myRole = null; S.isRace = false;
}

// ‚îÄ‚îÄ Voice selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.voice-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.voice-btn').forEach(b => b.classList.remove('sel-voice'));
  btn.classList.add('sel-voice');
  S.voiceGender = btn.dataset.voice;
  if (ttsState === 'playing' || ttsState === 'paused') stopTTS();
  ttsAudioCache.clear();
}));

// ‚îÄ‚îÄ Speed slider ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const speedSlider = document.getElementById('speed-slider');
const speedDisplay = document.getElementById('speed-display');
speedSlider.addEventListener('input', () => {
  S.speed = parseFloat(speedSlider.value);
  speedDisplay.textContent = S.speed.toFixed(1) + '√ó';
  if (ttsState === 'playing' && ttsAudio) {
    ttsAudio.playbackRate = S.speed;
  }
});

// ‚îÄ‚îÄ Google Cloud TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ttsAudio = null;
let ttsWordTimings = [];
let ttsRafId = null;
let ttsState = 'idle';
let ttsPausedAtMs = 0;
let ttsAudioCache = new Map();

const VOICE_NAMES = {
  female: { 1: "en-US-Neural2-F", 2: "en-US-Neural2-F", 3: "en-US-Neural2-C" },
  male:   { 1: "en-US-Neural2-D", 2: "en-US-Neural2-D", 3: "en-US-Neural2-A" },
};

function stopRAF() {
  if (ttsRafId) { cancelAnimationFrame(ttsRafId); ttsRafId = null; }
}

function resetTTSButtons() {
  document.getElementById('btn-play').textContent = '‚ñ∂ Play';
  document.getElementById('btn-play').disabled = false;
  document.getElementById('btn-pause').disabled = true;
  document.getElementById('btn-pause').textContent = '‚è∏ Pause';
  document.getElementById('btn-stop-tts').disabled = false;
  ttsState = 'idle';
}

function startHighlightLoop() {
  stopRAF();
  let lastActiveIdx = -1;
  function loop() {
    if (!ttsAudio || ttsState !== 'playing') return;
    const nowMs = ttsAudio.currentTime * 1000;
    let activeIdx = -1;
    for (let i = 0; i < ttsWordTimings.length; i++) {
      if (ttsWordTimings[i].startMs <= nowMs) activeIdx = i;
      else break;
    }
    if (activeIdx >= 0 && activeIdx !== lastActiveIdx) {
      lastActiveIdx = activeIdx;
      S.wordEls.forEach(w => w.classList.remove('highlight'));
      if (S.wordEls[activeIdx]) {
        S.wordEls[activeIdx].classList.add('highlight');
        S.wordEls[activeIdx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
      const pct = Math.round((activeIdx + 1) / S.wordEls.length * 100);
      document.getElementById('progress-bar').style.width = pct + '%';
      if (S.isRace) {
        document.getElementById('my-progress-bar').style.width = pct + '%';
        document.getElementById('my-pct').textContent = pct + '%';
      }
    }
    ttsRafId = requestAnimationFrame(loop);
  }
  ttsRafId = requestAnimationFrame(loop);
}

function stopTTS() {
  stopRAF();
  if (ttsAudio) { ttsAudio.pause(); ttsAudio.src = ''; ttsAudio = null; }
  S.wordEls.forEach(w => w.classList.remove('highlight'));
  resetTTSButtons();
  ttsPausedAtMs = 0;
}

async function fetchTTSAudio(text, grade, voiceGender) {
  const voiceName = VOICE_NAMES[voiceGender]?.[parseInt(grade)] || "en-US-Neural2-F";
  const cacheKey = `${voiceName}:${text.substring(0, 80)}`;
  if (ttsAudioCache.has(cacheKey)) return ttsAudioCache.get(cacheKey);
  const response = await fetch(CF_TTS, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, grade: parseInt(grade) || 2, voiceName })
  });
  if (!response.ok) throw new Error('TTS failed: ' + response.status);
  const data = await response.json();
  if (!data.audioBase64) throw new Error('No audio returned');
  ttsAudioCache.set(cacheKey, data);
  if (ttsAudioCache.size > 10) ttsAudioCache.delete(ttsAudioCache.keys().next().value);
  return data;
}

async function playSpeech(startFromMs) {
  if (!S.story) return;
  ttsState = 'loading';
  document.getElementById('btn-play').textContent = '‚è≥ Loading...';
  document.getElementById('btn-play').disabled = true;
  document.getElementById('btn-pause').disabled = true;
  try {
    const data = await fetchTTSAudio(S.story, S.grade, S.voiceGender);
    ttsWordTimings = data.wordTimings || [];
    const audio = new Audio('data:audio/mp3;base64,' + data.audioBase64);
    audio.playbackRate = S.speed;
    ttsAudio = audio;
    audio.addEventListener('canplaythrough', () => {
      if (startFromMs > 0) audio.currentTime = startFromMs / 1000;
      audio.play();
      ttsState = 'playing';
      document.getElementById('btn-play').textContent = '‚ñ∂ Playing...';
      document.getElementById('btn-play').disabled = true;
      document.getElementById('btn-pause').disabled = false;
      document.getElementById('btn-stop-tts').disabled = false;
      startHighlightLoop();
    }, { once: true });
    audio.addEventListener('ended', () => {
      stopRAF();
      S.wordEls.forEach(w => w.classList.remove('highlight'));
      document.getElementById('progress-bar').style.width = '100%';
      resetTTSButtons();
      ttsPausedAtMs = 0;
    });
    audio.addEventListener('error', () => { stopRAF(); resetTTSButtons(); });
  } catch (err) {
    console.error('TTS error:', err);
    resetTTSButtons();
    alert('Could not load audio. Please check your internet connection and try again.');
  }
}

document.getElementById('btn-play').addEventListener('click', () => {
  if (ttsState === 'idle') {
    S.wordEls.forEach(w => { w.className = 'word'; });
    document.getElementById('progress-bar').style.width = '0%';
    ttsPausedAtMs = 0;
    playSpeech(0);
  } else if (ttsState === 'paused') {
    playSpeech(ttsPausedAtMs);
  }
});

document.getElementById('btn-pause').addEventListener('click', () => {
  if (ttsState === 'playing' && ttsAudio) {
    ttsPausedAtMs = ttsAudio.currentTime * 1000;
    ttsAudio.pause();
    stopRAF();
    ttsState = 'paused';
    document.getElementById('btn-pause').textContent = '‚ñ∂ Resume';
    document.getElementById('btn-play').disabled = false;
    document.getElementById('btn-play').textContent = '‚ñ∂ Resume';
  } else if (ttsState === 'paused') {
    playSpeech(ttsPausedAtMs);
  }
});

document.getElementById('btn-stop-tts').addEventListener('click', stopTTS);

// ‚îÄ‚îÄ Pickers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('#grade-row .opt-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('#grade-row .opt-btn').forEach(b => b.classList.remove('sel-grade'));
  btn.classList.add('sel-grade'); S.grade = btn.dataset.grade;
}));
document.querySelectorAll('#words-row .opt-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('#words-row .opt-btn').forEach(b => b.classList.remove('sel-words'));
  btn.classList.add('sel-words'); S.wordTarget = parseInt(btn.dataset.words);
}));
document.querySelectorAll('.cat-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected'); S.category = btn.dataset.cat;
}));

// ‚îÄ‚îÄ Solo / Race entry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-generate').addEventListener('click', () => { S.isRace = false; S.myRole = null; loadStory(); });
document.getElementById('btn-race-start').onclick = () => {
  const choice = confirm("Are you creating a room?\n\nOK = CREATE a room\nCancel = JOIN a friend's room");
  if (choice) { S.isRace = true; S.myRole = 'host'; loadStory(); }
  else { show('screen-join'); }
};
document.getElementById('btn-back-join').addEventListener('click', () => show('screen-pick'));

document.getElementById('btn-join-room').addEventListener('click', async () => {
  const code = document.getElementById('join-code-input').value.trim();
  const err = document.getElementById('join-error');
  err.style.display = 'none';
  if (code.length !== 4) { err.textContent = "Please enter a 4-digit code."; err.style.display = 'block'; return; }
  const snap = await get(ref(db, `rooms/${code}`));
  if (!snap.exists()) { err.textContent = "Room not found. Check the code!"; err.style.display = 'block'; return; }
  const room = snap.val();
  S.roomCode = code; S.roomRef = ref(db, `rooms/${code}`);
  S.story = room.story; S.storyTitle = room.title; S.grade = room.grade; S.wordTarget = room.wordTarget;
  S.myRole = 'guest'; S.isRace = true;
  await update(S.roomRef, { guestJoined: true });
  show('screen-waiting-guest');
  const unsub = onValue(ref(db, `rooms/${code}/status`), snap => {
    if (snap.val() === 'countdown') { unsub(); startCountdown(); }
  });
  S.unsubscribers.push(unsub);
});

// ‚îÄ‚îÄ Load story ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStory() {
  show('screen-loading');
  const loadingMsg = document.getElementById('loading-msg');
  try {
    loadingMsg.textContent = '‚ú® Writing your story with AI...';
    const aiText = await generateAIStory(S.grade, S.category, S.wordTarget);
    S.storyTitle = `‚ú® ${S.category.charAt(0).toUpperCase() + S.category.slice(1)} Story`;
    S.story = aiText;
    S.isAIStory = true;
  } catch (err) {
    console.warn('AI generation failed, using fallback:', err);
    loadingMsg.textContent = 'Getting your story ready...';
    const s = getStory(S.category, S.grade, S.wordTarget);
    S.storyTitle = s.title; S.story = s.body; S.isAIStory = false;
  }
  if (S.myRole === 'host') createRoom();
  else { setupReadScreen(); show('screen-read'); }
}

async function createRoom() {
  const code = String(Math.floor(1000 + Math.random() * 9000));
  S.roomCode = code; S.roomRef = ref(db, `rooms/${code}`);
  await set(S.roomRef, { story: S.story, title: S.storyTitle, grade: S.grade, wordTarget: S.wordTarget, status: 'waiting', host: { progress: 0, wpm: 0, done: false }, guest: { progress: 0, wpm: 0, done: false }, createdAt: Date.now() });
  document.getElementById('display-room-code').textContent = code;
  show('screen-waiting-host');
  const unsub = onValue(S.roomRef, snap => {
    const room = snap.val(); if (!room) return;
    if (room.guestJoined) {
      document.getElementById('slot-guest').classList.add('joined');
      document.getElementById('slot-guest').querySelector('.slot-name').textContent = 'Friend';
      document.getElementById('slot-guest').querySelector('.slot-status').textContent = '‚úì Joined!';
      unsub(); setTimeout(() => startCountdown(), 1000);
    }
  });
  S.unsubscribers.push(unsub);
  setTimeout(() => { try { remove(S.roomRef); } catch(e) {} }, 600000);
}

async function startCountdown() {
  if (S.myRole === 'host') await update(S.roomRef, { status: 'countdown' });
  show('screen-countdown');
  const el = document.getElementById('countdown-display');
  const steps = ['3','2','1','GO!']; let i = 0;
  const tick = () => {
    el.textContent = steps[i];
    el.className = steps[i] === 'GO!' ? 'countdown-go' : 'countdown-number';
    el.style.animation = 'none'; el.offsetHeight; el.style.animation = '';
    i++;
    if (i < steps.length) setTimeout(tick, 900);
    else setTimeout(() => { setupReadScreen(); show('screen-read'); setTimeout(() => document.getElementById('btn-record').click(), 300); }, 400);
  };
  tick();
}

function setupReadScreen() {
  renderStory(S.storyTitle, S.story);
  document.getElementById('vs-progress').style.display = S.isRace ? 'block' : 'none';
  document.getElementById('solo-progress-wrap').style.display = S.isRace ? 'none' : 'block';
  if (S.isRace) {
    document.getElementById('my-progress-bar').style.width = '0%';
    document.getElementById('their-progress-bar').style.width = '0%';
    document.getElementById('my-pct').textContent = '0%';
    document.getElementById('their-pct').textContent = '0%';
    const oppRole = S.myRole === 'host' ? 'guest' : 'host';
    const unsub = onValue(ref(db, `rooms/${S.roomCode}/${oppRole}`), snap => {
      const d = snap.val(); if (!d) return;
      const pct = Math.round(d.progress || 0);
      document.getElementById('their-progress-bar').style.width = pct + '%';
      document.getElementById('their-pct').textContent = pct + '%';
      if (d.done && d.wpm != null) receiveTheirResult(d.wpm);
    });
    S.unsubscribers.push(unsub);
  }
}

// ‚îÄ‚îÄ attachRecordListener: safely wires up btn-record ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function attachRecordListener() {
  const oldBtn = document.getElementById('btn-record');
  const newBtn = oldBtn.cloneNode(true);
  oldBtn.parentNode.replaceChild(newBtn, oldBtn);
  newBtn.addEventListener('click', startReading);
}

function renderStory(title, body) {
  const titleEl = document.getElementById('story-title');
  titleEl.innerHTML = S.isAIStory ? title + ' <span class="ai-badge">‚ú® AI</span>' : '';
  if (!S.isAIStory) titleEl.textContent = title;
  const container = document.getElementById('story-text');
  container.innerHTML = ''; S.wordEls = [];
  // Strip markdown headers, titles, bold labels from AI output
  const cleanBody = body
    .replace(/#+\s*/g, '')
    .replace(/\*\*(.*?)\*\*/g, '$1')
    .replace(/^(reading passage|passage|story title|title):?\s*/im, '')
    .trim();

  // Split into paragraphs first, then words within each paragraph
  const paragraphs = cleanBody.split(/\n\s*\n/);
  paragraphs.forEach((para, pIdx) => {
    para.trim().split(/(\s+)/).forEach(chunk => {
      if (/\S/.test(chunk)) {
        const span = document.createElement('span');
        span.className = 'word'; span.textContent = chunk;
        span.addEventListener('dblclick', () => {
          const idx = S.wordEls.indexOf(span);
          if (idx >= 0 && idx === currentWordIdx && recActive) {
            clearTimeout(stuckTimer);
            stuckTimer = null;
            teacherSayWord(idx);
          }
        });
        container.appendChild(span); S.wordEls.push(span);
      } else { container.appendChild(document.createTextNode(chunk)); }
    });
    // Add paragraph break between paragraphs
    if (pIdx < paragraphs.length - 1) {
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
    }
  });
  document.getElementById('progress-bar').style.width = '0%';
  document.getElementById('listening-badge').classList.remove('active');
  document.getElementById('processing-badge').classList.remove('active');
  S.wordEls.forEach(w => { w.style.color = ''; w.style.background = ''; });
  // Stop TTS cleanly WITHOUT marking words green
  stopRAF();
  if (ttsAudio) { ttsAudio.pause(); ttsAudio.src = ''; ttsAudio = null; }
  resetTTSButtons();
  ttsWordTimings = []; ttsPausedAtMs = 0;
  // Wire up the mic button fresh every time
  attachRecordListener();
}

// ‚îÄ‚îÄ Live reading state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mediaRecorder = null;
let audioChunks = [];
let recActive = false;
let myFinalWpm = null;
let theirFinalWpm = null;
let currentWordIdx = 0;
let missedWords = [];
let stuckTimer = null;
let liveRecognition = null;

function highlightCurrentWord() {
  S.wordEls.forEach((w, i) => {
    w.classList.remove('highlight');
    if (i < currentWordIdx) {
      w.classList.add('done');
      if (!missedWords.find(m => m.index === i)) {
        w.style.background = '';
        w.style.color = '';
      }
    }
  });
  if (S.wordEls[currentWordIdx]) {
    S.wordEls[currentWordIdx].classList.add('highlight');
    S.wordEls[currentWordIdx].style.background = '';
    S.wordEls[currentWordIdx].style.color = '';
    S.wordEls[currentWordIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  const pct = Math.min(100, Math.round(currentWordIdx / S.wordEls.length * 100));
  document.getElementById('progress-bar').style.width = pct + '%';
  if (S.isRace) {
    document.getElementById('my-progress-bar').style.width = pct + '%';
    document.getElementById('my-pct').textContent = pct + '%';
    if (S.roomCode && S.myRole) {
      update(ref(db, `rooms/${S.roomCode}/${S.myRole}`), { progress: pct });
    }
  }
}

function normalizeWord(w) {
  return w.toLowerCase().replace(/[^a-z']/g, '');
}

function levenshteinDistance(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({ length: m + 1 }, (_, i) =>
    Array.from({ length: n + 1 }, (_, j) => i === 0 ? j : j === 0 ? i : 0)
  );
  for (let i = 1; i <= m; i++)
    for (let j = 1; j <= n; j++)
      dp[i][j] = a[i-1] === b[j-1] ? dp[i-1][j-1] :
        1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
  return dp[m][n];
}

function markWordStuck() {
  if (stuckTimer) return;
  if (S.wordEls[currentWordIdx]) {
    S.wordEls[currentWordIdx].classList.remove('highlight');
    S.wordEls[currentWordIdx].style.background = '#FF6B6B';
    S.wordEls[currentWordIdx].style.color = '#ffffff';
  }
  missedWords.push({ index: currentWordIdx, word: S.wordEls[currentWordIdx]?.textContent || '' });
  stuckTimer = setTimeout(() => teacherSayWord(currentWordIdx), 5000);
}

function teacherSayWord(idx) {
  const word = normalizeWord(S.wordEls[idx]?.textContent || '');
  if (S.wordEls[idx]) {
    S.wordEls.forEach(w => w.classList.remove('highlight'));
    S.wordEls[idx].classList.add('highlight');
    S.wordEls[idx].style.background = '#A259FF';
    S.wordEls[idx].style.color = '#ffffff';
    S.wordEls[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  const utt = new SpeechSynthesisUtterance(word);
  utt.rate = 0.8; utt.pitch = 1.1;
  utt.onend = () => {
    if (S.wordEls[idx]) {
      S.wordEls[idx].classList.remove('highlight');
      S.wordEls[idx].style.background = '';
      S.wordEls[idx].style.color = '';
    }
    advanceWord();
  };
  window.speechSynthesis.speak(utt);
}

function advanceWord() {
  clearTimeout(stuckTimer);
  stuckTimer = null;
  currentWordIdx++;
  if (currentWordIdx >= S.wordEls.length) finishReading();
  else highlightCurrentWord();
}

async function startReading() {
  if (recActive) return;
  stopTTS();
  S.wordEls.forEach(w => { w.className = 'word'; w.style.color = ''; w.style.background = ''; });
  document.getElementById('progress-bar').style.width = '0%';
  if (document.getElementById('my-progress-bar')) document.getElementById('my-progress-bar').style.width = '0%';
  if (document.getElementById('my-pct')) document.getElementById('my-pct').textContent = '0%';
  currentWordIdx = 0;
  missedWords = [];
  stuckTimer = null;
  highlightCurrentWord();

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert('Live reading requires Chrome. Please open this app in Chrome.');
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true, sampleRate: 48000, channelCount: 1 }
    });
    const mimeType = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4']
      .find(t => MediaRecorder.isTypeSupported(t)) || 'audio/webm';
    mediaRecorder = new MediaRecorder(stream, { mimeType });
    audioChunks = [];
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.onstop = () => { stream.getTracks().forEach(t => t.stop()); };
    mediaRecorder.start(250);
    S.recordStart = Date.now();
    recActive = true;

    liveRecognition = new SpeechRecognition();
    liveRecognition.continuous = true;
    liveRecognition.interimResults = true;
    liveRecognition.lang = 'en-US';

    liveRecognition.onresult = (e) => {
      // Only look at the most recent result
      const result = e.results[e.results.length - 1];
      const transcript = result[0].transcript.trim();
      const spokenWords = transcript.toLowerCase().split(/\s+/).filter(Boolean);

      // Check each newly spoken word against the current expected word
      for (const spoken of spokenWords) {
        const normalized = normalizeWord(spoken);
        const expected = normalizeWord(S.wordEls[currentWordIdx]?.textContent || '');
        if (!expected) break;
        const isMatch = normalized === expected || levenshteinDistance(normalized, expected) <= 1;
        if (isMatch) {
          clearTimeout(stuckTimer);
          stuckTimer = null;
          advanceWord();
        }
      }
    };

    liveRecognition.onerror = () => {};
    liveRecognition.onend = () => {
      if (recActive) try { liveRecognition.start(); } catch(e) {}
    };
    liveRecognition.start();

    document.getElementById('listening-badge').classList.add('active');
    const recordBtn = document.getElementById('btn-record');
    recordBtn.textContent = '‚èπ Done Reading';
    recordBtn.onclick = stopReading;
    const timeLimit = Math.max(60, S.wordTarget * 1.5) * 1000;
    setTimeout(() => { if (recActive) stopReading(); }, timeLimit);

  } catch (err) {
    alert('Microphone not available. Please allow microphone access and try again.');
    recActive = false;
  }
}

function stopReading() {
  if (!recActive) return;
  recActive = false;
  clearTimeout(stuckTimer);
  stuckTimer = null;
  try { liveRecognition?.stop(); } catch(e) {}
  document.getElementById('listening-badge').classList.remove('active');
  attachRecordListener();
  if (mediaRecorder?.state !== 'inactive') mediaRecorder?.stop();
  finishReading();
}

function finishReading() {
  const durationMs = Date.now() - S.recordStart;
  const wordsRead = currentWordIdx;
  const minutesElapsed = durationMs / 60000;
  const wpm = minutesElapsed > 0.05 ? Math.round(wordsRead / minutesElapsed) : 0;

  S.wordEls.forEach((w, i) => {
    if (i < currentWordIdx && !missedWords.find(m => m.index === i)) {
      w.classList.add('done');
      w.style.background = '';
    }
  });
  missedWords.forEach(({ index }) => {
    if (S.wordEls[index]) {
      S.wordEls[index].classList.remove('done');
      S.wordEls[index].style.background = '#FF6B6B';
      S.wordEls[index].style.color = '#ffffff';
    }
  });

  document.getElementById('progress-bar').style.width =
    Math.round(wordsRead / S.wordEls.length * 100) + '%';

  if (S.isRace) {
    update(ref(db, `rooms/${S.roomCode}/${S.myRole}`), { progress: 100, wpm, done: true });
    myFinalWpm = wpm;
    tryShowRaceResults();
  } else {
    showSoloResults(wpm);
  }
}

// ‚îÄ‚îÄ Results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function receiveTheirResult(wpm) { theirFinalWpm = wpm; tryShowRaceResults(); }
function tryShowRaceResults() {
  if (myFinalWpm === null || theirFinalWpm === null) return;
  const me = myFinalWpm, them = theirFinalWpm;
  myFinalWpm = null; theirFinalWpm = null;
  let title, msg, lc, rc;
  if (me > them) { title = 'üèÜ You Win!'; msg = `You read ${me-them} wpm faster! Amazing!`; lc = 'winner'; rc = 'loser'; }
  else if (them > me) { title = 'Good Race! üí™'; msg = `Your friend was ${them-me} wpm faster. Keep practicing!`; lc = 'loser'; rc = 'winner'; }
  else { title = "ü§ù It's a Tie!"; msg = "Same speed! Race again to break it!"; lc = 'tie'; rc = 'tie'; }
  document.getElementById('race-result-title').textContent = title;
  document.getElementById('rp-left-wpm').textContent = me;
  document.getElementById('rp-right-wpm').textContent = them;
  document.getElementById('rp-left').className = `result-player ${lc}`;
  document.getElementById('rp-right').className = `result-player ${rc}`;
  document.getElementById('race-msg').textContent = msg;
  show('screen-race-results');
}

function showSoloResults(wpm) {
  const benchmarks = {"1":60,"2":90,"3":110};
  const gradeNames = {"1":"1st","2":"2nd","3":"3rd"};
  const target = benchmarks[S.grade];
  const ratio = wpm / target;
  let stars, msg;
  if (wpm < 10) { stars = '‚≠ê'; msg = "Good try! Listen again then give it another shot!"; }
  else if (ratio < 0.6) { stars = '‚≠ê‚≠ê'; msg = "Nice job! Every practice makes you faster. Try again!"; }
  else if (ratio < 0.85) { stars = '‚≠ê‚≠ê‚≠ê'; msg = "Great reading! You're building strong skills!"; }
  else if (ratio < 1.1) { stars = 'üåüüåüüåü'; msg = "Amazing! You're right on track for your grade!"; }
  else { stars = 'üèÜüåüüåüüåü'; msg = "WOW ‚Äî you're a reading superstar! Way above grade level!"; }
  document.getElementById('solo-stars').textContent = stars;
  document.getElementById('solo-wpm').textContent = wpm > 0 ? wpm : '?';
  document.getElementById('solo-context').textContent = `${gradeNames[S.grade]} grade goal: ${target} words per minute`;
  document.getElementById('solo-msg').textContent = msg;
  show('screen-solo-results');
}

// ‚îÄ‚îÄ Nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-cancel-host').addEventListener('click', async () => {
  if (S.roomRef) try { await remove(S.roomRef); } catch(e) {}
  cleanupRoom(); show('screen-pick');
});
document.getElementById('btn-new').addEventListener('click', () => {
  stopTTS(); recActive = false; cleanupRoom(); show('screen-pick');
});
document.getElementById('btn-solo-retry').addEventListener('click', () => {
  S.wordEls.forEach(w => { w.className = 'word'; w.style.color = ''; w.style.background = ''; });
  document.getElementById('progress-bar').style.width = '0%';
  recActive = false;
  currentWordIdx = 0;
  missedWords = [];
  stopTTS();
  attachRecordListener();
  show('screen-read');
});
document.getElementById('btn-solo-new').addEventListener('click', () => {
  stopTTS(); recActive = false; show('screen-pick');
});
document.getElementById('btn-race-retry').addEventListener('click', () => {
  myFinalWpm = null; theirFinalWpm = null;
  setupReadScreen(); show('screen-read');
  setTimeout(() => document.getElementById('btn-record').click(), 300);
});
document.getElementById('btn-race-new').addEventListener('click', async () => {
  stopTTS(); recActive = false;
  if (S.roomRef) try { await remove(S.roomRef); } catch(e) {}
  cleanupRoom(); show('screen-pick');
});
</script>
</body>
</html>