<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ReadUp! — Transforming Youth Inc.</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800;900&family=Oswald:wght@400;500;600;700&family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --purple: #9B30FF;
    --purple-deep: #6B2D8B;
    --purple-dark: #4A1A6B;
    --purple-light: #C9A0DC;
    --purple-soft: #F3EAFC;
    --grey-light: #B0B0B0;
    --grey-mid: #808080;
    --bg: #FDFBFF;
    --card: #FFFFFF;
    --section: #F7F3FB;
    --ink: #2A2035;
    --body: #4A4255;
    --muted: #8E849A;
    --border: #E8E0F0;
    --gold: #FFD93D;
    --green: #6BCB77;
    --coral: #FF6B6B;
    --ocean: #4D96FF;
    --shadow: 0 4px 24px rgba(74,26,107,0.1);
    --r: 18px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Nunito', sans-serif; background: #EFEAF5; min-height: 100vh; overflow-x: hidden; }

/* ── Global Fat Scrollbar for all scrollable areas ── */
.fat-scroll, #spelling-word-list, #spell-picker-list, #wordbank-review-list, #wpm-story-scroll, .word-bank-list, #spell-results-list {
  scrollbar-width: auto;
  scrollbar-color: var(--purple-light) var(--section);
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
.fat-scroll::-webkit-scrollbar, #spelling-word-list::-webkit-scrollbar, #spell-picker-list::-webkit-scrollbar, #wordbank-review-list::-webkit-scrollbar, #wpm-story-scroll::-webkit-scrollbar, .word-bank-list::-webkit-scrollbar, #spell-results-list::-webkit-scrollbar { width: 14px; }
.fat-scroll::-webkit-scrollbar-track, #spelling-word-list::-webkit-scrollbar-track, #spell-picker-list::-webkit-scrollbar-track, #wordbank-review-list::-webkit-scrollbar-track, #wpm-story-scroll::-webkit-scrollbar-track, .word-bank-list::-webkit-scrollbar-track, #spell-results-list::-webkit-scrollbar-track { background: var(--section); border-radius: 10px; margin: 4px 0; }
.fat-scroll::-webkit-scrollbar-thumb, #spelling-word-list::-webkit-scrollbar-thumb, #spell-picker-list::-webkit-scrollbar-thumb, #wordbank-review-list::-webkit-scrollbar-thumb, #wpm-story-scroll::-webkit-scrollbar-thumb, .word-bank-list::-webkit-scrollbar-thumb, #spell-results-list::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--purple), var(--purple-light)); border-radius: 10px; border: 3px solid var(--section); min-height: 40px; }
.fat-scroll::-webkit-scrollbar-thumb:hover, #spelling-word-list::-webkit-scrollbar-thumb:hover, #spell-picker-list::-webkit-scrollbar-thumb:hover, #wordbank-review-list::-webkit-scrollbar-thumb:hover, #wpm-story-scroll::-webkit-scrollbar-thumb:hover, .word-bank-list::-webkit-scrollbar-thumb:hover, #spell-results-list::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, var(--purple-deep), var(--purple)); }
body.bedtime .fat-scroll, body.bedtime #spelling-word-list, body.bedtime #spell-picker-list, body.bedtime #wordbank-review-list, body.bedtime #wpm-story-scroll, body.bedtime .word-bank-list, body.bedtime #spell-results-list { scrollbar-color: #4a4a6a #252540; }
body.bedtime .fat-scroll::-webkit-scrollbar-track, body.bedtime #spelling-word-list::-webkit-scrollbar-track, body.bedtime #spell-picker-list::-webkit-scrollbar-track, body.bedtime #wordbank-review-list::-webkit-scrollbar-track, body.bedtime #wpm-story-scroll::-webkit-scrollbar-track, body.bedtime .word-bank-list::-webkit-scrollbar-track, body.bedtime #spell-results-list::-webkit-scrollbar-track { background: #252540; }
body.bedtime .fat-scroll::-webkit-scrollbar-thumb, body.bedtime #spelling-word-list::-webkit-scrollbar-thumb, body.bedtime #spell-picker-list::-webkit-scrollbar-thumb, body.bedtime #wordbank-review-list::-webkit-scrollbar-thumb, body.bedtime #wpm-story-scroll::-webkit-scrollbar-thumb, body.bedtime .word-bank-list::-webkit-scrollbar-thumb, body.bedtime #spell-results-list::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #6a5a8a, #4a4a6a); border-color: #252540; }

.bg { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; }
.blob { position: absolute; border-radius: 50%; opacity: 0.06; filter: blur(60px); animation: drift 12s ease-in-out infinite alternate; }
.blob1 { width: 400px; height: 400px; background: var(--purple); top: -100px; left: -100px; }
.blob2 { width: 300px; height: 300px; background: var(--gold); top: 60%; right: -80px; animation-delay: -4s; }
.blob3 { width: 350px; height: 350px; background: var(--green); bottom: -80px; left: 30%; animation-delay: -8s; }
@keyframes drift { from { transform: translate(0,0) scale(1); } to { transform: translate(30px,20px) scale(1.08); } }

.app { position: relative; z-index: 1; max-width: 100%; margin: 0 auto; padding: 20px 20px 60px; }

header { text-align: center; padding: 24px 0 16px; }

/* Bar chart logo mark */
.logo-mark { display: flex; align-items: flex-end; justify-content: center; gap: 3px; margin-bottom: 8px; }
.bar { border-radius: 4px; }
.bar1 { width: 10px; height: 20px; background: var(--grey-light); }
.bar2 { width: 10px; height: 34px; background: var(--grey-mid); }
.bar3 { width: 10px; height: 50px; background: linear-gradient(to top, var(--purple-deep), var(--purple)); position: relative; }
.bar3::before { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 9px; height: 9px; background: linear-gradient(to top, var(--purple-deep), var(--purple)); border-radius: 50%; }

.logo { font-family: 'Fredoka', sans-serif; font-size: 2.6rem; font-weight: 700; color: var(--purple-dark); line-height: 1.1; animation: popIn 0.6s cubic-bezier(0.34,1.56,0.64,1) both; }
.logo span { color: var(--purple); }
.tagline { font-family: 'Fredoka', sans-serif; font-size: 1rem; color: var(--purple-deep); font-weight: 600; margin-top: 4px; font-style: italic; }
.nonprofit-badge { display: inline-block; margin-top: 8px; padding: 4px 14px; background: var(--purple-soft); border: 1.5px solid var(--border); border-radius: 20px; font-family: 'Oswald', sans-serif; font-size: 0.55rem; letter-spacing: 2px; text-transform: uppercase; color: var(--purple-deep); font-weight: 500; }
.dedication { display: block; margin-top: 6px; font-size: 0.8rem; font-weight: 800; color: var(--purple); font-style: italic; }
@keyframes popIn { from { opacity:0; transform: scale(0.5); } to { opacity:1; transform: scale(1); } }

.screen { display: none; animation: fadeUp 0.4s ease both; }
.screen.active { display: block; }
@keyframes fadeUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

.card { background: var(--card); border-radius: 24px; box-shadow: var(--shadow); padding: 28px; margin-top: 20px; border: 1px solid var(--border); }
.card-title { font-family: 'Fredoka', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--ink); margin-bottom: 18px; }
.section-label { font-weight: 800; color: var(--muted); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }

.option-row { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
.opt-btn {
  flex: 1; min-width: 48px; padding: 10px 6px;
  border: 2.5px solid var(--border); border-radius: 14px;
  background: var(--card); font-family: 'Nunito'; font-weight: 800;
  font-size: 0.88rem; cursor: pointer; transition: all 0.2s;
  color: var(--body); text-align: center;
}
.opt-btn:hover { border-color: var(--purple-light); background: var(--purple-soft); }
.opt-btn.sel-grade { border-color: var(--green); background: #EFFFF4; color: #1B7A3E; }
.opt-btn.sel-words { border-color: var(--purple); background: var(--purple-soft); color: var(--purple-deep); }

/* Topic buttons with SVG icons */
.categories { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
.cat-btn {
  background: var(--section); border: 2.5px solid transparent;
  border-radius: var(--r); padding: 14px 6px 10px;
  cursor: pointer; transition: all 0.25s;
  text-align: center; font-family: 'Nunito';
  font-weight: 800; font-size: 0.82rem; color: var(--muted);
}
.cat-btn svg { width: 38px; height: 38px; display: block; margin: 0 auto 6px; }
.cat-btn:hover { border-color: var(--purple-light); transform: translateY(-2px); box-shadow: 0 6px 18px rgba(155,48,255,0.15); }
.cat-btn.selected { border-color: var(--purple); background: var(--purple-soft); color: var(--purple-deep); transform: translateY(-2px); box-shadow: 0 6px 18px rgba(155,48,255,0.15); }
/* Keep emoji class for backwards compat but hide it */
.cat-btn .emoji { display: none; }

.btn-main {
  display: block; width: 100%; margin-top: 16px; padding: 16px;
  border-radius: var(--r); border: none;
  background: linear-gradient(135deg, var(--purple), var(--purple-deep));
  color: #ffffff; font-family: 'Fredoka', sans-serif;
  font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
  box-shadow: 0 4px 18px rgba(155,48,255,0.3);
  -webkit-appearance: none;
}
.btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(155,48,255,0.4); }
.btn-main:active { transform: translateY(0); }
.btn-main:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-green { background: linear-gradient(135deg, #6BCB77, #1BA053) !important; box-shadow: 0 4px 18px rgba(107,203,119,0.35) !important; color: #ffffff !important; }
.btn-coral { background: linear-gradient(135deg, #FF6B6B, #FF9A3C) !important; box-shadow: 0 4px 18px rgba(255,107,107,0.35) !important; color: #ffffff !important; }
.btn-purple { background: linear-gradient(135deg, #A259FF, #FF6FD8) !important; box-shadow: 0 4px 18px rgba(162,89,255,0.3) !important; color: #ffffff !important; }
.btn-yellow { background: linear-gradient(135deg, #FFD93D, #FFA500) !important; box-shadow: 0 4px 18px rgba(255,165,0,0.3) !important; color: var(--ink) !important; }
.btn-gray { background: linear-gradient(135deg, #aaa, #888) !important; box-shadow: 0 3px 12px rgba(0,0,0,0.15) !important; color: #ffffff !important; }
.btn-outline {
  background: var(--card) !important; color: var(--purple) !important;
  border: 2.5px solid var(--purple) !important; box-shadow: none !important; font-size: 1rem;
}
.btn-outline:hover { background: var(--purple-soft) !important; transform: translateY(-2px); }

.or-divider { display: flex; align-items: center; gap: 12px; margin: 6px 0 0; }
.or-divider::before, .or-divider::after { content:''; flex:1; height:2px; background: var(--border); border-radius:2px; }
.or-divider span { font-weight: 800; color: #ccc; font-size: 0.85rem; }

#story-text { font-size: 1.4rem; line-height: 2.2rem; color: var(--ink); font-weight: 700; }
.word { display: inline-block; padding: 3px 5px; border-radius: 7px; transition: background 0.05s, transform 0.05s, color 0.05s; cursor: default; }
.word.highlight { background: var(--gold) !important; color: var(--ink) !important; transform: scale(1.15) !important; box-shadow: 0 2px 8px rgba(255,180,0,0.5); }
.word.done { color: var(--green); }

/* ── Voice selector ── */
.voice-row { display: flex; gap: 10px; margin: 14px 0 4px; align-items: center; }
.voice-label { font-weight: 800; color: var(--muted); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1px; flex-shrink: 0; }
.voice-btn {
  flex: 1; padding: 9px 6px; border-radius: 12px;
  border: 2.5px solid var(--border); background: var(--card);
  font-family: 'Nunito'; font-weight: 800; font-size: 0.9rem;
  color: var(--body); cursor: pointer; transition: all 0.2s; text-align: center;
}
.voice-btn:hover { border-color: var(--purple-light); }
.voice-btn.sel-voice { border-color: var(--purple); background: var(--purple-soft); color: var(--purple-deep); }
.spell-voice-btn.sel-voice { border-color: var(--purple) !important; background: var(--purple-soft) !important; color: var(--purple-deep) !important; }

/* ── Speed slider ── */
.speed-slider-row { margin: 16px 0 4px; }
.speed-slider-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.speed-slider-label { font-weight: 800; color: var(--muted); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1px; }
.speed-value-badge { background: var(--purple-soft); border: 2px solid var(--purple); border-radius: 10px; padding: 2px 10px; font-family: 'Fredoka'; font-size: 1rem; color: var(--purple); }
input[type=range].speed-slider {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 10px; border-radius: 10px;
  background: linear-gradient(90deg, var(--purple) 0%, var(--green) 100%);
  outline: none; cursor: pointer;
}
input[type=range].speed-slider::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: 28px; height: 28px; border-radius: 50%;
  background: #ffffff; border: 4px solid var(--purple);
  box-shadow: 0 2px 8px rgba(155,48,255,0.3);
  cursor: pointer; transition: border-color 0.2s;
}
input[type=range].speed-slider::-webkit-slider-thumb:hover { border-color: var(--purple-deep); }
.speed-emoji-row { display: flex; justify-content: space-between; font-size: 0.78rem; font-weight: 800; color: #bbb; margin-top: 4px; padding: 0 2px; }

/* ── TTS controls ── */
.tts-controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 14px; }
.tts-controls .btn-main { margin-top: 0; font-size: 1rem; padding: 14px 8px; }

.listening-badge { display: none; align-items: center; gap: 8px; background: #FFF0F0; border: 2px solid var(--coral); border-radius: 14px; padding: 10px 16px; margin-top: 14px; font-weight: 800; color: var(--coral); }
.listening-badge.active { display: flex; }
.mic-pulse { width: 14px; height: 14px; border-radius: 50%; background: var(--coral); animation: pulse 0.9s ease infinite; }
@keyframes pulse { 0%,100%{transform:scale(1);opacity:1;} 50%{transform:scale(1.4);opacity:0.5;} }

.processing-badge { display: none; align-items: center; gap: 8px; background: var(--purple-soft); border: 2px solid var(--purple); border-radius: 14px; padding: 10px 16px; margin-top: 14px; font-weight: 800; color: var(--purple); }
.processing-badge.active { display: flex; }

.room-code-display { background: linear-gradient(135deg, var(--purple-soft), #EEF5FF); border-radius: 20px; padding: 22px; text-align: center; margin: 14px 0; }
.room-code-number { font-family: 'Fredoka'; font-size: 4rem; color: var(--purple); letter-spacing: 12px; line-height: 1; }
.room-code-label { font-weight: 800; color: var(--muted); font-size: 0.82rem; margin-top: 8px; text-transform: uppercase; letter-spacing: 1px; }

.code-input { width: 100%; padding: 16px; border: 2.5px solid var(--border); border-radius: 16px; font-family: 'Fredoka'; font-size: 2rem; text-align: center; letter-spacing: 8px; color: var(--ink); outline: none; transition: border 0.2s; margin: 14px 0 4px; }
.code-input:focus { border-color: var(--purple); }

.player-slots { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 14px 0; }
.player-slot { border: 2.5px solid var(--border); border-radius: 18px; padding: 18px; text-align: center; transition: all 0.3s; }
.player-slot.joined { border-color: var(--green); background: #EFFFF4; }
.player-slot.me { border-color: var(--purple); background: var(--purple-soft); }
.slot-icon { font-size: 2rem; display: block; margin-bottom: 6px; }
.slot-name { font-family: 'Fredoka'; font-size: 1rem; color: var(--ink); }
.slot-status { font-size: 0.76rem; font-weight: 800; color: var(--muted); margin-top: 4px; }
.player-slot.joined .slot-status, .player-slot.me .slot-status { color: var(--green); }

.waiting-dots span { animation: blink 1.2s ease infinite; display: inline-block; }
.waiting-dots span:nth-child(2) { animation-delay: 0.2s; }
.waiting-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%,100%{opacity:0.2;} 50%{opacity:1;} }

.countdown-wrap { text-align: center; padding: 50px 0; }
.countdown-number { font-family: 'Fredoka'; font-size: 8rem; color: var(--purple); line-height: 1; animation: countPop 0.4s cubic-bezier(0.34,1.56,0.64,1) both; }
.countdown-go { font-family: 'Fredoka'; font-size: 5rem; color: var(--green); animation: countPop 0.4s cubic-bezier(0.34,1.56,0.64,1) both; }
@keyframes countPop { from { opacity:0; transform:scale(0.3); } to { opacity:1; transform:scale(1); } }

.encouragement { background: var(--purple-soft); border-radius: 16px; padding: 14px 18px; font-weight: 700; color: var(--ink); text-align: center; font-size: 1rem; margin-bottom: 16px; }

.progress-wrap { background: var(--border); border-radius: 20px; height: 12px; margin: 14px 0; overflow: hidden; }
.progress-bar { height: 100%; border-radius: 20px; background: linear-gradient(90deg, var(--purple), var(--green)); transition: width 0.15s; width: 0%; }
.vs-progress { margin: 12px 0; }
.vs-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.vs-name { font-weight: 800; font-size: 0.82rem; width: 52px; flex-shrink: 0; }
.vs-bar-wrap { flex: 1; background: var(--border); border-radius: 20px; height: 10px; overflow: hidden; }
.vs-bar { height: 100%; border-radius: 20px; transition: width 0.4s; width: 0%; }
.vs-bar.me-bar { background: linear-gradient(90deg, var(--purple), var(--purple-deep)); }
.vs-bar.them-bar { background: linear-gradient(90deg, var(--coral), #FF9A3C); }
.vs-pct { font-weight: 800; font-size: 0.8rem; width: 36px; text-align: right; color: var(--muted); flex-shrink: 0; }

.spinner { text-align: center; padding: 40px; }
.spin-circle { width: 52px; height: 52px; border-radius: 50%; border: 6px solid var(--border); border-top-color: var(--purple); animation: spin 0.8s linear infinite; margin: 0 auto 14px; }
@keyframes spin { to { transform: rotate(360deg); } }
.spin-label { font-family: 'Fredoka'; font-size: 1.2rem; color: var(--purple); }
.ai-badge { display: inline-block; background: linear-gradient(135deg, var(--purple), var(--purple-deep)); color: white; font-size: 0.65rem; font-weight: 800; letter-spacing: 1px; padding: 3px 10px; border-radius: 20px; text-transform: uppercase; margin-left: 8px; vertical-align: middle; }

.hint-tip { text-align: center; font-size: 0.85rem; color: var(--purple-deep); font-weight: 800; margin: 10px 0; padding: 10px 14px; background: linear-gradient(135deg, #f3e8ff, #e8d5ff); border: 2px solid var(--purple-light); border-radius: 14px; box-shadow: 0 2px 8px rgba(74,26,107,0.1); }

/* ── Bedtime Mode ── */
body.bedtime { background: #1a1a2e; color: #F0EBE0; }
body.bedtime .card { background: #252540; border-color: #3a3a5c; }
body.bedtime .card-title, body.bedtime #story-text { color: #F0EBE0; }
body.bedtime .opt-btn { background: #252540; border-color: #3a3a5c; color: #d0c8e8; }
body.bedtime .section-label { color: #9090b0; }
body.bedtime .opt-btn.sel-grade { background: #1a3a2a; border-color: #4a8a5a; color: #8adca0; }
body.bedtime .opt-btn.sel-words { background: #2a1a4a; border-color: #7a4aaa; color: #c090e0; }
body.bedtime .cat-btn { background: #2a2a48; border-color: transparent; color: #9090b0; }
body.bedtime .cat-btn.selected { background: #2a1a4a; border-color: #7a4aaa; color: #c090e0; }
body.bedtime .voice-btn { background: #252540; border-color: #3a3a5c; color: #d0c8e8; }
body.bedtime .voice-btn.sel-voice { background: #2a1a4a; border-color: #7a4aaa; color: #c090e0; }
body.bedtime .progress-wrap, body.bedtime .vs-bar-wrap { background: #3a3a5c; }
body.bedtime .or-divider::before, body.bedtime .or-divider::after { background: #3a3a5c; }
footer { text-align: center; padding: 20px 20px 60px; font-size: 0.78rem; color: var(--muted); font-weight: 700; }
footer strong { color: var(--purple-deep); }
.foot-sub { font-size: 0.72rem; opacity: 0.7; }
body.bedtime footer { color: #6060a0; }
body.bedtime footer strong { color: #9070c0; }
body.bedtime .bg .blob { opacity: 0.03; }
body.bedtime .hint-tip { background: linear-gradient(135deg, #2a1a4a, #1e1040); color: #c090e0; border-color: #5a3a8a; }
body.bedtime .encouragement { background: #2a2a48; color: #d0c8e8; }

.bedtime-toggle { position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 4px 8px; border-radius: 10px; transition: background 0.2s; }
.bedtime-toggle:hover { background: rgba(155,48,255,0.1); }
header { position: relative; }

/* ── Reread badge ── */
.reread-badge { display: inline-block; background: var(--gold); color: var(--ink); font-size: 0.68rem; font-weight: 900; padding: 3px 10px; border-radius: 20px; margin-left: 8px; vertical-align: middle; letter-spacing: 0.5px; }

/* ── Word saved toast ── */
.word-toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--purple-dark); color: #fff; padding: 8px 18px; border-radius: 20px; font-weight: 800; font-size: 0.85rem; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 999; white-space: nowrap; }
.word-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ── Fixed parent bar at bottom ── */
.parent-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; display: flex; justify-content: center; gap: 12px; padding: 10px 16px; background: rgba(255,255,255,0.95); border-top: 1.5px solid var(--border); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
.parent-bar-btn { background: var(--purple-soft); border: 2px solid var(--border); color: var(--purple-deep); font-family: 'Nunito', sans-serif; font-size: 0.82rem; font-weight: 800; padding: 8px 20px; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
.parent-bar-btn:hover { border-color: var(--purple); background: var(--purple); color: #fff; }
body.bedtime .parent-bar { background: rgba(26,26,46,0.95); border-color: #3a3a5c; }
body.bedtime .parent-bar-btn { background: #2a1a4a; border-color: #3a3a5c; color: #c090e0; }
body.bedtime .parent-bar-btn:hover { background: #7a4aaa; border-color: #7a4aaa; color: #fff; }

/* ── Parent PIN screen ── */
.pin-display { display: flex; gap: 12px; justify-content: center; margin: 20px 0; }
.pin-dot { width: 18px; height: 18px; border-radius: 50%; border: 3px solid var(--purple); background: transparent; transition: background 0.15s; }
.pin-dot.filled { background: var(--purple); }
.pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 280px; margin: 0 auto; }
.pin-key { padding: 16px; border: 2.5px solid var(--border); border-radius: 16px; background: var(--card); font-family: 'Fredoka', sans-serif; font-size: 1.4rem; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.15s; color: var(--ink); }
.pin-key:hover { border-color: var(--purple); background: var(--purple-soft); }
.pin-key.del { font-size: 1.1rem; }
.pin-error { color: var(--coral); font-weight: 800; text-align: center; font-size: 0.9rem; min-height: 1.2em; margin-top: 8px; }

/* ── Parent Dashboard ── */
.dash-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.dash-stat { background: var(--section); border-radius: 16px; padding: 14px; text-align: center; }
.dash-stat-num { font-family: 'Fredoka', sans-serif; font-size: 2rem; color: var(--purple); line-height: 1; }
.dash-stat-label { font-size: 0.72rem; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
.topic-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.topic-bar-name { font-size: 0.8rem; font-weight: 800; color: var(--body); width: 80px; flex-shrink: 0; text-transform: capitalize; }
.topic-bar-wrap { flex: 1; background: var(--border); border-radius: 20px; height: 10px; overflow: hidden; }
.topic-bar-fill { height: 100%; border-radius: 20px; background: linear-gradient(90deg, var(--purple), var(--purple-light)); transition: width 0.4s; }
.topic-bar-count { font-size: 0.75rem; font-weight: 800; color: var(--muted); width: 20px; text-align: right; flex-shrink: 0; }
.word-bank-list { max-height: 200px; overflow-y: auto; }
.word-bank-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; border-radius: 10px; margin-bottom: 4px; background: var(--section); }
.word-bank-word { font-weight: 800; color: var(--ink); font-size: 0.95rem; }
.word-bank-count { font-size: 0.75rem; font-weight: 700; color: var(--muted); }
.word-bank-flag { font-size: 0.7rem; background: var(--coral); color: #fff; padding: 2px 7px; border-radius: 10px; font-weight: 800; }
.dash-section-title { font-family: 'Fredoka', sans-serif; font-size: 1.1rem; font-weight: 600; color: var(--ink); margin: 16px 0 10px; }
.btn-danger { background: linear-gradient(135deg, var(--coral), #ff4444) !important; box-shadow: 0 4px 14px rgba(255,107,107,0.3) !important; color: #fff !important; }
.change-pin-row { display: flex; gap: 8px; margin-top: 8px; }
.change-pin-row input { flex: 1; padding: 10px 14px; border: 2.5px solid var(--border); border-radius: 12px; font-family: 'Fredoka', sans-serif; font-size: 1.2rem; text-align: center; letter-spacing: 6px; outline: none; }
.change-pin-row input:focus { border-color: var(--purple); }

/* Story scroll container — kid-friendly thick scrollbar + no page-scroll conflict */
#story-scroll-container {
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;        /* prevents page from scrolling when story is touched */
  touch-action: pan-y;                 /* ensure vertical scroll works inside */
  scrollbar-width: auto;
  scrollbar-color: var(--purple-light) var(--section);
}
@media (min-width: 768px) {
  #story-scroll-container { max-height: 60vh !important; }
  #spelling-word-list, #spell-picker-list, #wpm-story-scroll { max-height: 55vh !important; }
  #wordbank-review-list { max-height: 60vh !important; }
}
@media (min-width: 1024px) {
  #story-scroll-container { max-height: 68vh !important; }
  #spelling-word-list, #spell-picker-list, #wpm-story-scroll { max-height: 62vh !important; }
  #wordbank-review-list { max-height: 68vh !important; }
}
#story-scroll-container::-webkit-scrollbar { width: 14px; }
#story-scroll-container::-webkit-scrollbar-track { background: var(--section); border-radius: 10px; margin: 4px 0; }
#story-scroll-container::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--purple), var(--purple-light));
  border-radius: 10px; border: 3px solid var(--section); min-height: 40px;
}
#story-scroll-container::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, var(--purple-deep), var(--purple)); }
#story-scroll-container::-webkit-scrollbar-thumb:active { background: var(--purple-deep); }
body.bedtime #story-scroll-container { scrollbar-color: #4a4a6a #252540; }
body.bedtime #story-scroll-container::-webkit-scrollbar-track { background: #252540; }
body.bedtime #story-scroll-container::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #6a5a8a, #4a4a6a); border-color: #252540; }
body.bedtime #story-scroll-container::-webkit-scrollbar-thumb:hover { background: #7a6a9a; }

/* ── Word Bank Review Screen ── */
.wb-review-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-radius: 14px; margin-bottom: 8px; background: var(--section); cursor: pointer; transition: all 0.2s; border: 2.5px solid transparent; }
.wb-review-item:hover { border-color: var(--purple-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(155,48,255,0.12); }
.wb-review-item:active { transform: translateY(0); }
.wb-review-word { font-family: 'Fredoka', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--purple); }
.wb-review-hint { font-size: 0.78rem; font-weight: 700; color: var(--muted); }
.wb-review-tap { font-size: 0.72rem; font-weight: 800; color: var(--purple-light); }
body.bedtime .wb-review-item { background: #2a2a48; }
body.bedtime .wb-review-word { color: #c090e0; }
body.bedtime .wb-review-hint { color: #8080a8; }

/* ── Spelling Words Screen ── */
.spelling-header { text-align: center; margin-bottom: 16px; }
.spelling-week { font-size: 0.82rem; font-weight: 800; color: var(--muted); margin-top: 4px; }
.spelling-word-card { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-radius: 16px; margin-bottom: 10px; background: var(--section); cursor: pointer; transition: all 0.2s; border: 2.5px solid transparent; position: relative; overflow: hidden; }
.spelling-word-card:hover { border-color: var(--purple-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(155,48,255,0.12); }
.spelling-word-card:active { transform: translateY(0); }
.spelling-word-card.red-word { border-left: 5px solid var(--coral); }
.spelling-word-num { font-family: 'Fredoka', sans-serif; font-size: 0.85rem; font-weight: 600; color: var(--muted); min-width: 24px; text-align: center; }
.spelling-word-main { flex: 1; }
.spelling-word-text { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; font-weight: 700; color: var(--purple); line-height: 1.2; }
.spelling-syllables { font-size: 0.92rem; font-weight: 800; color: var(--ink); margin-top: 3px; letter-spacing: 0.5px; }
.spelling-syllables .syl-dot { color: var(--coral); font-weight: 900; padding: 0 1px; }
.spelling-word-def { font-size: 0.82rem; font-weight: 700; color: var(--muted); margin-top: 4px; line-height: 1.35; }
.spelling-word-tap { font-size: 0.72rem; font-weight: 800; color: var(--purple-light); flex-shrink: 0; }
.spelling-red-badge { display: inline-block; background: var(--coral); color: #fff; font-size: 0.68rem; font-weight: 800; padding: 2px 8px; border-radius: 8px; margin-left: 8px; vertical-align: middle; }
.spelling-actions { display: flex; gap: 10px; margin-top: 18px; }
.spelling-actions .btn-main { flex: 1; }
.spelling-upload-area { text-align: center; padding: 40px 20px; }
.spelling-upload-icon { font-size: 4rem; margin-bottom: 12px; }
.spelling-upload-text { font-weight: 800; color: var(--ink); font-size: 1.05rem; margin-bottom: 6px; }
.spelling-upload-hint { font-weight: 700; color: var(--muted); font-size: 0.85rem; }
.spelling-loading { text-align: center; padding: 40px 0; }
.spelling-count-bar { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 14px; padding: 10px; background: var(--purple-soft); border-radius: 12px; }
.spelling-count-num { font-family: 'Fredoka', sans-serif; font-size: 1.6rem; font-weight: 700; color: var(--purple); }
.spelling-count-label { font-size: 0.82rem; font-weight: 800; color: var(--purple-deep); }
body.bedtime .spelling-word-card { background: #2a2a48; }
body.bedtime .spelling-word-card.red-word { border-left-color: #ff6b6b; }
body.bedtime .spelling-word-text { color: #c090e0; }
body.bedtime .spelling-syllables { color: #d0c8e8; }
body.bedtime .spelling-word-def { color: #8080a8; }
body.bedtime .spelling-count-bar { background: #2a1a4a; }
body.bedtime .spelling-count-num { color: #c090e0; }
body.bedtime .spelling-count-label { color: #a080c0; }
.spell-def-spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--purple); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }
body.bedtime .spell-def-spinner { border-color: #3a3a5c; border-top-color: #7a4aaa; }

/* ── Spelling Word Picker ── */
.spell-picker-word { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 14px; margin-bottom: 6px; background: var(--section); cursor: pointer; transition: all 0.2s; border: 2.5px solid transparent; user-select: none; -webkit-user-select: none; }
.spell-picker-word:active { transform: scale(0.98); }
.spell-picker-word.picked { background: rgba(155,48,255,0.12); border-color: var(--purple); }
.spell-picker-word.picked .spell-picker-check { background: var(--purple); color: #fff; }
.spell-picker-check { width: 28px; height: 28px; border-radius: 50%; border: 2.5px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 800; flex-shrink: 0; transition: all 0.2s; background: var(--card); }
.spell-picker-label { font-family: 'Fredoka', sans-serif; font-size: 1.15rem; font-weight: 700; color: var(--ink); }
.spell-picker-bar { position: sticky; bottom: 0; background: var(--card); padding: 12px 0 4px; border-top: 1.5px solid var(--border); margin-top: 12px; text-align: center; }
.spell-picker-count { font-size: 0.88rem; font-weight: 800; color: var(--muted); margin-bottom: 8px; }
.spell-select-all { display: inline-block; padding: 8px 22px; border-radius: 12px; border: 2.5px solid var(--purple); background: var(--purple-soft); font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.9rem; color: var(--purple-deep); cursor: pointer; transition: all 0.2s; margin-bottom: 10px; }
.spell-select-all:hover { background: var(--purple); color: #fff; }
.spell-select-all.all-selected { background: var(--purple); color: #fff; }
body.bedtime .spell-picker-word { background: #2a2a48; }
body.bedtime .spell-picker-word.picked { background: rgba(155,48,255,0.2); border-color: #7a4aaa; }
body.bedtime .spell-picker-check { background: #1a1a30; border-color: #3a3a5c; }
body.bedtime .spell-picker-word.picked .spell-picker-check { background: #7a4aaa; }
body.bedtime .spell-picker-label { color: #d0c8e8; }
body.bedtime .spell-picker-bar { background: #252540; border-color: #3a3a5c; }
body.bedtime .spell-select-all { background: #2a1a4a; border-color: #7a4aaa; color: #c090e0; }
body.bedtime .spell-select-all.all-selected { background: #7a4aaa; color: #fff; }

/* ── Spelling Practice (Multiple Choice) ── */
.spell-practice-progress { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
.spell-practice-bar-wrap { flex: 1; background: var(--border); border-radius: 20px; height: 10px; overflow: hidden; }
.spell-practice-bar { height: 100%; border-radius: 20px; background: linear-gradient(90deg, var(--purple), var(--green)); transition: width 0.4s ease; }
.spell-practice-label { font-size: 0.8rem; font-weight: 800; color: var(--muted); white-space: nowrap; }
.spell-practice-prompt { text-align: center; margin: 20px 0; }
.spell-practice-hear { font-size: 4rem; cursor: pointer; transition: transform 0.2s; display: inline-block; }
.spell-practice-hear:hover { transform: scale(1.1); }
.spell-practice-hear:active { transform: scale(0.95); }
.spell-practice-hint { font-size: 0.88rem; font-weight: 800; color: var(--muted); margin-top: 8px; }
.spell-practice-choices { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 16px 0; }
.spell-choice-btn { padding: 16px 12px; border-radius: 16px; border: 3px solid var(--border); background: var(--section); font-family: 'Fredoka', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--ink); cursor: pointer; transition: all 0.2s; text-align: center; min-height: 56px; display: flex; align-items: center; justify-content: center; }
.spell-choice-btn:active { transform: scale(0.96); }
.spell-choice-btn.correct { border-color: var(--green); background: #EFFFF4; color: #1B7A3E; animation: choicePop 0.3s ease; }
.spell-choice-btn.wrong { border-color: var(--coral); background: #FFF0F0; color: #e74c3c; animation: choiceShake 0.4s ease; }
.spell-choice-btn.reveal { border-color: var(--green); background: #EFFFF4; color: #1B7A3E; }
.spell-choice-btn:disabled { cursor: default; opacity: 0.7; }
@keyframes choicePop { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes choiceShake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
.spell-practice-feedback { text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; }
.spell-practice-feedback-msg { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; font-weight: 700; }
.spell-practice-result { text-align: center; padding: 20px 0; }
.spell-practice-score { font-family: 'Fredoka', sans-serif; font-size: 4rem; color: var(--purple); line-height: 1; }
.spell-practice-score-label { font-size: 0.9rem; font-weight: 800; color: var(--muted); margin-top: 4px; }
.spell-practice-stars { font-size: 2rem; margin: 12px 0; }
.spell-result-list { text-align: left; margin: 16px 0; }
.spell-result-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 10px; margin-bottom: 4px; font-weight: 700; font-size: 0.95rem; }
.spell-result-item.got-right { background: #EFFFF4; color: #1B7A3E; }
.spell-result-item.got-wrong { background: #FFF0F0; color: #e74c3c; }
body.bedtime .spell-choice-btn { background: #2a2a48; border-color: #3a3a5c; color: #d0c8e8; }
body.bedtime .spell-choice-btn.correct { background: #1a3a2a; border-color: #4a8a5a; color: #8adca0; }
body.bedtime .spell-choice-btn.wrong { background: #3a1a1a; border-color: #8a4a4a; color: #e8a0a0; }
body.bedtime .spell-choice-btn.reveal { background: #1a3a2a; border-color: #4a8a5a; color: #8adca0; }
body.bedtime .spell-practice-bar-wrap { background: #3a3a5c; }
body.bedtime .spell-result-item.got-right { background: #1a3a2a; color: #8adca0; }
body.bedtime .spell-result-item.got-wrong { background: #3a1a1a; color: #e8a0a0; }

/* ── Spelling Fill-in-the-Blank ── */
.spell-fill-container { text-align: center; margin: 16px 0; }
.spell-fill-display { font-family: 'Fredoka', sans-serif; font-size: 2rem; font-weight: 700; color: var(--ink); letter-spacing: 4px; margin-bottom: 16px; min-height: 2.5rem; }
.spell-fill-display .given { color: var(--purple); }
.spell-fill-display .blank { color: var(--border); }
.spell-fill-display .typed { color: var(--green); }
.spell-fill-display .wrong-char { color: var(--coral); }
.spell-fill-input { font-family: 'Fredoka', sans-serif; font-size: 1.4rem; font-weight: 700; text-align: center; padding: 14px 20px; border: 3px solid var(--border); border-radius: 16px; background: var(--section); color: var(--ink); width: 100%; max-width: 300px; outline: none; transition: border-color 0.2s; }
.spell-fill-input:focus { border-color: var(--purple); }
.spell-fill-input.correct { border-color: var(--green); background: #EFFFF4; color: #1B7A3E; }
.spell-fill-input.wrong { border-color: var(--coral); background: #FFF0F0; color: #e74c3c; }
.spell-fill-submit { margin-top: 12px; }
.spell-round-label { display: inline-block; padding: 4px 14px; border-radius: 10px; font-size: 0.78rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
.spell-round-label.round-mc { background: var(--purple-soft); color: var(--purple-deep); }
.spell-round-label.round-fill { background: #FFF4E6; color: #C47000; }
body.bedtime .spell-fill-display .given { color: #c090e0; }
body.bedtime .spell-fill-display .blank { color: #3a3a5c; }
body.bedtime .spell-fill-display .typed { color: #8adca0; }
body.bedtime .spell-fill-input { background: #2a2a48; border-color: #3a3a5c; color: #d0c8e8; }
body.bedtime .spell-fill-input:focus { border-color: #7a4aaa; }
body.bedtime .spell-fill-input.correct { background: #1a3a2a; border-color: #4a8a5a; color: #8adca0; }
body.bedtime .spell-fill-input.wrong { background: #3a1a1a; border-color: #8a4a4a; color: #e8a0a0; }
body.bedtime .spell-round-label.round-mc { background: #2a1a4a; color: #c090e0; }
body.bedtime .spell-round-label.round-fill { background: #3a2a1a; color: #e0b060; }

/* ── Spelling Quiz (Full Test) ── */
.quiz-word-num { font-family: 'Fredoka', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--muted); margin-bottom: 4px; }
.quiz-input-wrap { text-align: center; margin: 20px 0; }
.quiz-input { font-family: 'Fredoka', sans-serif; font-size: 1.6rem; font-weight: 700; text-align: center; padding: 16px 20px; border: 3px solid var(--border); border-radius: 16px; background: var(--section); color: var(--ink); width: 100%; max-width: 340px; outline: none; transition: border-color 0.2s; letter-spacing: 2px; }
.quiz-input:focus { border-color: var(--purple); }
.quiz-input.correct { border-color: var(--green); background: #EFFFF4; color: #1B7A3E; }
.quiz-input.wrong { border-color: var(--coral); background: #FFF0F0; color: #e74c3c; }
.quiz-correction { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; font-weight: 700; color: var(--green); margin-top: 8px; }
.quiz-btn-row { display: flex; gap: 10px; justify-content: center; margin-top: 14px; }
.quiz-countdown { font-family: 'Fredoka', sans-serif; font-size: 5rem; color: var(--purple); text-align: center; animation: quizPulse 0.6s ease; }
@keyframes quizPulse { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
body.bedtime .quiz-input { background: #2a2a48; border-color: #3a3a5c; color: #d0c8e8; }
body.bedtime .quiz-input:focus { border-color: #7a4aaa; }
body.bedtime .quiz-input.correct { background: #1a3a2a; border-color: #4a8a5a; color: #8adca0; }
body.bedtime .quiz-input.wrong { background: #3a1a1a; border-color: #8a4a4a; color: #e8a0a0; }
body.bedtime .quiz-correction { color: #8adca0; }

/* ── Dictionary Popup ── */
.dict-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; display: flex; align-items: flex-end; justify-content: center; animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.dict-popup { width: 100%; max-width: 500px; background: var(--card); border-radius: 24px 24px 0 0; padding: 24px 20px 30px; box-shadow: 0 -4px 30px rgba(74,26,107,0.2); animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.dict-word { font-family: 'Fredoka', sans-serif; font-size: 2rem; font-weight: 700; color: var(--purple); text-align: center; margin-bottom: 4px; }
.dict-definition { font-size: 1.1rem; font-weight: 700; color: var(--ink); text-align: center; line-height: 1.6; margin: 12px 0 18px; min-height: 2em; }
.dict-loading { text-align: center; color: var(--muted); font-weight: 700; font-size: 0.9rem; }
.dict-loading .spin-circle { width: 28px; height: 28px; border-width: 4px; margin: 0 auto 8px; }
.dict-speaker-btn { display: block; margin: 0 auto 12px; padding: 10px 24px; border-radius: 14px; border: 2.5px solid var(--purple); background: var(--purple-soft); font-family: 'Nunito'; font-weight: 800; font-size: 0.95rem; color: var(--purple-deep); cursor: pointer; transition: all 0.2s; }
.dict-speaker-btn:hover { background: var(--purple); color: #fff; }
.dict-close-btn { display: block; width: 100%; padding: 14px; border-radius: var(--r); border: none; background: linear-gradient(135deg, var(--green), #1BA053); color: #fff; font-family: 'Fredoka', sans-serif; font-size: 1.15rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 14px rgba(107,203,119,0.35); }
body.bedtime .dict-popup { background: #252540; }
body.bedtime .dict-word { color: #c090e0; }
body.bedtime .dict-definition { color: #d0c8e8; }
body.bedtime .dict-speaker-btn { background: #2a1a4a; border-color: #7a4aaa; color: #c090e0; }

/* ── WPM Timer ── */
.wpm-timer-bar { text-align: center; margin-bottom: 14px; }
.wpm-timer-display { font-family: 'Fredoka', sans-serif; font-size: 2.5rem; color: var(--purple); line-height: 1; }
.wpm-timer-label { font-size: 0.78rem; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
.wpm-result-big { font-family: 'Fredoka', sans-serif; font-size: 5rem; color: var(--purple); line-height: 1; margin: 10px 0; }
.wpm-result-unit { font-family: 'Fredoka', sans-serif; font-size: 1.2rem; color: var(--purple-deep); font-weight: 600; }
.wpm-benchmark { background: var(--section); border-radius: 16px; padding: 14px; margin: 14px 0; text-align: center; }
.wpm-benchmark-label { font-size: 0.82rem; font-weight: 800; color: var(--muted); }
.wpm-benchmark-range { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; color: var(--ink); margin-top: 4px; }
.wpm-history { margin: 14px 0; }
.wpm-history-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.wpm-history-read { font-weight: 800; font-size: 0.82rem; color: var(--muted); width: 60px; flex-shrink: 0; }
.wpm-history-bar-wrap { flex: 1; background: var(--border); border-radius: 20px; height: 12px; overflow: hidden; }
.wpm-history-bar { height: 100%; border-radius: 20px; background: linear-gradient(90deg, var(--purple), var(--green)); transition: width 0.6s; }
.wpm-history-num { font-family: 'Fredoka', sans-serif; font-size: 1rem; color: var(--ink); width: 50px; text-align: right; flex-shrink: 0; }
.wpm-improvement { display: inline-block; background: #EFFFF4; border: 2px solid var(--green); border-radius: 12px; padding: 6px 14px; font-weight: 800; font-size: 0.9rem; color: #1B7A3E; margin-top: 8px; }
body.bedtime .wpm-benchmark { background: #2a2a48; }
body.bedtime .wpm-benchmark-range { color: #d0c8e8; }
body.bedtime .wpm-history-bar-wrap { background: #3a3a5c; }
body.bedtime .wpm-improvement { background: #1a3a2a; border-color: #4a8a5a; color: #8adca0; }

/* ── Reading Mode (Fullscreen) ── */
.reading-mode-overlay { position: fixed; inset: 0; z-index: 200; background: var(--bg); overflow-y: auto; overscroll-behavior: contain; display: none; animation: fadeIn 0.3s ease; }
.reading-mode-overlay.active { display: block; }
.reading-mode-inner { max-width: 700px; margin: 0 auto; padding: 24px 24px 80px; }
.reading-mode-close { position: fixed; top: 16px; right: 16px; z-index: 201; width: 44px; height: 44px; border-radius: 50%; border: 2.5px solid var(--border); background: var(--card); font-size: 1.2rem; font-weight: 800; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 12px rgba(0,0,0,0.1); transition: all 0.2s; }
.reading-mode-close:hover { background: var(--coral); color: #fff; border-color: var(--coral); }
.reading-mode-title { font-family: 'Fredoka', sans-serif; font-size: 1.6rem; font-weight: 700; color: var(--purple); text-align: center; margin-bottom: 20px; padding-top: 8px; }
.reading-mode-text { font-size: 1.6rem; line-height: 2.8rem; color: var(--ink); font-weight: 700; font-family: 'Nunito', sans-serif; }
.reading-mode-text .word-span { cursor: pointer; border-radius: 4px; padding: 2px 1px; transition: background 0.15s; }
.reading-mode-text .word-span:hover { background: var(--purple-soft); }
.reading-mode-text .word-span.active-word { background: var(--gold); color: var(--ink); border-radius: 4px; transform: scale(1.05); display: inline-block; box-shadow: 0 2px 8px rgba(255,180,0,0.4); }
.reading-mode-fab { position: fixed; top: 16px; left: 16px; z-index: 201; display: flex; gap: 10px; }
.reading-mode-fab button { padding: 12px 18px; border-radius: 50px; border: none; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.88rem; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.15); transition: all 0.2s; }
.reading-mode-fab button:hover { transform: scale(1.05); }
.btn-rm-close { background: var(--card); color: var(--muted); border: 2px solid var(--border) !important; }
.btn-rm-listen { background: var(--purple); color: #fff; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
body.bedtime .reading-mode-overlay { background: #1a1a2e; }
body.bedtime .reading-mode-title { color: #c090e0; }
body.bedtime .reading-mode-text { color: #F0EBE0; }
body.bedtime .reading-mode-text .word-span:hover { background: #2a1a4a; }
body.bedtime .reading-mode-text .word-span.active-word { background: #B8860B; color: #F0EBE0; box-shadow: 0 2px 8px rgba(184,134,11,0.4); }
body.bedtime .btn-rm-close { background: #252540; border-color: #3a3a5c !important; color: #a080c0; }
body.bedtime .btn-rm-listen { background: #7a4aaa; }

/* ── Floating Play/Pause Button (both modes) ── */
.float-tts-btn { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 250; padding: 14px 28px; border-radius: 50px; border: none; font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 20px rgba(155,48,255,0.35); transition: all 0.2s; display: none; }
.float-tts-btn:active { transform: translateX(-50%) scale(0.95); }
.float-tts-btn.playing { background: var(--coral); color: #fff; }
.float-tts-btn.paused { background: var(--green); color: #fff; }
.float-tts-btn.loading { background: var(--muted); color: #fff; pointer-events: none; }
body.bedtime .float-tts-btn.playing { background: #8a4a4a; }
body.bedtime .float-tts-btn.paused { background: #4a8a5a; }

@media (max-width: 480px) {
  .logo { font-size: 2.2rem; }
  .categories { grid-template-columns: repeat(2, 1fr); }
  #story-text { font-size: 1.15rem; line-height: 1.95rem; }
  .card { padding: 20px 14px; }
  .countdown-number { font-size: 6rem; }
  .tts-controls { grid-template-columns: 1fr 1fr 1fr; }
  .app { padding: 12px 10px 40px; }
}

/* Tablet (768px - 1024px) */
@media (min-width: 768px) {
  .app { max-width: 90%; padding: 24px 30px 60px; }
  .card { padding: 32px; border-radius: 28px; }
  #story-text { font-size: 1.5rem; line-height: 2.4rem; }
  .card-title { font-size: 1.7rem; }
  .categories { grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .spelling-word-card { padding: 16px; }
  .spell-picker-word { padding: 14px 18px; }
  .spell-choice-btn { font-size: 1.3rem; padding: 20px 16px; }
}

/* Desktop (1024px+) */
@media (min-width: 1024px) {
  .app { max-width: 85%; padding: 30px 40px 60px; }
  .card { padding: 36px 40px; }
  #story-text { font-size: 1.6rem; line-height: 2.6rem; }
  .card-title { font-size: 1.8rem; }
  .logo { font-size: 3rem; }
  .categories { grid-template-columns: repeat(3, 1fr); gap: 18px; }
  .cat-btn { padding: 18px 10px 14px; font-size: 0.9rem; }
  .cat-btn svg { width: 46px; height: 46px; }
  .opt-btn { padding: 12px 10px; font-size: 0.95rem; }
  .btn-main { font-size: 1.05rem; padding: 16px; }
  .spelling-word-card { padding: 18px 20px; }
  .spelling-word-text { font-size: 1.4rem; }
  .spell-picker-word { padding: 16px 20px; }
  .spell-picker-label { font-size: 1.25rem; }
  .spell-choice-btn { font-size: 1.4rem; padding: 22px 18px; min-height: 64px; }
  .quiz-input { font-size: 1.8rem; padding: 18px 24px; max-width: 400px; }
  .reading-mode-text { font-size: 1.8rem; line-height: 3rem; }
}

/* Large desktop (1440px+) */
@media (min-width: 1440px) {
  .app { max-width: 1200px; }
  #story-text { font-size: 1.8rem; line-height: 2.8rem; }
  .reading-mode-text { font-size: 2rem; line-height: 3.4rem; }
  .card { padding: 40px 48px; }
}
</style>
</head>
<body>
<div class="bg">
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>
  <div class="blob blob3"></div>
</div>

<div class="app">
  <header>
    <div class="logo-mark">
      <div class="bar bar1"></div>
      <div class="bar bar2"></div>
      <div class="bar bar3"></div>
    </div>
    <div class="logo">Read<span>Up!</span></div>
    <button class="bedtime-toggle" id="btn-bedtime" title="Bedtime Mode">🌙</button>
    <div class="tagline">Reading is a superpower.</div>
    <div class="nonprofit-badge">A Transforming Youth, Inc. Program</div>
    <span class="dedication">✨ Inspired by Kamryn &amp; Christopher II ✨</span>
  </header>

  <!-- SCREEN: Welcome flow (first time only) -->
  <div class="screen" id="screen-welcome-1" style="display:none;">
    <div class="card" style="text-align:center;">
      <div style="font-size:3rem;margin-bottom:12px;">📖</div>
      <div class="card-title" style="margin-bottom:8px;">Welcome to ReadUp!</div>
      <p style="color:var(--body);font-weight:700;font-size:1rem;line-height:1.6;margin-bottom:6px;">A free reading fluency app for kids in Pre-K through 3rd grade.</p>
      <p style="color:var(--muted);font-weight:700;font-size:0.88rem;line-height:1.5;margin-bottom:16px;">Built by <strong style="color:var(--purple-deep);">Transforming Youth, Inc.</strong> to help every child become a confident reader — whether at home, in a classroom, or on the go.</p>
      <button class="btn-main btn-green" id="btn-welcome-next-1" style="font-size:1.1rem;">Next →</button>
    </div>
  </div>

  <div class="screen" id="screen-welcome-2" style="display:none;">
    <div class="card" style="text-align:center;">
      <div style="font-size:3rem;margin-bottom:12px;">🔁</div>
      <div class="card-title" style="margin-bottom:8px;">The 3-Read Method</div>
      <p style="color:var(--body);font-weight:700;font-size:0.92rem;line-height:1.6;margin-bottom:10px;">Research shows that reading a story <strong style="color:var(--purple);">3 times</strong> is one of the fastest ways to build reading fluency.</p>
      <div style="background:var(--section);border-radius:16px;padding:14px;text-align:left;margin-bottom:12px;">
        <p style="font-weight:800;color:var(--green);font-size:0.88rem;margin-bottom:6px;">▶ Read #1 — Listen &amp; follow along</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.82rem;margin-bottom:10px;">The teacher reads while words highlight. Your child sees and hears every word.</p>
        <p style="font-weight:800;color:var(--purple);font-size:0.88rem;margin-bottom:6px;">▶ Read #2 — Read together</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.82rem;margin-bottom:10px;">Your child reads along with the teacher. Familiar words come faster.</p>
        <p style="font-weight:800;color:var(--purple-dark);font-size:0.88rem;margin-bottom:6px;">▶ Read #3 — Read on your own</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.82rem;">Your child reads independently. Confidence builds with every word.</p>
      </div>
      <p style="color:var(--muted);font-weight:700;font-size:0.82rem;line-height:1.5;">AI creates a <strong>brand new story</strong> every time based on your child's interests and grade level. Double-tap any word to hear it spoken.</p>
      <button class="btn-main btn-green" id="btn-welcome-next-2" style="font-size:1.1rem;">Next →</button>
    </div>
  </div>

  <div class="screen" id="screen-welcome-3" style="display:none;">
    <div class="card" style="text-align:center;">
      <div style="font-size:3rem;margin-bottom:12px;">👤</div>
      <div class="card-title" style="margin-bottom:8px;">For Parents</div>
      <p style="color:var(--body);font-weight:700;font-size:0.92rem;line-height:1.6;margin-bottom:12px;">ReadUp! tracks your child's progress so you don't have to hover.</p>
      <div style="background:var(--section);border-radius:16px;padding:14px;text-align:left;margin-bottom:12px;">
        <p style="font-weight:800;color:var(--ink);font-size:0.88rem;margin-bottom:6px;">📊 Parent Dashboard</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.82rem;margin-bottom:10px;">See stories read, time spent, favorite topics, and words your child needed help with.</p>
        <p style="font-weight:800;color:var(--ink);font-size:0.88rem;margin-bottom:6px;">🔒 PIN Protected</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.82rem;margin-bottom:10px;">Default PIN is <strong style="color:var(--purple);">1234</strong>. You can change it in the dashboard settings.</p>
        <p style="font-weight:800;color:var(--ink);font-size:0.88rem;margin-bottom:6px;">📍 Where to find it</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.82rem;">Tap <strong>"Parent"</strong> at the bottom of the screen anytime.</p>
      </div>
      <button class="btn-main btn-green" id="btn-welcome-next-3" style="font-size:1.1rem;">Next →</button>
    </div>
  </div>

  <div class="screen" id="screen-welcome-4" style="display:none;">
    <div class="card" style="text-align:center;">
      <div style="font-size:3rem;margin-bottom:12px;">🚀</div>
      <div class="card-title" style="margin-bottom:8px;">Let's Get Started!</div>
      <p style="color:var(--body);font-weight:700;font-size:0.92rem;line-height:1.6;margin-bottom:16px;">Pick your child's grade level to begin:</p>
      <div class="option-row" id="welcome-grade-row" style="justify-content:center;">
        <button class="opt-btn" data-wgrade="prek" style="min-width:60px;">Pre-K</button>
        <button class="opt-btn" data-wgrade="k" style="min-width:60px;">K</button>
        <button class="opt-btn" data-wgrade="1" style="min-width:60px;">1st</button>
        <button class="opt-btn" data-wgrade="2" style="min-width:60px;">2nd</button>
        <button class="opt-btn" data-wgrade="3" style="min-width:60px;">3rd</button>
      </div>
      <button class="btn-main btn-green" id="btn-welcome-go" style="font-size:1.1rem;margin-top:16px;" disabled>✨ Start Reading!</button>
    </div>
  </div>

  <!-- SCREEN: Pick -->
  <div class="screen active" id="screen-pick">
    <div class="card">
      <div class="card-title">Build your story! 🌟</div>
      <div class="section-label">Your grade:</div>
      <div class="option-row" id="grade-row">
        <button class="opt-btn" data-grade="prek">Pre-K</button>
        <button class="opt-btn" data-grade="k">K</button>
        <button class="opt-btn sel-grade" data-grade="1">1st</button>
        <button class="opt-btn" data-grade="2">2nd</button>
        <button class="opt-btn" data-grade="3">3rd</button>
      </div>
      <div class="section-label">Story length (words):</div>
      <div class="option-row" id="words-row">
        <button class="opt-btn" data-words="50">50</button>
        <button class="opt-btn sel-words" data-words="100">100</button>
        <button class="opt-btn" data-words="150">150</button>
        <button class="opt-btn" data-words="200">200</button>
        <button class="opt-btn" data-words="300">300</button>
        <button class="opt-btn" data-words="500">500</button>
      </div>
      <div class="section-label">Pick a topic:</div>
      <div class="categories">
        <button class="cat-btn selected" data-cat="animals">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="16" r="10" fill="#C9A0DC" opacity="0.3"/><path d="M12 12c-2-4-6-3-6 0s3 4 5 3" stroke="#6B2D8B" stroke-width="2" stroke-linecap="round"/><path d="M28 12c2-4 6-3 6 0s-3 4-5 3" stroke="#6B2D8B" stroke-width="2" stroke-linecap="round"/><ellipse cx="20" cy="20" rx="9" ry="8" fill="#9B30FF"/><circle cx="16.5" cy="18" r="1.5" fill="#fff"/><circle cx="23.5" cy="18" r="1.5" fill="#fff"/><ellipse cx="20" cy="22" rx="2.5" ry="1.5" fill="#6B2D8B"/><path d="M15 26c0 3 2 6 5 6s5-3 5-6" stroke="#6B2D8B" stroke-width="1.5" stroke-linecap="round" fill="none"/></svg>
          Animals
        </button>
        <button class="cat-btn" data-cat="space">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="14" fill="#4A1A6B" opacity="0.15"/><path d="M20 6L22 14H28L23 19L25 27L20 22L15 27L17 19L12 14H18L20 6Z" fill="#9B30FF" stroke="#6B2D8B" stroke-width="1"/><circle cx="10" cy="10" r="1.5" fill="#C9A0DC"/><circle cx="32" cy="12" r="1" fill="#C9A0DC"/><circle cx="8" cy="30" r="1" fill="#C9A0DC"/><circle cx="33" cy="28" r="1.5" fill="#C9A0DC"/></svg>
          Space
        </button>
        <button class="cat-btn" data-cat="dinosaurs">
          <svg viewBox="0 0 40 40" fill="none"><ellipse cx="20" cy="22" rx="14" ry="10" fill="#C9A0DC" opacity="0.2"/><path d="M10 28c0-8 4-16 12-16 6 0 10 5 10 12" stroke="#6B2D8B" stroke-width="2.5" stroke-linecap="round" fill="none"/><circle cx="27" cy="16" r="2" fill="#9B30FF"/><circle cx="27" cy="16" r="0.8" fill="#fff"/><path d="M30 14c2-2 4-1 3 1" stroke="#6B2D8B" stroke-width="1.5" stroke-linecap="round"/><path d="M10 28l-2 4M14 30l-1 4M28 28l1 4M24 30l1 4" stroke="#6B2D8B" stroke-width="2" stroke-linecap="round"/><path d="M8 22l-3-1M8 18l-3 0M8 25l-4 0" stroke="#9B30FF" stroke-width="1.5" stroke-linecap="round"/></svg>
          Dinosaurs
        </button>
        <button class="cat-btn" data-cat="ocean">
          <svg viewBox="0 0 40 40" fill="none"><path d="M4 22c4-3 8 0 12-3s8 0 12-3s8 1 8 1" stroke="#C9A0DC" stroke-width="1.5" opacity="0.4"/><path d="M4 28c4-3 8 0 12-3s8 0 12-3s8 1 8 1" stroke="#C9A0DC" stroke-width="1.5" opacity="0.25"/><path d="M20 10c-6 0-10 5-10 10 0 3 2 6 5 7l5-2 5 2c3-1 5-4 5-7 0-5-4-10-10-10z" fill="#9B30FF" opacity="0.85"/><circle cx="16" cy="17" r="1.5" fill="#fff"/><circle cx="24" cy="17" r="1.5" fill="#fff"/><path d="M30 16c3-5 6-2 4 1" stroke="#6B2D8B" stroke-width="1.5" stroke-linecap="round" fill="none"/></svg>
          Ocean
        </button>
        <button class="cat-btn" data-cat="superheroes">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="12" r="6" fill="#9B30FF"/><circle cx="20" cy="12" r="3.5" fill="#4A1A6B"/><path d="M14 20h12l2 14H12l2-14z" fill="#6B2D8B"/><path d="M20 20v14" stroke="#9B30FF" stroke-width="2"/><path d="M16 20l-6 8" stroke="#C9A0DC" stroke-width="2.5" stroke-linecap="round"/><path d="M24 20l6 8" stroke="#C9A0DC" stroke-width="2.5" stroke-linecap="round"/><polygon points="20,3 21.5,6.5 25,6.5 22.2,8.8 23.2,12.3 20,10 16.8,12.3 17.8,8.8 15,6.5 18.5,6.5" fill="#FFD93D" opacity="0.8"/></svg>
          Heroes
        </button>
        <button class="cat-btn" data-cat="magic">
          <svg viewBox="0 0 40 40" fill="none"><line x1="8" y1="34" x2="32" y2="8" stroke="#6B2D8B" stroke-width="2.5" stroke-linecap="round"/><circle cx="32" cy="8" r="3" fill="#9B30FF"/><circle cx="32" cy="8" r="1.5" fill="#FFD93D"/><circle cx="14" cy="12" r="1.5" fill="#C9A0DC"/><circle cx="22" cy="8" r="1" fill="#C9A0DC"/><circle cx="28" cy="18" r="1" fill="#C9A0DC"/><path d="M24 14l2-3M26 16l3-1M25 12l3 1" stroke="#C9A0DC" stroke-width="1" stroke-linecap="round"/></svg>
          Magic
        </button>
        <button class="cat-btn" data-cat="sports">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="13" fill="#9B30FF" opacity="0.15"/><circle cx="20" cy="20" r="10" fill="#9B30FF" stroke="#6B2D8B" stroke-width="1.5"/><path d="M10 20h20M20 10v20" stroke="#6B2D8B" stroke-width="1.2" opacity="0.5"/><path d="M13 12c2 2 5 3 7 3M27 28c-2-2-5-3-7-3" stroke="#fff" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/></svg>
          Sports
        </button>
        <button class="cat-btn" data-cat="cooking">
          <svg viewBox="0 0 40 40" fill="none"><path d="M10 18h20v4c0 6-4 10-10 10s-10-4-10-10v-4z" fill="#9B30FF" opacity="0.85"/><rect x="8" y="16" width="24" height="4" rx="2" fill="#6B2D8B"/><path d="M14 16v-4c0-2 1-4 3-4" stroke="#C9A0DC" stroke-width="1.5" stroke-linecap="round" fill="none"/><path d="M20 16v-5c0-2 1-3 2-3" stroke="#C9A0DC" stroke-width="1.5" stroke-linecap="round" fill="none"/><path d="M26 16v-3c0-2-1-3-2-3" stroke="#C9A0DC" stroke-width="1.5" stroke-linecap="round" fill="none"/><circle cx="16" cy="24" r="1.5" fill="#fff" opacity="0.5"/><circle cx="22" cy="26" r="1" fill="#fff" opacity="0.5"/></svg>
          Cooking
        </button>
        <button class="cat-btn" data-cat="friends">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="14" cy="14" r="5" fill="#9B30FF"/><circle cx="14" cy="14" r="2.5" fill="#4A1A6B"/><path d="M8 26c0-4 3-7 6-7s6 3 6 7" fill="#6B2D8B" opacity="0.7"/><circle cx="26" cy="14" r="5" fill="#C9A0DC"/><circle cx="26" cy="14" r="2.5" fill="#6B2D8B"/><path d="M20 26c0-4 3-7 6-7s6 3 6 7" fill="#9B30FF" opacity="0.5"/><circle cx="20" cy="32" r="1" fill="#FFD93D"/></svg>
          Friends
        </button>
        <button class="cat-btn" data-cat="confidence">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="14" fill="#C9A0DC" opacity="0.2"/><path d="M20 8l2.5 7.5H30l-6.5 4.5 2.5 7.5L20 23l-6 4.5 2.5-7.5L10 15.5h7.5L20 8z" fill="#9B30FF" stroke="#6B2D8B" stroke-width="1"/><circle cx="20" cy="20" r="3" fill="#FFD93D"/></svg>
          I Can Do It!
        </button>
        <button class="cat-btn" data-cat="blackhistory">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="13" fill="#4A1A6B" opacity="0.15"/><path d="M20 8c-6.6 0-12 5.4-12 12s5.4 12 12 12 12-5.4 12-12S26.6 8 20 8z" fill="#9B30FF" opacity="0.85"/><path d="M15 20l3 3 7-7" stroke="#FFD93D" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Black History
        </button>
        <button class="cat-btn" data-cat="helpers">
          <svg viewBox="0 0 40 40" fill="none"><rect x="14" y="8" width="12" height="6" rx="2" fill="#9B30FF"/><rect x="8" y="14" width="24" height="18" rx="3" fill="#6B2D8B" opacity="0.85"/><rect x="17" y="18" width="6" height="10" rx="1" fill="#FFD93D"/><rect x="13" y="22" width="14" height="3" rx="1" fill="#FFD93D"/><circle cx="30" cy="10" r="4" fill="#C9A0DC"/><path d="M28 10h4M30 8v4" stroke="#6B2D8B" stroke-width="1.5" stroke-linecap="round"/></svg>
          Helpers
        </button>
        <button class="cat-btn" data-cat="nature">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="12" r="6" fill="#FFD93D" opacity="0.9"/><path d="M8 28c2-8 5-12 12-12s10 4 12 12" fill="#6BCB77" opacity="0.8"/><path d="M20 16v12" stroke="#6B2D8B" stroke-width="2" stroke-linecap="round"/><path d="M14 32h12" stroke="#6B2D8B" stroke-width="2" stroke-linecap="round"/><circle cx="10" cy="16" r="3" fill="#9B30FF" opacity="0.4"/><circle cx="32" cy="20" r="2" fill="#9B30FF" opacity="0.3"/></svg>
          Outside
        </button>
        <button class="cat-btn" data-cat="emotions">
          <svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="13" fill="#C9A0DC" opacity="0.25"/><circle cx="20" cy="20" r="10" fill="#9B30FF" opacity="0.85"/><circle cx="16" cy="17" r="1.8" fill="#fff"/><circle cx="24" cy="17" r="1.8" fill="#fff"/><path d="M14 24c1.5 2.5 10.5 2.5 12 0" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/><circle cx="28" cy="10" r="2" fill="#FFD93D"/><path d="M26 8l3-2M30 10l2-1" stroke="#FFD93D" stroke-width="1" stroke-linecap="round"/></svg>
          Feelings
        </button>
        <button class="cat-btn" data-cat="trucks">
          <svg viewBox="0 0 40 40" fill="none"><rect x="4" y="16" width="22" height="12" rx="2" fill="#9B30FF"/><rect x="26" y="20" width="10" height="8" rx="2" fill="#6B2D8B"/><rect x="28" y="22" width="6" height="4" rx="1" fill="#C9A0DC" opacity="0.5"/><circle cx="11" cy="30" r="3" fill="#4A1A6B" stroke="#C9A0DC" stroke-width="1.5"/><circle cx="31" cy="30" r="3" fill="#4A1A6B" stroke="#C9A0DC" stroke-width="1.5"/><rect x="6" y="18" width="8" height="5" rx="1" fill="#FFD93D" opacity="0.6"/></svg>
          Trucks
        </button>
        <button class="cat-btn" data-cat="princesses">
          <svg viewBox="0 0 40 40" fill="none"><path d="M20 6l-8 12h16L20 6z" fill="#FFD93D"/><circle cx="20" cy="6" r="2" fill="#9B30FF"/><circle cx="14" cy="14" r="1.5" fill="#9B30FF"/><circle cx="26" cy="14" r="1.5" fill="#9B30FF"/><rect x="10" y="18" width="20" height="16" rx="3" fill="#9B30FF"/><rect x="14" y="24" width="5" height="10" rx="1" fill="#6B2D8B"/><path d="M24 22v6" stroke="#FFD93D" stroke-width="1.5" stroke-linecap="round"/><path d="M22 25h4" stroke="#FFD93D" stroke-width="1.5" stroke-linecap="round"/></svg>
          Princesses
        </button>
        <button class="cat-btn" data-cat="robots">
          <svg viewBox="0 0 40 40" fill="none"><rect x="12" y="14" width="16" height="16" rx="3" fill="#9B30FF"/><rect x="15" y="6" width="10" height="8" rx="3" fill="#6B2D8B"/><circle cx="18" cy="10" r="1.5" fill="#FFD93D"/><circle cx="22" cy="10" r="1.5" fill="#FFD93D"/><rect x="8" y="18" width="4" height="8" rx="2" fill="#C9A0DC"/><rect x="28" y="18" width="4" height="8" rx="2" fill="#C9A0DC"/><rect x="16" y="32" width="3" height="4" rx="1" fill="#6B2D8B"/><rect x="21" y="32" width="3" height="4" rx="1" fill="#6B2D8B"/><path d="M20 4v-2" stroke="#FFD93D" stroke-width="2" stroke-linecap="round"/><circle cx="20" cy="1" r="1.5" fill="#FFD93D"/><rect x="16" y="20" width="8" height="3" rx="1" fill="#C9A0DC" opacity="0.5"/></svg>
          Robots
        </button>
        <button class="cat-btn" data-cat="pirates">
          <svg viewBox="0 0 40 40" fill="none"><path d="M6 28c2-6 8-10 14-10s12 4 14 10" fill="#6B2D8B" opacity="0.3"/><path d="M8 30h24l-2 4H10l-2-4z" fill="#6B2D8B"/><path d="M20 8v20" stroke="#4A1A6B" stroke-width="2.5" stroke-linecap="round"/><path d="M20 8c6 0 10 3 10 6H20V8z" fill="#9B30FF"/><path d="M16 10l-2-3M24 10l2-3" stroke="#FFD93D" stroke-width="1.5" stroke-linecap="round"/><circle cx="20" cy="22" r="4" fill="#FFD93D" opacity="0.6"/><path d="M18 21l4 2M22 21l-4 2" stroke="#4A1A6B" stroke-width="1.5" stroke-linecap="round"/></svg>
          Pirates
        </button>
        <button class="cat-btn" data-cat="airplanes">
          <svg viewBox="0 0 40 40" fill="none"><ellipse cx="20" cy="20" rx="16" ry="4" fill="#C9A0DC" opacity="0.2"/><path d="M6 20h28" stroke="#9B30FF" stroke-width="2.5" stroke-linecap="round"/><path d="M20 20l-6-8h-4l3 8-3 8h4l6-8z" fill="#9B30FF"/><path d="M20 20l8-4h4l-3 4 3 4h-4l-8-4z" fill="#6B2D8B"/><circle cx="20" cy="20" r="2" fill="#FFD93D"/><path d="M18 18l-2-6M22 18l2-6" stroke="#C9A0DC" stroke-width="1" stroke-linecap="round"/></svg>
          Airplanes
        </button>
      </div>
      <button class="btn-main" id="btn-generate">✨ Make My Story!</button>
      <div class="or-divider"><span>or</span></div>
      <button class="btn-main btn-coral" id="btn-scan-page" style="font-size:1rem;">📸 Upload My Reading Passage</button>
      <input type="file" id="scan-file-input" accept="image/*" style="display:none;">
      <div class="or-divider"><span>or</span></div>
      <button class="btn-main btn-purple" id="btn-together-start">📖 Read Together</button>
      <div class="or-divider"><span>or</span></div>
      <button class="btn-main" id="btn-spelling-start" style="font-size:1rem;background:linear-gradient(135deg, #FF8C42, #FF6B6B);box-shadow:0 4px 14px rgba(255,107,107,0.35);">📝 Upload My Spelling Words</button>
      <input type="file" id="spelling-file-input" accept="image/*" style="display:none;">
    </div>
  </div>

<!-- SCREEN: Read Together choice modal -->
<div id="screen-together-choice" style="display:none;position:fixed;inset:0;z-index:90;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
  <div style="width:100%;max-width:400px;padding:20px;">
    <div class="card" style="text-align:center;">
      <div class="card-title">📖 Read Together</div>
      <p style="color:var(--muted);font-weight:700;margin-bottom:16px;">Read with someone — anywhere!</p>
      <button class="btn-main btn-green" id="btn-create-room" style="font-size:1.1rem;">🏠 Create a Room</button>
      <p style="color:var(--muted);font-weight:700;font-size:0.8rem;margin:8px 0;">You pick the story. Share the code with your reading partner.</p>
      <button class="btn-main btn-purple" id="btn-join-room-choice" style="margin-top:10px;font-size:1.1rem;">🔗 Join a Room</button>
      <p style="color:var(--muted);font-weight:700;font-size:0.8rem;margin:8px 0;">Your partner already has a room? Enter their code.</p>
      <button class="btn-main btn-outline" id="btn-together-cancel" style="margin-top:14px;">← Back</button>
    </div>
  </div>
</div>

  <!-- SCREEN: Loading -->
  <div class="screen" id="screen-loading">
    <div class="card">
      <div class="spinner"><div class="spin-circle"></div><div class="spin-label" id="loading-msg">Getting your story ready...</div></div>
    </div>
  </div>

  <!-- SCREEN: Join -->
  <div class="screen" id="screen-join">
    <div class="card">
      <div class="card-title">Join a Reading Room! 📖</div>
      <p style="color:#555;font-weight:700;margin-bottom:4px;">Enter your partner's room code:</p>
      <input class="code-input" id="join-code-input" type="text" maxlength="4" placeholder="1234" inputmode="numeric">
      <div id="join-error" style="background:#FFF0F0;border:2px solid #FF6B6B;border-radius:14px;padding:12px 16px;color:#FF6B6B;font-weight:700;margin-top:10px;display:none;"></div>
      <button class="btn-main btn-green" id="btn-join-room">Join Room →</button>
      <button class="btn-main btn-outline" id="btn-back-join" style="margin-top:10px;">← Back</button>
    </div>
  </div>

  <!-- SCREEN: Waiting host -->
  <div class="screen" id="screen-waiting-host">
    <div class="card">
      <div class="card-title">Waiting for your reading partner <span class="waiting-dots"><span>.</span><span>.</span><span>.</span></span></div>
      <p style="color:#555;font-weight:700;margin-bottom:6px;">Share this code with your reading partner:</p>
      <div class="room-code-display">
        <div class="room-code-number" id="display-room-code">----</div>
        <div class="room-code-label">Room Code</div>
      </div>
      <div class="player-slots">
        <div class="player-slot me"><span class="slot-icon">🧑</span><div class="slot-name">You</div><div class="slot-status">✓ Ready</div></div>
        <div class="player-slot" id="slot-guest"><span class="slot-icon">👤</span><div class="slot-name">Partner</div><div class="slot-status">Waiting...</div></div>
      </div>
      <button class="btn-main btn-outline" id="btn-cancel-host" style="margin-top:10px;">Cancel</button>
    </div>
  </div>

  <!-- SCREEN: Waiting guest -->
  <div class="screen" id="screen-waiting-guest">
    <div class="card">
      <div class="card-title">You're in! Get ready to read together... 📖</div>
      <div class="player-slots">
        <div class="player-slot joined"><span class="slot-icon">👤</span><div class="slot-name">Partner</div><div class="slot-status">✓ Ready</div></div>
        <div class="player-slot me"><span class="slot-icon">🧑</span><div class="slot-name">You</div><div class="slot-status">✓ Joined!</div></div>
      </div>
      <p style="text-align:center;color:#aaa;font-weight:700;margin-top:10px;">Starting soon...</p>
    </div>
  </div>

  <!-- SCREEN: Countdown -->
  <div class="screen" id="screen-countdown">
    <div class="card"><div class="countdown-wrap"><div id="countdown-display" class="countdown-number">3</div></div></div>
  </div>

  <!-- SCREEN: Read -->
  <div class="screen" id="screen-read">
    <div class="card">
      <div class="card-title" id="story-title">Your Story</div>

      <div id="together-progress" style="display:none;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span style="font-weight:800;font-size:0.78rem;color:var(--purple);">📖 Reading Together</span>
          <span style="font-weight:800;font-size:0.78rem;color:var(--muted);margin-left:auto;" id="together-pct">0%</span>
        </div>
        <div class="progress-wrap"><div class="progress-bar" id="together-bar"></div></div>
      </div>

      <div class="progress-wrap" id="solo-progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>

      <!-- Voice selector -->
      <div class="voice-row">
        <span class="voice-label">Voice:</span>
        <button class="voice-btn sel-voice" data-voice="female">👩 Female</button>
        <button class="voice-btn" data-voice="male">👨 Male</button>
      </div>

      <!-- Speed slider -->
      <div class="speed-slider-row">
        <div class="speed-slider-label-row">
          <span class="speed-slider-label">⚡ Speed</span>
          <span class="speed-value-badge" id="speed-display">0.9×</span>
        </div>
        <input type="range" class="speed-slider" id="speed-slider" min="0.5" max="2.0" step="0.1" value="0.9">
        <div class="speed-emoji-row">
          <span>🐢 0.5×</span>
          <span>🚶 1.0×</span>
          <span>🚀 2.0×</span>
        </div>
      </div>

      <!-- TTS controls — above story so they're always reachable -->
      <div class="tts-controls">
        <button class="btn-main btn-green" id="btn-play">▶ Play</button>
        <button class="btn-main btn-yellow" id="btn-pause" disabled>⏸ Pause</button>
        <button class="btn-main btn-gray" id="btn-stop-tts" disabled>⏹ Stop</button>
      </div>

      <div id="story-info-bar" style="text-align:center;font-size:0.78rem;font-weight:800;color:var(--muted);margin:8px 0 4px;display:none;">
        <span id="story-info-text"></span>
      </div>

      <div class="hint-tip">💡 Tap any word to hear it and learn what it means!</div>

      <div style="text-align:right;margin-bottom:4px;">
        <button class="btn-main btn-outline" id="btn-reading-mode" style="margin:0;padding:8px 16px;font-size:0.82rem;width:auto;display:inline-flex;align-items:center;gap:4px;">📖 Reading Mode</button>
      </div>

      <!-- Story text in scrollable container — keeps auto-scroll contained -->
      <div id="story-scroll-container" style="max-height:50vh;overflow-y:auto;margin:14px 0;scroll-behavior:smooth;overscroll-behavior:contain;">
        <div id="story-text"></div>
      </div>

      <div class="listening-badge" id="listening-badge" style="display:none;"></div>
      <button class="btn-main btn-outline" id="btn-new" style="margin-top:14px;">← Pick New Topic</button>
      <button class="btn-main btn-green" id="btn-finished-reading" style="display:none;margin-top:10px;">✅ I Finished Reading!</button>
    </div>
  </div>

  <!-- SCREEN: Solo complete (reread tracker) -->
  <div class="screen" id="screen-solo-complete">
    <div class="card" style="text-align:center;">
      <div class="card-title" id="solo-complete-title">⭐ Great Reading!</div>
      <div class="encouragement" id="solo-complete-msg" style="margin-bottom:16px;"></div>
      <button class="btn-main btn-green" id="btn-solo-retry" style="font-size:1.1rem;">▶ Read Again</button>
      <button class="btn-main btn-coral" id="btn-solo-wpm" style="margin-top:10px;font-size:1.1rem;">🎤 Read It Myself!</button>
      <button class="btn-main btn-purple" id="btn-solo-wordbank" style="margin-top:10px;font-size:1.1rem;">📖 Word Bank</button>
      <button class="btn-main btn-outline" id="btn-solo-new" style="margin-top:10px;">📚 New Story</button>
    </div>
  </div>

  <!-- SCREEN: Word Bank Review -->
  <div class="screen" id="screen-wordbank">
    <div class="card">
      <div class="card-title">📖 Word Bank</div>
      <p style="color:var(--muted);font-weight:700;font-size:0.88rem;margin-bottom:4px;">Tap any word to hear it and its meaning!</p>
      <div class="encouragement" id="wordbank-count-msg" style="margin-bottom:12px;"></div>
      <div id="wordbank-review-list" style="max-height:50vh;overflow-y:auto;overscroll-behavior:contain;"></div>
      <div id="wordbank-empty" style="display:none;text-align:center;padding:30px 0;">
        <div style="font-size:2.5rem;margin-bottom:8px;">🌟</div>
        <p style="font-weight:800;color:var(--muted);font-size:1rem;">No words yet!</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.85rem;margin-top:4px;">Tap words while reading to add them here.</p>
      </div>
      <button class="btn-main btn-green" id="btn-wordbank-done" style="margin-top:16px;font-size:1.1rem;">✅ Done Reviewing</button>
    </div>
  </div>

  <!-- SCREEN: Spelling Words -->
  <div class="screen" id="screen-spelling">
    <div class="card">
      <div class="spelling-header">
        <div class="card-title">📝 My Spelling Words</div>
        <p style="color:var(--muted);font-weight:700;font-size:0.88rem;">Tap any word to hear it and learn what it means!</p>
        <div class="spelling-week" id="spelling-week-label"></div>
      </div>
      <div class="spelling-count-bar" id="spelling-count-bar" style="display:none;">
        <div><span class="spelling-count-num" id="spelling-word-count">0</span></div>
        <div class="spelling-count-label">spelling words loaded</div>
      </div>
      <div id="spelling-word-list" style="max-height:50vh;overflow-y:auto;overscroll-behavior:contain;"></div>
      <div id="spelling-empty" style="display:none;">
        <div class="spelling-upload-area">
          <div class="spelling-upload-icon">📸</div>
          <div class="spelling-upload-text">No spelling words yet!</div>
          <div class="spelling-upload-hint">Take a photo of your spelling word list<br>and we'll load them right up.</div>
          <button class="btn-main" id="btn-spelling-upload-empty" style="margin-top:18px;font-size:1rem;background:linear-gradient(135deg, #FF8C42, #FF6B6B);box-shadow:0 4px 14px rgba(255,107,107,0.35);">📸 Upload Word List</button>
        </div>
      </div>
      <div id="spelling-loading" class="spelling-loading" style="display:none;">
        <div class="spin-circle" style="margin:0 auto 16px;width:40px;height:40px;border-width:5px;"></div>
        <p style="font-weight:800;color:var(--muted);font-size:1rem;">Reading your spelling words...</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.82rem;margin-top:6px;">This takes just a moment ✨</p>
      </div>
      <div class="spelling-actions" id="spelling-actions" style="display:none;">
        <button class="btn-main" id="btn-spelling-new" style="font-size:0.85rem;background:linear-gradient(135deg, #FF8C42, #FF6B6B);">📸 New</button>
        <button class="btn-main btn-purple" id="btn-spelling-practice" style="font-size:0.85rem;">🎯 Practice</button>
        <button class="btn-main btn-coral" id="btn-spelling-quiz" style="font-size:0.85rem;">📝 Quiz</button>
        <button class="btn-main btn-green" id="btn-spelling-done" style="font-size:0.85rem;">✅ Done</button>
      </div>
    </div>
  </div>

  <!-- SCREEN: Spelling Word Picker -->
  <div class="screen" id="screen-spell-picker">
    <div class="card">
      <div class="card-title">🎯 Which words do you want to practice?</div>
      <p style="color:var(--muted);font-weight:700;font-size:0.88rem;margin-bottom:10px;">Tap words to select them, or grab them all!</p>
      <!-- Select All (left) + Voice picker (right) on one row -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <button class="spell-select-all" id="btn-spell-select-all" style="margin:0;font-size:0.8rem;padding:6px 14px;">Select All</button>
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="font-weight:800;font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Voice:</span>
          <button class="opt-btn spell-voice-btn" data-voice="female" id="spell-voice-female" style="padding:5px 12px;min-width:auto;font-size:0.82rem;margin:0;white-space:nowrap;">👩 Woman</button>
          <button class="opt-btn spell-voice-btn" data-voice="male" id="spell-voice-male" style="padding:5px 12px;min-width:auto;font-size:0.82rem;margin:0;white-space:nowrap;">👨 Man</button>
        </div>
      </div>
      <div id="spell-picker-list" style="max-height:45vh;overflow-y:auto;overscroll-behavior:contain;"></div>
      <div class="spell-picker-bar">
        <div class="spell-picker-count" id="spell-picker-count">0 words selected</div>
        <button class="btn-main btn-green" id="btn-spell-picker-go" style="font-size:1.1rem;" disabled>Let's Go! 🚀</button>
        <button class="btn-main btn-outline" id="btn-spell-picker-back" style="margin-top:8px;font-size:0.9rem;">← Back</button>
      </div>
    </div>
  </div>

  <!-- SCREEN: Spelling Practice (Both Modes) -->
  <div class="screen" id="screen-spell-practice">
    <div class="card">
      <div class="card-title" id="spell-practice-title">🎯 Practice Mode</div>
      <div style="text-align:center;">
        <div class="spell-round-label round-mc" id="spell-round-label">ROUND 1: MULTIPLE CHOICE</div>
      </div>
      <div class="spell-practice-progress">
        <div class="spell-practice-label" id="spell-practice-num">1 / 5</div>
        <div class="spell-practice-bar-wrap"><div class="spell-practice-bar" id="spell-practice-bar" style="width:0%"></div></div>
      </div>
      <div class="spell-practice-prompt">
        <div class="spell-practice-hear" id="spell-practice-hear" title="Tap to hear the word">🔊</div>
        <div class="spell-practice-hint" id="spell-practice-hint">Tap the speaker to hear the word, then pick the right spelling!</div>
      </div>
      <!-- Multiple choice area -->
      <div class="spell-practice-choices" id="spell-practice-choices"></div>
      <!-- Fill-in-the-blank area -->
      <div class="spell-fill-container" id="spell-fill-area" style="display:none;">
        <div class="spell-fill-display" id="spell-fill-display"></div>
        <input type="text" class="spell-fill-input" id="spell-fill-input" placeholder="Type the missing letters..." autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="spell-fill-submit">
          <button class="btn-main btn-green" id="btn-spell-fill-check" style="font-size:1rem;width:auto;padding:12px 30px;">Check ✓</button>
        </div>
      </div>
      <div class="spell-practice-feedback" id="spell-practice-feedback"></div>
    </div>
  </div>

  <!-- SCREEN: Spelling Practice Results -->
  <div class="screen" id="screen-spell-results">
    <div class="card" style="text-align:center;">
      <div class="card-title" id="spell-results-title">🌟 Practice Complete!</div>
      <div class="spell-practice-result">
        <div class="spell-practice-score" id="spell-results-score">0/0</div>
        <div class="spell-practice-score-label">words correct</div>
        <div class="spell-practice-stars" id="spell-results-stars"></div>
      </div>
      <div class="spell-result-list" id="spell-results-list" style="max-height:40vh;overflow-y:auto;overscroll-behavior:contain;"></div>
      <button class="btn-main btn-purple" id="btn-spell-retry-missed" style="font-size:1rem;margin-top:12px;display:none;">🔄 Practice Missed Words</button>
      <button class="btn-main btn-coral" id="btn-spell-take-quiz" style="font-size:1rem;margin-top:10px;">📝 Take Quiz Now</button>
      <button class="btn-main btn-green" id="btn-spell-retry-all" style="font-size:1rem;margin-top:10px;">🎯 Practice Again</button>
      <button class="btn-main btn-outline" id="btn-spell-results-done" style="margin-top:10px;font-size:0.9rem;">← Back to Words</button>
    </div>
  </div>

  <!-- SCREEN: Quiz Countdown -->
  <div class="screen" id="screen-quiz-countdown">
    <div class="card" style="text-align:center;padding:40px 20px;">
      <div class="card-title">📝 Spelling Quiz</div>
      <p style="color:var(--muted);font-weight:700;font-size:0.95rem;margin-bottom:24px;">Get ready to spell!</p>
      <div class="quiz-countdown" id="quiz-countdown-num">3</div>
    </div>
  </div>

  <!-- SCREEN: Quiz (Full Spelling Test) -->
  <div class="screen" id="screen-quiz">
    <div class="card">
      <div class="card-title">📝 Spelling Quiz</div>
      <div class="spell-practice-progress">
        <div class="spell-practice-label" id="quiz-progress-label">1 / 5</div>
        <div class="spell-practice-bar-wrap"><div class="spell-practice-bar" id="quiz-progress-bar" style="width:0%"></div></div>
      </div>
      <div class="spell-practice-prompt">
        <div class="spell-practice-hear" id="quiz-hear" title="Tap to hear the word again">🔊</div>
        <div class="spell-practice-hint" id="quiz-hint">Listen to the word, then spell it!</div>
      </div>
      <div class="quiz-input-wrap">
        <input type="text" class="quiz-input" id="quiz-input" placeholder="Type the word..." autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="quiz-correction" id="quiz-correction" style="display:none;"></div>
      </div>
      <div class="quiz-btn-row">
        <button class="btn-main btn-green" id="btn-quiz-submit" style="font-size:1.05rem;width:auto;padding:14px 36px;">Submit ✓</button>
        <button class="btn-main btn-outline" id="btn-quiz-replay" style="font-size:0.95rem;width:auto;padding:14px 24px;">🔊 Repeat</button>
      </div>
      <div class="spell-practice-feedback" id="quiz-feedback"></div>
    </div>
  </div>

  <!-- SCREEN: Quiz Results -->
  <div class="screen" id="screen-quiz-results">
    <div class="card" style="text-align:center;">
      <div class="card-title" id="quiz-results-title">📝 Quiz Complete!</div>
      <div class="spell-practice-result">
        <div class="spell-practice-score" id="quiz-results-score">0/0</div>
        <div class="spell-practice-score-label">words correct</div>
        <div class="spell-practice-stars" id="quiz-results-stars"></div>
      </div>
      <div class="spell-result-list" id="quiz-results-list" style="max-height:40vh;overflow-y:auto;overscroll-behavior:contain;"></div>
      <button class="btn-main btn-coral" id="btn-quiz-retry-missed" style="font-size:1rem;margin-top:12px;display:none;">🔄 Retry Missed Words</button>
      <button class="btn-main btn-green" id="btn-quiz-retry-all" style="font-size:1rem;margin-top:10px;">📝 Quiz Again</button>
      <button class="btn-main btn-outline" id="btn-quiz-results-done" style="margin-top:10px;font-size:0.9rem;">← Back to Words</button>
    </div>
  </div>

  <!-- SCREEN: WPM Timer (Read It Myself) -->
  <div class="screen" id="screen-wpm-read">
    <div class="card">
      <div class="card-title">🎤 Read It Myself!</div>
      <div class="wpm-timer-bar">
        <div class="wpm-timer-display" id="wpm-timer">0:00</div>
        <div class="wpm-timer-label">⏱ Reading Timer</div>
      </div>
      <div class="encouragement" id="wpm-read-tip">Read the story out loud. Tap "I'm Done!" when you finish.</div>
      <div id="wpm-story-scroll" style="max-height:45vh;overflow-y:auto;margin:14px 0;scroll-behavior:smooth;overscroll-behavior:contain;">
        <div id="wpm-story-text" style="font-size:1.3rem;line-height:2.1rem;color:var(--ink);font-weight:700;"></div>
      </div>
      <button class="btn-main btn-green" id="btn-wpm-done" style="font-size:1.2rem;">✅ I'm Done!</button>
      <button class="btn-main btn-outline" id="btn-wpm-cancel" style="margin-top:10px;">← Go Back</button>
    </div>
  </div>

  <!-- SCREEN: WPM Results -->
  <div class="screen" id="screen-wpm-results">
    <div class="card" style="text-align:center;">
      <div class="card-title">🏆 Your Reading Speed!</div>
      <div class="wpm-result-big" id="wpm-result-number">0</div>
      <div class="wpm-result-unit">Words Per Minute</div>
      <div id="wpm-read-summary" style="font-size:0.92rem;font-weight:800;color:var(--muted);margin-top:6px;"></div>
      <div id="wpm-improvement-badge"></div>
      <div class="wpm-benchmark" id="wpm-benchmark-box">
        <div class="wpm-benchmark-label" id="wpm-benchmark-label">1st Grade Goal</div>
        <div class="wpm-benchmark-range" id="wpm-benchmark-range">53 – 111 WPM</div>
      </div>
      <div class="wpm-history" id="wpm-history-section"></div>
      <button class="btn-main btn-coral" id="btn-wpm-retry" style="font-size:1.1rem;">🎤 Beat My Score!</button>
      <button class="btn-main btn-green" id="btn-wpm-back-complete" style="margin-top:10px;font-size:1.1rem;">✅ Done</button>
    </div>
  </div>

  <!-- SCREEN: Race results -->
  <div class="screen" id="screen-race-results">
    <div class="card" style="text-align:center;">
      <div class="card-title" id="race-result-title">📖 Great Reading Together!</div>
      <div class="encouragement" id="race-msg">You read the whole story as a team!</div>
      <button class="btn-main btn-green" id="btn-race-retry">▶ Read Again Together</button>
      <button class="btn-main btn-outline" id="btn-race-new" style="margin-top:10px;">📚 New Story</button>
    </div>
  </div>
</div>

<footer>
  <strong>ReadUp!</strong> &nbsp;|&nbsp; A Transforming Youth, Inc. Program &nbsp;|&nbsp; Pre-K – 3rd Grade<br>
  <span class="foot-sub">✨ Inspired by Kamryn &amp; Christopher II ✨</span>
</footer>

<!-- Fixed bottom bar for parent access -->
<div class="parent-bar" id="parent-bar">
  <button class="parent-bar-btn" id="btn-open-parent">👤 Parent</button>
  <button class="parent-bar-btn" id="btn-show-welcome">❓ How it works</button>
</div>

<!-- Word saved toast -->
<div class="word-toast" id="word-toast">💾 Word saved!</div>

<!-- Dictionary popup -->
<div class="dict-overlay" id="dict-overlay" style="display:none;">
  <div class="dict-popup">
    <div class="dict-word" id="dict-word"></div>
    <div class="dict-definition" id="dict-definition"></div>
    <button class="dict-speaker-btn" id="dict-hear-btn">🔊 Hear it again</button>
    <button class="dict-close-btn" id="dict-close-btn">✅ Got it!</button>
  </div>
</div>

<!-- SCREEN: Parent PIN -->
<div class="screen" id="screen-pin" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
  <div style="width:100%;max-width:380px;padding:20px;">
    <div class="card">
      <div class="card-title" style="text-align:center;">👤 Parent Access</div>
      <p style="text-align:center;color:var(--muted);font-weight:700;margin-bottom:16px;">Enter your 4-digit PIN</p>
      <div class="pin-display">
        <div class="pin-dot" id="pd0"></div>
        <div class="pin-dot" id="pd1"></div>
        <div class="pin-dot" id="pd2"></div>
        <div class="pin-dot" id="pd3"></div>
      </div>
      <div class="pin-error" id="pin-error"></div>
      <div class="pin-keypad" style="margin-top:16px;">
        <button class="pin-key" data-k="1">1</button>
        <button class="pin-key" data-k="2">2</button>
        <button class="pin-key" data-k="3">3</button>
        <button class="pin-key" data-k="4">4</button>
        <button class="pin-key" data-k="5">5</button>
        <button class="pin-key" data-k="6">6</button>
        <button class="pin-key" data-k="7">7</button>
        <button class="pin-key" data-k="8">8</button>
        <button class="pin-key" data-k="9">9</button>
        <button class="pin-key del" data-k="clear">✕</button>
        <button class="pin-key" data-k="0">0</button>
        <button class="pin-key del" data-k="del">⌫</button>
      </div>
      <button class="btn-main btn-outline" id="btn-pin-cancel" style="margin-top:14px;">Cancel</button>
    </div>
  </div>
</div>

<!-- SCREEN: Parent Dashboard -->
<div class="screen" id="screen-parent" style="display:none;position:fixed;inset:0;z-index:100;background:var(--bg);overflow-y:auto;">
  <div class="app">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:20px 0 10px;">
      <div style="font-family:'Fredoka',sans-serif;font-size:1.5rem;font-weight:700;color:var(--purple-dark);">👤 Parent Dashboard</div>
      <button class="btn-main btn-outline" id="btn-parent-done" style="width:auto;margin-top:0;padding:8px 18px;font-size:0.9rem;">Done</button>
    </div>

    <!-- This Week -->
    <div class="card">
      <div class="dash-section-title">📅 This Week</div>
      <div class="dash-stat-grid">
        <div class="dash-stat"><div class="dash-stat-num" id="week-stories">0</div><div class="dash-stat-label">Stories</div></div>
        <div class="dash-stat"><div class="dash-stat-num" id="week-reads">0</div><div class="dash-stat-label">Total Reads</div></div>
        <div class="dash-stat"><div class="dash-stat-num" id="week-mins">0</div><div class="dash-stat-label">Est. Minutes</div></div>
        <div class="dash-stat"><div class="dash-stat-num" id="week-rereads">0</div><div class="dash-stat-label">3× Stories</div></div>
      </div>
    </div>

    <!-- All Time -->
    <div class="card" style="margin-top:14px;">
      <div class="dash-section-title">🏆 All Time</div>
      <div class="dash-stat-grid">
        <div class="dash-stat"><div class="dash-stat-num" id="all-stories">0</div><div class="dash-stat-label">Stories</div></div>
        <div class="dash-stat"><div class="dash-stat-num" id="all-reads">0</div><div class="dash-stat-label">Total Reads</div></div>
        <div class="dash-stat"><div class="dash-stat-num" id="all-mins">0</div><div class="dash-stat-label">Est. Minutes</div></div>
        <div class="dash-stat"><div class="dash-stat-num" id="all-rereads">0</div><div class="dash-stat-label">3× Stories</div></div>
      </div>
      <div style="text-align:center;font-size:0.78rem;color:var(--muted);font-weight:700;margin-top:4px;" id="first-used-label"></div>
    </div>

    <!-- Favorite Topics -->
    <div class="card" style="margin-top:14px;">
      <div class="dash-section-title">❤️ Favorite Topics</div>
      <div id="topic-bars"></div>
    </div>

    <!-- Reading Speed (WPM) -->
    <div class="card" style="margin-top:14px;">
      <div class="dash-section-title">⚡ Reading Speed</div>
      <div id="dash-wpm-content"></div>
    </div>

    <!-- Word Bank -->
    <div class="card" style="margin-top:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="dash-section-title" style="margin:0;">📖 Word Bank</div>
        <button class="btn-main btn-outline" id="btn-clear-words" style="width:auto;margin-top:0;padding:6px 14px;font-size:0.8rem;">Clear</button>
      </div>
      <p style="font-size:0.78rem;color:var(--muted);font-weight:700;margin:6px 0 10px;">Words your child needed help with. 🔴 = needs more practice.</p>
      <div class="word-bank-list" id="word-bank-display"></div>
    </div>

    <!-- Spelling Words -->
    <div class="card" style="margin-top:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="dash-section-title" style="margin:0;">📝 Spelling Words</div>
        <button class="btn-main btn-outline" id="btn-clear-spelling" style="width:auto;margin-top:0;padding:6px 14px;font-size:0.8rem;">Clear</button>
      </div>
      <div id="dash-spelling-content">
        <p style="font-size:0.78rem;color:var(--muted);font-weight:700;margin:6px 0 10px;">No spelling lists uploaded yet.</p>
      </div>
    </div>

    <!-- Settings -->
    <div class="card" style="margin-top:14px;">
      <div class="dash-section-title">⚙️ Settings</div>
      <p style="font-size:0.82rem;color:var(--muted);font-weight:700;margin-bottom:8px;">Change PIN:</p>
      <div class="change-pin-row">
        <input type="password" id="new-pin-input" maxlength="4" placeholder="New PIN" inputmode="numeric">
        <button class="btn-main btn-green" id="btn-save-pin" style="width:auto;margin-top:0;padding:10px 18px;font-size:0.9rem;">Save</button>
      </div>
      <div id="pin-save-msg" style="font-size:0.82rem;color:var(--green);font-weight:800;min-height:1.2em;margin-top:6px;"></div>
      <button class="btn-main btn-danger" id="btn-reset-data" style="margin-top:16px;">🗑️ Reset All Data</button>
    </div>
    <div style="height:40px;"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseApp = initializeApp({
  apiKey: "AIzaSyCIiKxtE5YV8GV0Fk3HEAO46rEGKEuFfFc",
  authDomain: "readup-transforming-youth.firebaseapp.com",
  databaseURL: "https://readup-transforming-youth-default-rtdb.firebaseio.com",
  projectId: "readup-transforming-youth",
  storageBucket: "readup-transforming-youth.firebasestorage.app",
  messagingSenderId: "394068331923",
  appId: "1:394068331923:web:d00704316cf6ba4b002c66"
});
const db = getDatabase(firebaseApp);

const CF_BASE = "https://us-central1-readup-transforming-youth.cloudfunctions.net";
const CF_STORY = `${CF_BASE}/generateStory`;
const CF_TTS   = `${CF_BASE}/synthesizeSpeech`;
const CF_STT   = `${CF_BASE}/transcribeSpeech`;
const CF_OCR   = `${CF_BASE}/extractText`;
const CF_SPELLING = `${CF_BASE}/extractSpellingWords`;
const CF_BATCH_DEF = `${CF_BASE}/batchDefine`;

// ── AI Story Generation ───────────────────────────────────
async function generateAIStory(grade, category, wordTarget) {
  const gradeNames = { "prek": "Pre-K", "k": "Kindergarten", "1": "1st", "2": "2nd", "3": "3rd" };

  // Friendly topic names for titles and prompts
  const topicNames = {
    animals: "Animals", space: "Space", dinosaurs: "Dinosaurs", ocean: "Ocean",
    superheroes: "Superheroes", magic: "Magic", sports: "Sports", cooking: "Cooking",
    friends: "Friends", confidence: "Self-Confidence", blackhistory: "Black History Heroes",
    helpers: "Community Helpers", nature: "Nature & Weather", emotions: "Feelings & Emotions",
    trucks: "Trucks & Vehicles", princesses: "Princesses & Castles", robots: "Robots",
    pirates: "Pirates", airplanes: "Airplanes & Flying"
  };
  const topicLabel = topicNames[category] || category;

  // Topic-specific anchor for Pre-K/K so the AI doesn't drift
  const topicAnchors = {
    animals: "Use animals like a dog, cat, bird, or fish as the main characters.",
    space: "Use the sun, moon, and stars as the main focus.",
    dinosaurs: "Use a big friendly dinosaur as the main character.",
    ocean: "Use a fish, wave, or crab as the main focus.",
    superheroes: "Use a kind hero who helps people as the main character.",
    magic: "Use a magic wand or a star that grants wishes.",
    sports: "Use running, jumping, or throwing a ball as the main activity.",
    cooking: "Use making food like soup or a sandwich as the main activity.",
    friends: "Use two children who play together as the main characters.",
    confidence: "Use a child who tries something new and feels proud.",
    blackhistory: (() => {
      const heroes = [
        { name: "Ruby Bridges", deed: "was the first Black child to go to an all-white school and was very brave" },
        { name: "Rosa Parks", deed: "said no when told to give up her seat on the bus and stood up for what was right" },
        { name: "Mae Jemison", deed: "became the first Black woman to travel to space" },
        { name: "Jackie Robinson", deed: "was the first Black player in Major League Baseball and never gave up" },
        { name: "Harriet Tubman", deed: "helped hundreds of people find freedom and was very courageous" },
        { name: "Martin Luther King Jr.", deed: "taught people to be kind and fair to everyone and had a big dream" },
        { name: "Katherine Johnson", deed: "was so good at math that she helped send astronauts to space" },
        { name: "George Washington Carver", deed: "was a scientist who discovered amazing things you can make from peanuts" },
        { name: "Bessie Coleman", deed: "was the first Black woman to earn a pilot's license and fly airplanes" },
        { name: "Barack Obama", deed: "became the first Black president of the United States" },
        { name: "Malcolm X", deed: "was a powerful speaker who fought for fairness and equal rights for Black people" }
      ];
      const hero = heroes[Math.floor(Math.random() * heroes.length)];
      return `Write about a real Black history hero named ${hero.name} who ${hero.deed}. Use their real name.`;
    })(),
    helpers: "Use a firefighter, doctor, or teacher as the main character.",
    nature: "Use the sun, rain, or a tree as the main focus.",
    emotions: "Use a child who feels happy, sad, or brave.",
    trucks: "Use a big truck, fire engine, or race car as the main focus.",
    princesses: "Use a brave princess or prince in a castle as the main character.",
    robots: "Use a friendly robot who helps or learns as the main character.",
    pirates: "Use a pirate on a ship looking for treasure as the main character.",
    airplanes: "Use an airplane, pilot, or flying adventure as the main focus."
  };
  const topicAnchor = topicAnchors[category] || `Write about ${topicLabel}.`;

  const gradeInstructions = {
    "prek": `You are writing for a 3-4 year old child learning to read. Topic: ${topicLabel}. ${topicAnchor}

STRICT RULES:
- Every sentence must be 3-5 words MAXIMUM
- Use ONLY simple one-syllable words: big, run, sit, red, the, is, a, I, my, see, like, can, we, it, go, up, on, fun, hop, hot, has, his, her, they, are, said, good, love, help, kind, brave
- Use repetitive sentence patterns: "She is brave. She is kind. She is good."
- NO complex ideas, NO multi-syllable words except names
- End with: "Think about it: What do you see?"
Write exactly ${wordTarget} words.`,

    "k": `You are writing for a 5-6 year old kindergartner. Topic: ${topicLabel}. ${topicAnchor}

STRICT RULES:
- Sentences must be 5-8 words maximum
- Use simple common words only — no words longer than 2 syllables
- Short paragraphs of 2-3 sentences
- Keep the topic clearly present throughout the story
- End with a simple question: "Think about it: What would you do?"
Write exactly ${wordTarget} words.`,

    "1": `Use very simple words a 6-7 year old knows. Write about ${topicLabel}. Write in short natural sentences that flow into paragraphs. Tell a simple story with a clear beginning, middle, and end. Make it warm, fun, and easy to follow. Do NOT use bullet points or lists. End with one "Think about it:" question.`,
    "2": `Use simple but varied vocabulary for a 7-8 year old. Write about ${topicLabel}. Write in flowing paragraphs with sentences of different lengths. Include some description and feeling. Do NOT use bullet points or lists. End with one "Think about it:" question.`,
    "3": `Use grade-appropriate vocabulary for an 8-9 year old. Write about ${topicLabel}. Write in natural paragraphs with varied sentence structure. Include interesting details and a clear message. Do NOT use bullet points or lists. End with one "Think about it:" question.`
  };

  const instructions = gradeInstructions[grade] || gradeInstructions["1"];
  const fullPrompt = (grade === 'prek' || grade === 'k')
    ? `${instructions}`
    : `Write a story about ${topicLabel} that is approximately ${wordTarget} words long. Do NOT include a title, heading, or label before the story. Start immediately with the first word. Use natural paragraph breaks every 3-5 sentences. Do not use markdown formatting.\n\n${instructions}`;

  const response = await fetch(CF_STORY, {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      grade: gradeNames[grade] || grade,
      topic: category,
      wordCount: wordTarget,
      instructions: fullPrompt
    })
  });
  if (!response.ok) throw new Error("Cloud function error: " + response.status);
  const data = await response.json();
  if (!data.story) throw new Error("No story in response");
  return data.story;
}

// ── Fallback stories ──────────────────────────────────────
const STORIES = {
  animals:{1:[{words:50,title:"Max the Dog",body:"Max is a big brown dog. He loves to run and jump. Every day Max plays in the yard. He barks at birds and chases cats. Max has a red ball. It is his best toy. At night Max sleeps by the door. He is a good dog. Think about it: What is your favorite animal?"},{words:100,title:"The Little Cat",body:"Luna is a small gray cat. She lives in a big yellow house. Every morning Luna wakes up and stretches her legs. She walks to her bowl and eats her food. Then she sits by the window. Luna loves to watch the birds outside. She makes a funny sound when she sees them. In the afternoon Luna takes a long nap on the soft couch. She curls up into a ball and purrs. At night she sleeps with her family. They love her very much. Luna is a happy cat. Think about it: What do you think Luna dreams about?"}],2:[{words:100,title:"Ella the Elephant",body:"Ella was the youngest elephant in the herd. She had giant ears that flopped when she walked. The other elephants said her ears were too big, but Ella did not mind. One hot afternoon the herd got lost in the tall grass. Ella lifted her huge ears and listened carefully. She heard the river far away. She led everyone straight to the cool water. The herd splashed and played until sunset. From that day on, everyone agreed that Ella's ears were the best ears in the whole savanna. Think about it: How can something you feel different about become your greatest strength?"}],3:[{words:150,title:"Ocean Giants",body:"Blue whales are the largest animals ever known to have lived on Earth. A single blue whale can grow longer than three school buses lined up end to end. Their hearts are so large a small child could crawl through the arteries. Yet despite their enormous size, blue whales eat some of the tiniest creatures in the ocean. They feed almost entirely on krill, small shrimp-like animals no bigger than your finger. A blue whale must eat up to four tons of krill every single day just to survive. Blue whales were once nearly hunted to extinction, but international protection has helped their numbers slowly recover. Think about it: What does the blue whale teach us about how big and small things depend on each other?"}]},
  space:{1:[{words:50,title:"A Trip to the Moon",body:"Sam wants to go to the moon. The moon is very far away. You need a big rocket to get there. The rocket goes up, up, up into the dark sky. The moon has no air and no trees. It is cold and gray. But the view of Earth is amazing from up there. Think about it: Would you want to visit the moon?"}],2:[{words:100,title:"Mars, Our Red Neighbor",body:"Mars is the fourth planet from the sun and our closest planetary neighbor. It looks red because its soil is full of iron oxide, which is basically rust. Mars has the tallest volcano in our entire solar system called Olympus Mons. It is three times the height of Mount Everest. Scientists have sent robotic rovers to explore Mars. These rovers drive slowly across the rocky surface, taking photos and testing soil. They have found signs that water once flowed on Mars billions of years ago. Think about it: What would be the hardest part about living on Mars?"}],3:[{words:150,title:"Black Holes",body:"A black hole is one of the strangest objects in the universe. It forms when a massive star runs out of fuel and collapses under its own gravity. The collapse creates a point of such extreme density that nothing, not even light, can escape its gravitational pull. In 2019, a global team of astronomers captured the first actual image of a black hole. It required linking radio telescopes across multiple continents to create a lens the size of Earth. The image showed a glowing ring of superheated gas surrounding a dark center. Think about it: Why do you think capturing an image of something invisible required such a massive worldwide effort?"}]},
  dinosaurs:{1:[{words:50,title:"Big Rex",body:"Rex is a big dinosaur. He has sharp teeth and tiny arms. Rex walks on two strong legs. He roars very loud. All the other dinosaurs run away. Rex is the king of the land. At night Rex looks at the stars. He wonders what they are. Rex is big but he can dream small dreams. Think about it: What would you do if you met a T-Rex?"},{words:100,title:"Dino Friends",body:"Tara the triceratops had three horns on her head. Bron the brontosaurus had a very long neck. They were best friends even though they looked very different. Every day they ate plants by the river. Tara used her horns to break tough branches. Bron used her long neck to reach the tallest leaves. They always shared their food. One afternoon a loud roar shook the ground. A big meat eater was coming their way. Tara lowered her horns and stomped her feet. The big dinosaur ran away. Think about it: How did Tara and Bron help each other?"}],2:[{words:100,title:"The Last Egg",body:"Deep in a muddy nest, one egg remained long after the others had hatched. The mother had stopped coming back. The sun warmed the egg each day until finally a crack appeared. A small raptor pushed its way out into a noisy world. Everything was enormous and strange. The little raptor was alone but not afraid. It had hatched with sharp instincts. By nightfall it had found water and shelter under a fallen tree. Scientists who study dinosaur fossils believe many young dinosaurs hatched this way, surviving on instinct from their very first breath. Think about it: What instincts do you think humans are born with?"}],3:[{words:150,title:"The Day the Sky Went Dark",body:"Sixty-six million years ago, a rock from space about six miles wide slammed into what is now Mexico. The impact released more energy than every nuclear weapon on Earth combined. The explosion sent billions of tons of dust and ash into the atmosphere. Within weeks the sky went dark across the entire planet. Without sunlight, temperatures plummeted and plants began to die. About three quarters of all species on Earth went extinct. But small mammals survived in burrows underground. From those survivors, all the mammals alive today eventually evolved. The extinction was an ending, but it was also a beginning. Think about it: How does this story change the way you think about disasters?"}]},
  ocean:{1:[{words:50,title:"Under the Sea",body:"The ocean is very deep and blue. Many fish live there. Some fish are big. Some fish are tiny. Coral looks like a rainbow under the water. Sea turtles swim slowly past. A dolphin jumps high into the air. The ocean is full of life. We must keep it clean. Think about it: What ocean animal would you like to swim with?"}],2:[{words:100,title:"The Deep Dark Zone",body:"Most of the ocean is completely dark. Sunlight only reaches the top few hundred feet of water. Below that is absolute darkness for miles. Scientists used to think nothing could live there. They were very wrong. Strange glowing creatures drift through the deep ocean. The anglerfish has a built-in light on its head to lure prey. Tube worms grow near volcanic vents on the ocean floor, surviving without any sunlight at all. We have explored less than twenty percent of the deep ocean. Think about it: Why do you think we know so little about the deep ocean?"}],3:[{words:150,title:"Coral Reefs in Danger",body:"Coral reefs cover less than one percent of the ocean floor, yet they support about twenty-five percent of all marine species. They are among the most biodiverse ecosystems on Earth. But coral reefs around the world are in serious trouble. Rising ocean temperatures cause bleaching, where corals expel the algae that give them color and nutrition. Without those algae, corals turn white and can die within weeks. Some researchers are now experimenting with growing heat-resistant coral in labs and replanting them on damaged reefs. Once a reef ecosystem collapses, recovery takes decades if it happens at all. Think about it: What do you think individuals can do to help protect coral reefs, even from far away?"}]},
  superheroes:{1:[{words:50,title:"Zoom the Superhero",body:"Zoom can fly very fast. He wears a blue cape. When someone needs help Zoom zooms to the rescue. He helps cats stuck in trees. He helps people cross the street. Zoom is kind to everyone. He says being a hero means helping others. You do not need powers to be a hero. Think about it: How can you be a hero today?"},{words:100,title:"Maya Saves the Day",body:"Maya had a special power. She could talk to animals. One afternoon a little dog got lost in the park. It was whimpering under a bush. Maya crouched down and spoke softly. The dog told her he had followed a butterfly and got confused. Maya asked a sparrow to fly ahead and find the dog's house. Then she followed the sparrow with the dog trotting beside her. Three blocks away a girl was crying on her porch. The dog barked and ran to her. Maya smiled all the way home. Think about it: If you could talk to any animal what would you ask it?"}],2:[{words:100,title:"The Hero Without Powers",body:"Everyone at River City Elementary knew about the superhero league. Marcus could not fly or bend steel or move at super speed. But Marcus noticed things others missed. He noticed when someone was sitting alone at lunch. He noticed when the new kid looked confused in the hallway. He noticed when the quiet girl in math class got the right answer but was too shy to raise her hand. Marcus told her she was right. She started raising her hand after that. By the end of the year Marcus had the most friends of anyone. Think about it: What superpower does Marcus actually have?"}],3:[{words:150,title:"The Weight of the Mask",body:"Priya had been able to generate force fields since she was nine years old. She had trained for years and genuinely wanted to help people. But nobody warned her about the interviews. After her first public rescue, reporters crowded around asking questions. Priya had only thought about the people trapped on the bridge. That night she realized that being a hero in public was completely different from the private moment of helping someone. One felt like herself. The other felt like a performance. She decided she would keep her mask on, not to hide, but to protect the quiet version of herself that actually cared. Think about it: Why might it be important to protect your private self even when you do something publicly?"}]},
  magic:{1:[{words:50,title:"The Magic Door",body:"There was a little door in the back of the garden. No one had opened it in years. One day Lily found the key. She turned it slowly. The door opened to a land of flying horses and talking trees. A tiny dragon sat on a mushroom. It smiled at her. Lily smiled back. She knew she had found something wonderful. Think about it: What would be behind your magic door?"},{words:100,title:"Pip the Small Wizard",body:"Pip wanted to be a wizard more than anything. But his spells never worked right. His fire spell made snow. His flying spell made worms float. The other students laughed but Pip kept trying. One day a storm trapped everyone in the castle. All the big wizards tried to clear it but could not. Pip raised his wand and thought of warmth. Out came a giant rainbow that reached across the sky. The clouds parted and sunshine poured in. Sometimes the wrong spell is exactly the right one. Think about it: Why might making mistakes be part of learning?"}],2:[{words:100,title:"The Girl Who Collected Wishes",body:"Every time someone in the village made a wish and forgot about it, the wish floated away as a tiny glowing seed. Most people never noticed. But Rosa could see them. She had been collecting wishes in a glass jar since she was small. One winter the river froze and the village ran out of food. Rosa opened her jar and let all the wishes go at once. They rose in a swirling cloud of light. By morning the snow had melted from the southern fields and early vegetables had pushed through the soil. Think about it: What wish would you put in Rosa's jar?"}],3:[{words:150,title:"The Last Cartographer",body:"In a kingdom where magic had faded, one old woman still made maps that worked. Not road maps, but maps of people. She could trace the invisible lines that connected a person to their fears, their hopes, and the places that had shaped them. She only drew maps for those who truly wanted to understand themselves. Her last visitor was a young girl who had lost her voice in an accident and could no longer tell her own story. The cartographer spent three days mapping her. When she unrolled the finished parchment, the girl stared at it for a long time. Then she picked up a pen and began to write. Think about it: What would your personal map show about who you are?"}]},
  sports:{1:[{words:50,title:"The Big Game",body:"Today is the big soccer game. Mia is nervous. Her legs feel like jelly. Coach says just do your best. In the second half Mia gets the ball. She runs fast. She kicks hard. Goal! Her team cheers. Mia laughs. Nerves are gone now. She just loves to play. Think about it: How do you feel before something important?"},{words:100,title:"Learning to Swim",body:"Jordan did not like putting his face in the water. Every swim lesson he stood at the edge of the pool and watched the other kids. His teacher Miss Rosa never pushed him. She just showed him again and again. One day Jordan held his nose and went under for one second. Then two. Then five. By the end of summer he could swim across the whole pool. He looked at the pool that had scared him so much. It looked smaller now. Not because it had changed but because he had. Think about it: What is something that felt scary until you tried it?"}],2:[{words:100,title:"The Fastest Kid",body:"Everyone said Leo was the fastest kid at Riverside Elementary. He had never lost a race. On field day he lined up for the fifty meter sprint with total confidence. But when he crossed the line he heard cheering that was not for him. A new girl named Amara had crossed a full second ahead. Leo walked over and held out his hand. That was fast, he said. She grinned. Want to train together? Leo said yes immediately. Think about it: How did losing change Leo's life for the better?"}],3:[{words:150,title:"The Mental Game",body:"Elite athletes often say that ninety percent of their sport is mental. Physical talent reaches a ceiling. At the highest levels of competition, almost everyone is physically capable. The athletes who win consistently manage pressure better and recover from mistakes faster. Visualization is one of the most powerful tools athletes use. Before a competition, many close their eyes and mentally rehearse every moment. Research shows this actually activates the same neural pathways as physically practicing the skill. Basketball players who only visualized free throws for a month improved almost as much as those who physically practiced every day. Think about it: How could you use visualization in your own life outside of sports?"}]},
  cooking:{1:[{words:50,title:"Making Pancakes",body:"Sam helps mom make pancakes. First they mix the batter. It is lumpy and white. Then mom pours it on the hot pan. It sizzles and bubbles. When the bubbles pop it is time to flip. Sam wants to try. He flips it perfectly. The pancake is round and golden. They put butter and syrup on top. It is the best breakfast ever. Think about it: What is your favorite food to make?"},{words:100,title:"Grandma's Secret Recipe",body:"Every Sunday Grandma made her special tomato soup. The whole house smelled amazing. One day she let Nora help. First they cut the tomatoes into small pieces. Then they cooked onions in butter until they were soft and golden. They added the tomatoes and a cup of broth and let it simmer slowly. When the soup was done she let Nora taste it. It was the most delicious thing Nora had ever eaten. Grandma smiled. Now you know the secret, she said. The secret is time and love. Think about it: What recipe would you want to pass down someday?"}],2:[{words:100,title:"The Science of Bread",body:"Baking bread seems like cooking but it is really more like science. When you mix flour, water, and yeast together, something invisible begins to happen. Yeast is a tiny living organism. It eats the sugars in the flour and releases carbon dioxide gas. That gas gets trapped in the sticky dough, forming thousands of tiny bubbles. As the dough sits in a warm place, the yeast keeps eating and the bubbles multiply. The dough rises and nearly doubles in size. When you put it in the hot oven, the heat kills the yeast and bakes the bubbles into the bread's soft spongy structure. Think about it: What other foods do you think involve living organisms?"}],3:[{words:150,title:"Food as Culture",body:"Every culture on Earth has developed its own cuisine, and those foods carry more history than most people realize. Spices that seem ordinary today were once so rare and valuable they launched wars and funded empires. Chili peppers originated in the Americas and only reached Asia and Europe after 1492, yet today they are central to the cuisines of India, Thailand, and China. Tomatoes, also native to the Americas, became the foundation of Italian cooking within two hundred years of arriving in Europe. Food travels with people and adapts to new environments. When you eat a dish from another culture, you are tasting centuries of human movement, trade, and creativity. Think about it: What does your favorite food tell you about where it came from?"}]},
  friendship:{1:[{words:50,title:"My Best Friend",body:"My best friend is named Jay. We like the same things. We both love dogs and pizza. Jay makes me laugh every day. When I am sad Jay sits with me. When Jay is scared I hold his hand. That is what friends do. Friends make every day better. I am glad Jay is my friend. Think about it: What makes someone a good friend?"},{words:100,title:"The New Kid",body:"On Monday a new girl came to class. Her name was Zoe. She sat alone at lunch with her tray and looked at the table. Everyone else was already talking with their friends. Kira noticed. She picked up her lunch and walked over. Can I sit here? she asked. Zoe looked up surprised. Yes please, she said quietly. They talked the whole lunch. Zoe was funny and liked the same books as Kira. By Friday they were walking to school together every morning. Think about it: Have you ever been the new kid or sat with someone who was?"}],2:[{words:100,title:"The Argument",body:"Diego and Sam had been best friends since kindergarten. But in fourth grade they had their first real fight. It started over something small and grew into something bigger until they stopped talking completely. For two weeks they sat on opposite sides of the classroom. One afternoon it rained and they both took shelter in the same doorway. They stood there awkwardly. Then Diego laughed a little. Sam laughed too. By the time the rain stopped they had been talking for twenty minutes. Some friendships are strong enough to survive the silences. Think about it: What do you think made it easier for them to make up?"}],3:[{words:150,title:"The Loyalty Question",body:"There is an old idea that loyalty means always defending your friend no matter what. But some of the most important thinkers in history have argued the opposite. True loyalty means telling your friend the truth even when it is uncomfortable. It means caring more about who they become than about keeping things easy between you. The friendships that last decades are rarely the ones built on constant agreement. They are built on trust that runs deep enough to survive honest conversations. People who have friends willing to challenge them tend to make better decisions over time. There is a difference between a friend who makes you feel good and a friend who helps you be good. Think about it: Can you think of a time when a friend told you something hard to hear that turned out to be important?"}]},
  confidence:{1:[{words:50,title:"I Can Do It",body:"Mia was scared to read out loud. Her hands shook. Her voice was small. Her teacher smiled and said try. Mia took a breath. She read one word. Then two. Then the whole sentence. The class clapped. Mia smiled so big. She did not think she could. But she did. That feeling inside was called confidence. Think about it: What is something you were scared to try but did anyway?"},{words:100,title:"The Spelling Bee",body:"Jordan had practiced every night for two weeks. On the morning of the spelling bee his stomach felt like it was full of jumping frogs. He almost told his mom he was sick. But he went anyway. When his turn came his knees felt weak. He closed his eyes and thought of all those nights practicing at the kitchen table. He took one slow breath. Then he spelled the word perfectly. It did not matter that he did not win the whole competition. What mattered was that he showed up and tried his very best. Think about it: What do you do when you feel nervous about something important?"}],2:[{words:100,title:"The Mirror Talk",body:"Coach Rivera taught her team something unusual before every game. She made them stand in front of a mirror and say three things they were good at out loud. At first the kids laughed and felt embarrassed. But Coach Rivera said confidence is a skill you practice, not something you are born with. After a month the team noticed something. They were not just saying the words anymore. They actually believed them. Their grades improved too. Scientists who study the brain have found that what we say to ourselves every day actually shapes how we see the world. Think about it: What three things would you say to yourself in the mirror?"}],3:[{words:150,title:"The Voice Inside",body:"Every person carries two voices inside their head. One voice says you are not good enough, you will fail, people will laugh. The other voice says you have done hard things before, you are prepared, you can handle whatever happens. Psychologists call the first voice the inner critic and the second the inner coach. Most people let the inner critic run the show without even realizing it. The good news is that the inner coach can be trained. Athletes, performers, and leaders across history have used this deliberately. They wrote down their fears, examined whether those fears were based on facts, and replaced them with more accurate and helpful thoughts. The skill is not pretending the fear does not exist. It is learning to take action anyway. Think about it: Which voice do you listen to most, and what would happen if you practiced listening to the other one?"}]},
  blackhistory:{1:[{words:50,title:"Rosa Would Not Move",body:"Rosa Parks was tired after a long day of work. She sat on the bus. A man told her to give up her seat. Rosa said no. That one word changed history. People stopped riding the buses to protest. They walked for over a year. Their courage helped change unfair laws. Rosa was brave even when it was hard. Think about it: Have you ever stood up for something you knew was right?"},{words:100,title:"Mae Jemison Reached the Stars",body:"Mae Jemison loved science and dance from the time she was small. Her teachers did not always believe a Black girl from Chicago could become an astronaut. But Mae never stopped studying and never stopped dreaming. She became a doctor first. Then she applied to NASA. On September 12th 1992 Mae Jemison became the first African American woman to travel to space. She carried a photo of Bessie Coleman, the first Black female pilot, with her into orbit. Mae later said that the stars belong to everyone who dares to look up. Think about it: What dream are you working toward even when others doubt you?"}],2:[{words:100,title:"The Boy Who Changed Lighting",body:"Lewis Latimer was born to parents who had escaped slavery. He taught himself engineering by reading books at night after long days of work. When Alexander Graham Bell needed drawings for the telephone patent, Latimer did them. Then he turned his attention to the electric light bulb. At the time bulbs burned out within days. Latimer invented a carbon filament that made bulbs last much longer and cost far less. His invention made electric light available to ordinary families for the first time. His name is rarely in textbooks, but his work lights up every room you have ever sat in. Think about it: Why do you think some inventors become famous while others are forgotten?"}],3:[{words:150,title:"The Blood Bank and the Man Who Built It",body:"During World War II soldiers were dying not from bullets but from blood loss, because there was no organized system to store and deliver blood. Dr. Charles Drew, a Black surgeon from Washington D.C., solved this problem. He developed the techniques for separating and preserving blood plasma that made blood banking possible. His system saved tens of thousands of lives. The painful irony is that the American Red Cross, using his own methods, initially refused to accept blood donations from Black Americans. Dr. Drew protested loudly and publicly. He continued his medical work and his advocacy until his death in 1950. Today his methods remain the foundation of every blood bank in the world. Think about it: What does Dr. Drew's story teach us about the relationship between injustice and the people who work to overcome it?"}]},
  helpers:{1:[{words:50,title:"Firefighters Are Heroes",body:"Sam hears the fire truck go by. The siren is very loud. Firefighters wear big heavy coats and helmets. They carry hoses full of water. When there is a fire they run toward it not away. That takes a lot of courage. Firefighters also help when cars crash or people get hurt. They work all day and all night to keep us safe. Think about it: What would you say to a firefighter if you met one?"},{words:100,title:"Dr. Chen Saves the Day",body:"Every morning Dr. Chen put on her white coat and walked into the children's hospital. She saw kids who were scared and parents who were worried. Dr. Chen always started by listening. She asked questions, looked at charts, and thought carefully before she spoke. One afternoon a boy named Marco came in with a very high fever. Dr. Chen ran tests quickly and found an infection that needed medicine right away. By the next morning Marco was sitting up and asking for orange juice. Dr. Chen smiled. Helping people feel better was the best part of her whole day. Think about it: Have you ever had someone help you feel better when you were sick?"}],2:[{words:100,title:"The Teacher Who Never Gave Up",body:"Mr. Osei taught third grade for twenty-two years. His classroom walls were covered in student drawings and poems and science projects. Every year he got a new group of kids who were all different. Some learned fast. Some needed more time. Some came to school hungry or sad. Mr. Osei kept folders on every student so he could remember exactly what each one needed. He stayed late on Tuesdays to help anyone who wanted extra practice. Three of his former students later became teachers themselves. They all said the same thing. Mr. Osei made them feel like they mattered. Think about it: What has a teacher done that made a difference for you?"}],3:[{words:150,title:"The 911 Dispatcher Nobody Sees",body:"When someone calls 911 they usually think about the police car or ambulance arriving. Almost nobody thinks about the dispatcher who answered the phone. Dispatchers work in windowless rooms staring at screens, managing multiple emergencies at once while staying calm enough to guide frightened people through the worst moments of their lives. They tell parents how to do CPR on their children while paramedics are on the way. They talk people through fires and keep witnesses calm at accident scenes. The average dispatcher handles hundreds of calls each shift. They receive no medals and rarely appear in news stories. But emergency workers say that a skilled dispatcher often determines whether someone lives or dies before help ever arrives. Think about it: What does this tell us about the kinds of work our society tends to value and celebrate?"}]},
  nature:{1:[{words:50,title:"The Thunderstorm",body:"Dark clouds rolled in fast. The wind bent the trees. Then came the thunder, so loud it shook the windows. Lightning flashed across the sky. The rain came down in thick heavy sheets. Then slowly it stopped. The sun came back out. A rainbow stretched over the whole neighborhood. After every storm comes something beautiful. Think about it: How do you feel during a big storm?"},{words:100,title:"How Seeds Travel",body:"A dandelion puff floats on the wind. A coconut falls in the ocean and floats to a faraway beach. A berry gets eaten by a bird and dropped miles away. Seeds are travelers. They have been moving across the Earth for millions of years without maps or plans. Some seeds have tiny hooks that grab onto animal fur. Others spin like helicopters as they fall. Some need to pass through an animal's stomach before they can sprout. Every plant you have ever seen began as a seed that found its way to exactly the right spot. Think about it: How do you think seeds knew how to do all of this before anyone taught them?"}],2:[{words:100,title:"The Water Cycle Never Stops",body:"The same water that dinosaurs drank still exists on Earth today. Water never disappears. It only changes form. When the sun heats a lake, water turns into invisible vapor and floats into the sky. High up where the air is cold it condenses into clouds. When clouds collect enough droplets it rains or snows. The water runs into rivers and soaks into the ground and eventually finds its way back to the ocean or a lake. Then the whole cycle begins again. Scientists estimate that every glass of water you drink contains molecules that have been part of this cycle for over four billion years. Think about it: What does it mean that we share our water with every living thing that has ever existed?"}],3:[{words:150,title:"Why Forests Make Rain",body:"Most people know that rain waters forests. Fewer people know that forests also make rain. Trees pull water from deep in the soil through their roots and release it through their leaves as vapor in a process called transpiration. The Amazon rainforest releases so much moisture this way that it creates what scientists call flying rivers. These invisible rivers of water vapor move through the atmosphere for thousands of miles and eventually fall as rain over farmland across South America. When large sections of the Amazon are cut down, rainfall patterns change across the entire continent. Crops fail in places that have never been touched by a chainsaw. This is how connected ecosystems are. A tree falling in Brazil can affect a farm in Argentina. Think about it: What does this teach us about the idea that what we do in one place does not affect anywhere else?"}]},
  emotions:{1:[{words:50,title:"All Feelings Are Okay",body:"Sometimes Jaylen feels mad. Sometimes he feels sad. Sometimes he feels scared or worried. His grandma says every feeling has a name and every feeling is okay. Mad means something feels unfair. Sad means you lost something you loved. Scared means your body is trying to keep you safe. Feelings are not problems to fix. They are messages to listen to. Think about it: What feeling do you have trouble talking about?"},{words:100,title:"The Worry Jar",body:"Sofia had so many worries that they kept her awake at night. She worried about tests. She worried about her dad's new job. She worried about her best friend moving away. Her mom gave her a small glass jar and some slips of paper. Every night before bed Sofia wrote each worry on a slip and put it in the jar. Then she closed the lid. Mom said the worries are real but they do not have to live in your head all night. They can wait in the jar until morning. Some mornings Sofia opened the jar and the worries seemed smaller somehow. Think about it: What do you do with your worries before you go to sleep?"}],2:[{words:100,title:"Reading the Room",body:"Emotional intelligence is a phrase that means being aware of your own feelings and understanding the feelings of people around you. Researchers have found that people with high emotional intelligence tend to have stronger friendships, do better in school, and handle stressful situations more effectively. The ability to read a room, to notice when someone is upset before they say anything, is a skill that can be practiced. It starts with paying attention. What is the person's face doing? How are they holding their body? Has their voice changed? These details tell a story. People who are truly good listeners know that much of what someone says has nothing to do with the actual words. Think about it: Think of someone you know well. How can you usually tell how they are feeling without asking?"}],3:[{words:150,title:"The Science of Empathy",body:"For a long time scientists believed that emotions were separate from thinking, that the rational brain and the emotional brain worked independently. Brain imaging technology has shown us this is completely wrong. Emotions and reasoning are deeply connected. When people suffer damage to the parts of the brain that process emotion they actually make worse decisions, not better ones. Empathy, the ability to feel what another person feels, activates the same regions of the brain that fire when we experience something ourselves. In a literal neurological sense, when you feel bad for someone who is hurting, your brain is partially experiencing their pain. This is why stories are so powerful. Reading about a character going through something hard builds the same neural pathways as experiencing it ourselves. Think about it: How does knowing that empathy is a brain function rather than a personality trait change how you think about it?"}]}

};
// Bug 1 fix: friends button maps to friendship fallback stories
STORIES.friends = STORIES.friendship;

// ── Helpers ───────────────────────────────────────────────
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({ top: 0, behavior: 'instant' });
}
// Bug 6 fix: robust fallback chain handles missing grade levels
function getStory(cat, grade, wordTarget) {
  const pool = STORIES[cat]?.[grade] || STORIES[cat]?.['2'] || STORIES[cat]?.['1'] || STORIES['animals']['1'];
  let best = pool[0];
  pool.forEach(s => { if (Math.abs(s.words - wordTarget) < Math.abs(best.words - wordTarget)) best = s; });
  return best;
}

// ── State ─────────────────────────────────────────────────
const S = {
  grade: "1", wordTarget: 100, category: "animals",
  story: "", storyTitle: "",
  wordEls: [], recordStart: null,
  isRace: false, myRole: null,
  roomCode: null, roomRef: null, unsubscribers: [],
  voiceGender: "female",
  speed: 0.9,
  isAIStory: false,
};

function cleanupRoom() {
  S.unsubscribers.forEach(fn => { try { fn(); } catch(e) {} });
  S.unsubscribers = []; S.roomRef = null; S.roomCode = null; S.myRole = null; S.isRace = false;
}

// ── Voice selector ────────────────────────────────────────
document.querySelectorAll('.voice-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.voice-btn').forEach(b => b.classList.remove('sel-voice'));
  btn.classList.add('sel-voice');
  S.voiceGender = btn.dataset.voice;
  if (ttsState === 'playing' || ttsState === 'paused') stopTTS();
  ttsAudioCache.clear();
}));

// ── Speed slider ──────────────────────────────────────────
const speedSlider = document.getElementById('speed-slider');
const speedDisplay = document.getElementById('speed-display');
speedSlider.addEventListener('input', () => {
  S.speed = parseFloat(speedSlider.value);
  speedDisplay.textContent = S.speed.toFixed(1) + '×';
  if (ttsState === 'playing' && ttsAudio) {
    ttsAudio.playbackRate = S.speed;
  }
});

// ── Google Cloud TTS ──────────────────────────────────────
let ttsAudio = null;
let ttsWordTimings = [];
let ttsRafId = null;
let ttsState = 'idle';
let ttsPausedAtMs = 0;
let ttsAudioCache = new Map();

const VOICE_NAMES = {
  female: { prek: "en-US-Wavenet-F", k: "en-US-Wavenet-F", 1: "en-US-Wavenet-F", 2: "en-US-Wavenet-F", 3: "en-US-Wavenet-C" },
  male:   { prek: "en-US-Wavenet-D", k: "en-US-Wavenet-D", 1: "en-US-Wavenet-D", 2: "en-US-Wavenet-D", 3: "en-US-Wavenet-A" },
};

function stopRAF() {
  if (ttsRafId) { cancelAnimationFrame(ttsRafId); ttsRafId = null; }
}

function resetTTSButtons() {
  document.getElementById('btn-play').textContent = '▶ Play';
  document.getElementById('btn-play').disabled = false;
  document.getElementById('btn-pause').disabled = true;
  document.getElementById('btn-pause').textContent = '⏸ Pause';
  document.getElementById('btn-stop-tts').disabled = false;
  ttsState = 'idle';
}

function startHighlightLoop() {
  stopRAF();
  let lastActiveIdx = -1;

  // Check if Cloud Function timings are real or all zeros (broken)
  const timingsAreReal = ttsWordTimings.length > 1 &&
    ttsWordTimings[Math.floor(ttsWordTimings.length / 2)].startMs > 0;

  function loop() {
    if (!ttsAudio || ttsState !== 'playing') return;
    // currentTime is the actual position in the audio (already accounts for playbackRate)
    const nowMs = ttsAudio.currentTime * 1000;
    const totalMs = (ttsAudio.duration || 1) * 1000;
    let activeIdx = -1;

    if (timingsAreReal && ttsWordTimings.length > 0) {
      // Use real timings — binary search for better performance on long texts
      let lo = 0, hi = ttsWordTimings.length - 1;
      while (lo <= hi) {
        const mid = Math.floor((lo + hi) / 2);
        if (ttsWordTimings[mid].startMs <= nowMs) {
          activeIdx = mid;
          lo = mid + 1;
        } else {
          hi = mid - 1;
        }
      }
      // Add a small look-ahead buffer (100ms) so highlight feels snappier
      if (activeIdx < ttsWordTimings.length - 1 && 
          ttsWordTimings[activeIdx + 1].startMs - nowMs < 80) {
        activeIdx++;
      }
    } else {
      // Improved estimation: weight by word length (longer words take more time)
      const wordsCount = S.wordEls.length;
      const wordLengths = S.wordEls.map(el => (el.textContent || '').replace(/[^a-zA-Z]/g, '').length || 1);
      const totalLetters = wordLengths.reduce((a, b) => a + b, 0);
      let cumMs = 0;
      // Use the total audio duration to proportionally distribute
      // We'll calculate actual timings once audio loads
      activeIdx = -1;
      // Store weighted positions for later use
      if (!S._weightedTimings || S._weightedTimings.length !== wordsCount) {
        S._weightedTimings = [];
        let cumLetters = 0;
        for (let i = 0; i < wordsCount; i++) {
          S._weightedTimings.push(cumLetters / totalLetters);
          cumLetters += wordLengths[i];
        }
      }
      const pctPlayed = nowMs / totalMs;
      for (let i = S._weightedTimings.length - 1; i >= 0; i--) {
        if (S._weightedTimings[i] <= pctPlayed) { activeIdx = i; break; }
      }
    }

    if (activeIdx >= 0 && activeIdx !== lastActiveIdx) {
      lastActiveIdx = activeIdx;
      S.wordEls.forEach(w => w.classList.remove('highlight'));
      if (S.wordEls[activeIdx]) {
        S.wordEls[activeIdx].classList.add('highlight');
        // Scroll within the story container only — don't yank the whole page
        const container = document.getElementById('story-scroll-container');
        const wordEl = S.wordEls[activeIdx];
        if (container) {
          const containerRect = container.getBoundingClientRect();
          const wordRect = wordEl.getBoundingClientRect();
          if (wordRect.bottom > containerRect.bottom || wordRect.top < containerRect.top) {
            wordEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }
      }
      // Also highlight in reading mode if active
      const rmOverlay = document.getElementById('reading-mode-overlay');
      if (rmOverlay && rmOverlay.classList.contains('active')) {
        const rmWords = rmOverlay.querySelectorAll('#rm-text .word-span');
        rmWords.forEach(w => w.classList.remove('active-word'));
        if (rmWords[activeIdx]) {
          rmWords[activeIdx].classList.add('active-word');
          rmWords[activeIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
      const pct = Math.round((activeIdx + 1) / S.wordEls.length * 100);
      document.getElementById('progress-bar').style.width = pct + '%';
      if (S.isRace) {
        document.getElementById('together-bar').style.width = pct + '%';
        document.getElementById('together-pct').textContent = pct + '%';
      }
    }
    ttsRafId = requestAnimationFrame(loop);
  }
  ttsRafId = requestAnimationFrame(loop);
}

function stopTTS() {
  stopRAF();
  if (ttsAudio) { ttsAudio.pause(); ttsAudio.src = ''; ttsAudio = null; }
  S.wordEls.forEach(w => w.classList.remove('highlight'));
  // Clear reading mode highlights too
  document.querySelectorAll('#rm-text .word-span').forEach(w => w.classList.remove('active-word'));
  resetTTSButtons();
  ttsPausedAtMs = 0;
}

async function fetchTTSAudio(text, grade, voiceGender) {
  const gradeKey = (grade === 'prek' || grade === 'k') ? grade : parseInt(grade);
  const voiceName = VOICE_NAMES[voiceGender]?.[gradeKey] || "en-US-Wavenet-F";
  // Map grade string to numeric for Cloud Function speaking rate
  const gradeNum = grade === 'prek' ? 0 : grade === 'k' ? 0 : parseInt(grade) || 1;
  const cacheKey = `${voiceName}:${storyHash(text)}`;
  if (ttsAudioCache.has(cacheKey)) return ttsAudioCache.get(cacheKey);
  const response = await fetch(CF_TTS, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, grade: gradeNum, voiceName })
  });
  if (!response.ok) throw new Error('TTS failed: ' + response.status);
  const data = await response.json();
  if (!data.audioBase64) throw new Error('No audio returned');
  ttsAudioCache.set(cacheKey, data);
  if (ttsAudioCache.size > 10) ttsAudioCache.delete(ttsAudioCache.keys().next().value);
  return data;
}

async function playSpeech(startFromMs) {
  if (!S.story) return;
  // Change 7: Offline check
  if (!navigator.onLine) {
    const t = document.getElementById('word-toast');
    t.textContent = '📡 No internet — read along on your own!';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
    resetTTSButtons();
    return;
  }
  ttsState = 'loading';
  document.getElementById('btn-play').textContent = '⏳ Loading...';
  document.getElementById('btn-play').disabled = true;
  document.getElementById('btn-pause').disabled = true;
  try {
    const data = await fetchTTSAudio(S.story, S.grade, S.voiceGender);

    // Map Cloud Function timepoints to word timings
    // timepoints come as [{markName: "word_0", timeSeconds: 0.5}, ...] from Google TTS
    // Convert to [{startMs: 500}, ...] format for the highlight loop
    if (data.timepoints && data.timepoints.length > 0) {
      ttsWordTimings = data.timepoints.map(tp => ({
        startMs: (tp.timeSeconds || tp.time_seconds || 0) * 1000
      }));
    } else if (data.wordTimings && data.wordTimings.length > 0) {
      ttsWordTimings = data.wordTimings;
    } else {
      ttsWordTimings = [];
    }
    console.log(`TTS timings: ${ttsWordTimings.length} timepoints, words: ${S.wordEls.length}, real timings: ${ttsWordTimings.length > 1 && ttsWordTimings[Math.floor(ttsWordTimings.length/2)]?.startMs > 0}`);
    const audio = new Audio('data:audio/mp3;base64,' + data.audioBase64);
    audio.playbackRate = S.speed;
    ttsAudio = audio;
    audio.addEventListener('canplaythrough', () => {
      if (startFromMs > 0) audio.currentTime = startFromMs / 1000;
      audio.play();
      ttsState = 'playing';
      document.getElementById('btn-play').textContent = '▶ Playing...';
      document.getElementById('btn-play').disabled = true;
      document.getElementById('btn-pause').disabled = false;
      document.getElementById('btn-pause').textContent = '⏸ Pause';
      document.getElementById('btn-stop-tts').disabled = false;
      startHighlightLoop();
    }, { once: true });
    audio.addEventListener('ended', () => {
      stopRAF();
      S.wordEls.forEach(w => w.classList.remove('highlight'));
      document.getElementById('progress-bar').style.width = '100%';
      resetTTSButtons();
      ttsPausedAtMs = 0;
      recordReadComplete();
      if (S.isRace) broadcastPlayback('finished', 0);
    });
    audio.addEventListener('error', () => { stopRAF(); resetTTSButtons(); });
  } catch (err) {
    console.error('TTS error:', err);
    resetTTSButtons();
    const t = document.getElementById('word-toast');
    t.textContent = '⚠️ Audio unavailable — try again';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }
}

document.getElementById('btn-play').addEventListener('click', () => {
  if (ttsState === 'idle') {
    S.wordEls.forEach(w => { w.className = 'word'; });
    document.getElementById('progress-bar').style.width = '0%';
    ttsPausedAtMs = 0;
    playSpeech(0);
    if (S.isRace) setTimeout(() => broadcastPlayback('play', 0), 500);
  }
});

document.getElementById('btn-pause').addEventListener('click', () => {
  if (ttsState === 'playing' && ttsAudio) {
    ttsPausedAtMs = ttsAudio.currentTime * 1000;
    ttsAudio.pause();
    stopRAF();
    ttsState = 'paused';
    document.getElementById('btn-pause').textContent = '▶ Resume';
    document.getElementById('btn-play').disabled = true;
    if (S.isRace) broadcastPlayback('pause', ttsPausedAtMs);
  } else if (ttsState === 'paused') {
    playSpeech(ttsPausedAtMs);
    if (S.isRace) broadcastPlayback('play', ttsPausedAtMs);
  }
});

document.getElementById('btn-stop-tts').addEventListener('click', () => {
  stopTTS();
  if (S.isRace) broadcastPlayback('stop', 0);
});

// ── Pickers ───────────────────────────────────────────────
const GRADE_DEFAULTS = { prek: 50, k: 50, "1": 100, "2": 100, "3": 150 };

document.querySelectorAll('#grade-row .opt-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('#grade-row .opt-btn').forEach(b => b.classList.remove('sel-grade'));
  btn.classList.add('sel-grade');
  S.grade = btn.dataset.grade;
  // Auto-select default word count for this grade
  const defaultWords = GRADE_DEFAULTS[S.grade] || 100;
  S.wordTarget = defaultWords;
  document.querySelectorAll('#words-row .opt-btn').forEach(b => {
    b.classList.remove('sel-words');
    if (parseInt(b.dataset.words) === defaultWords) b.classList.add('sel-words');
  });
}));
document.querySelectorAll('#words-row .opt-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('#words-row .opt-btn').forEach(b => b.classList.remove('sel-words'));
  btn.classList.add('sel-words'); S.wordTarget = parseInt(btn.dataset.words);
}));
document.querySelectorAll('.cat-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected'); S.category = btn.dataset.cat;
}));

// ── Solo / Read Together entry ────────────────────────────
document.getElementById('btn-generate').addEventListener('click', () => { S.isRace = false; S.myRole = null; loadStory(); });

// ── Scan My Page ──────────────────────────────────────────
document.getElementById('btn-scan-page').addEventListener('click', () => {
  document.getElementById('scan-file-input').click();
});

document.getElementById('scan-file-input').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';

  // Show loading screen
  S.isRace = false; S.myRole = null; S.isAIStory = false;
  show('screen-read');
  const titleEl = document.getElementById('story-title');
  titleEl.textContent = '📸 Scanning Your Page...';
  const container = document.getElementById('story-text');
  container.innerHTML = '<div style="text-align:center;padding:40px 0;"><div class="spin-circle" style="margin:0 auto 16px;width:40px;height:40px;border-width:5px;"></div><p style="font-weight:800;color:var(--muted);font-size:1rem;">Reading the text from your photo...</p></div>';

  try {
    // Convert image to base64 with compression if needed
    const base64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          // Resize if too large (max 1600px on longest side for good OCR)
          const maxDim = 1600;
          let w = img.width, h = img.height;
          if (w > maxDim || h > maxDim) {
            if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
            else { w = Math.round(w * maxDim / h); h = maxDim; }
          }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
          resolve(dataUrl.split(',')[1]);
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    const mediaType = 'image/jpeg';

    // Send to Cloud Function
    const response = await fetch(CF_OCR, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imageBase64: base64, mediaType })
    });

    if (!response.ok) throw new Error('Scan failed');
    const data = await response.json();
    if (!data.text) throw new Error('No text found');

    // Use extracted text as the story
    S.story = data.text.trim();
    S.storyTitle = '📸 My Page';
    S.category = 'scanned';
    S.wordTarget = S.story.split(/\s+/).length;
    S.isAIStory = false;

    // Record in localStorage
    recordStoryStart();

    // Render the story
    renderStory(S.storyTitle, S.story);
    setupReadScreen();

  } catch (err) {
    console.error('Scan error:', err);
    container.innerHTML = '<div style="text-align:center;padding:40px 0;"><p style="font-weight:800;color:#e74c3c;font-size:1.1rem;">😕 Couldn\'t read that photo</p><p style="font-weight:700;color:var(--muted);font-size:0.9rem;margin-top:8px;">Try again with a clearer photo of the text.</p></div>';
    titleEl.textContent = '📸 Scan My Page';
    setTimeout(() => show('screen-pick'), 3000);
  }
});

// Read Together modal
document.getElementById('btn-together-start').addEventListener('click', () => {
  document.getElementById('screen-together-choice').style.display = 'flex';
});
document.getElementById('btn-create-room').addEventListener('click', () => {
  document.getElementById('screen-together-choice').style.display = 'none';
  S.isRace = true; S.myRole = 'host'; loadStory();
});
document.getElementById('btn-join-room-choice').addEventListener('click', () => {
  document.getElementById('screen-together-choice').style.display = 'none';
  show('screen-join');
});
document.getElementById('btn-together-cancel').addEventListener('click', () => {
  document.getElementById('screen-together-choice').style.display = 'none';
});

document.getElementById('btn-back-join').addEventListener('click', () => show('screen-pick'));

// ── Firebase playback sync ────────────────────────────────
function broadcastPlayback(action, positionMs) {
  if (!S.roomRef || !S.isRace) return;
  const key = S.myRole === 'host' ? 'hostCmd' : 'guestCmd';
  update(S.roomRef, { [key]: { action, positionMs: positionMs || 0, ts: Date.now() } });
}

function listenForPartnerPlayback() {
  const partnerKey = S.myRole === 'host' ? 'guestCmd' : 'hostCmd';
  let lastTs = 0;
  const unsub = onValue(ref(db, `rooms/${S.roomCode}/${partnerKey}`), snap => {
    const cmd = snap.val();
    if (!cmd || cmd.ts <= lastTs) return;
    lastTs = cmd.ts;
    if (cmd.action === 'play') {
      if (ttsState === 'idle' || ttsState === 'paused') {
        S.wordEls.forEach(w => { w.className = 'word'; });
        document.getElementById('progress-bar').style.width = '0%';
        playSpeech(cmd.positionMs || 0);
      }
    } else if (cmd.action === 'pause') {
      if (ttsState === 'playing' && ttsAudio) {
        ttsPausedAtMs = ttsAudio.currentTime * 1000;
        ttsAudio.pause();
        stopRAF();
        ttsState = 'paused';
        document.getElementById('btn-pause').textContent = '▶ Resume';
        document.getElementById('btn-play').disabled = true;
      }
    } else if (cmd.action === 'stop') {
      stopTTS();
    } else if (cmd.action === 'finished') {
      stopRAF();
      S.wordEls.forEach(w => w.classList.remove('highlight'));
      document.getElementById('progress-bar').style.width = '100%';
      resetTTSButtons();
      ttsPausedAtMs = 0;
      recordReadComplete();
    }
  });
  S.unsubscribers.push(unsub);
}

document.getElementById('btn-join-room').addEventListener('click', async () => {
  const code = document.getElementById('join-code-input').value.trim();
  const err = document.getElementById('join-error');
  err.style.display = 'none';
  if (code.length !== 4) { err.textContent = "Please enter a 4-digit code."; err.style.display = 'block'; return; }
  const snap = await get(ref(db, `rooms/${code}`));
  if (!snap.exists()) { err.textContent = "Room not found. Check the code!"; err.style.display = 'block'; return; }
  const room = snap.val();
  S.roomCode = code; S.roomRef = ref(db, `rooms/${code}`);
  S.story = room.story; S.storyTitle = room.title; S.grade = room.grade; S.wordTarget = room.wordTarget;
  S.myRole = 'guest'; S.isRace = true;
  await update(S.roomRef, { guestJoined: true });
  show('screen-waiting-guest');
  const unsub = onValue(ref(db, `rooms/${code}/status`), snap => {
    if (snap.val() === 'countdown') { unsub(); startCountdown(); }
  });
  S.unsubscribers.push(unsub);
});

// ── Clean AI story text once at load time ─────────────────
function cleanStoryText(text) {
  return text
    .replace(/#+\s*/g, '')                          // remove all # characters
    .replace(/\*\*(.*?)\*\*/g, '$1')                // strip bold markers
    .replace(/^(reading passage|passage|story title|title):?\s*/im, '')
    .replace(/^[^\n]*\n/, line => /[.!?,]/.test(line) ? line : '') // remove title line
    .trim();
}

// ── Load story ────────────────────────────────────────────
async function loadStory() {
  show('screen-loading');
  const loadingMsg = document.getElementById('loading-msg');
  try {
    loadingMsg.textContent = '✨ Writing your story with AI...';
    const aiTimeout = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('timeout')), 15000)
    );
    const aiText = await Promise.race([
      generateAIStory(S.grade, S.category, S.wordTarget),
      aiTimeout
    ]);
    const TOPIC_NAMES = { animals:"Animals", space:"Space", dinosaurs:"Dinosaurs", ocean:"Ocean", superheroes:"Superheroes", magic:"Magic", sports:"Sports", cooking:"Cooking", friends:"Friends", confidence:"Self-Confidence", blackhistory:"Black History Heroes", helpers:"Community Helpers", nature:"Nature & Weather", emotions:"Feelings & Emotions", trucks:"Trucks & Vehicles", princesses:"Princesses & Castles", robots:"Robots", pirates:"Pirates", airplanes:"Airplanes & Flying" };
    S.storyTitle = `✨ ${TOPIC_NAMES[S.category] || S.category} Story`;
    S.story = cleanStoryText(aiText);
    S.isAIStory = true;
    recordStoryStart();
  } catch (err) {
    console.warn('AI generation failed, using fallback:', err);
    loadingMsg.textContent = 'Getting your story ready...';
    const s = getStory(S.category, S.grade, S.wordTarget);
    S.storyTitle = s.title; S.story = s.body; S.isAIStory = false;
    recordStoryStart();
  }
  if (S.myRole === 'host') createRoom();
  else { setupReadScreen(); show('screen-read'); }
}

async function createRoom() {
  const code = String(Math.floor(1000 + Math.random() * 9000));
  S.roomCode = code; S.roomRef = ref(db, `rooms/${code}`);
  await set(S.roomRef, { story: S.story, title: S.storyTitle, grade: S.grade, wordTarget: S.wordTarget, status: 'waiting', host: { progress: 0, wpm: 0, done: false }, guest: { progress: 0, wpm: 0, done: false }, createdAt: Date.now() });
  document.getElementById('display-room-code').textContent = code;
  show('screen-waiting-host');
  const unsub = onValue(S.roomRef, snap => {
    const room = snap.val(); if (!room) return;
    if (room.guestJoined) {
      document.getElementById('slot-guest').classList.add('joined');
      document.getElementById('slot-guest').querySelector('.slot-name').textContent = 'Partner';
      document.getElementById('slot-guest').querySelector('.slot-status').textContent = '✓ Joined!';
      unsub(); setTimeout(() => startCountdown(), 1000);
    }
  });
  S.unsubscribers.push(unsub);
  setTimeout(() => { try { remove(S.roomRef); } catch(e) {} }, 3600000); // 60 min
}

async function startCountdown() {
  if (S.myRole === 'host') await update(S.roomRef, { status: 'countdown' });
  show('screen-countdown');
  const el = document.getElementById('countdown-display');
  const steps = ['3','2','1','GO!']; let i = 0;
  const tick = () => {
    el.textContent = steps[i];
    el.className = steps[i] === 'GO!' ? 'countdown-go' : 'countdown-number';
    el.style.animation = 'none'; el.offsetHeight; el.style.animation = '';
    i++;
    if (i < steps.length) setTimeout(tick, 900);
    else setTimeout(async () => {
      // Fix 1: Guest double-checks story from Firebase to ensure it matches host
      if (S.myRole === 'guest' && S.roomCode) {
        try {
          const snap = await get(ref(db, `rooms/${S.roomCode}`));
          if (snap.exists()) {
            const room = snap.val();
            S.story = room.story;
            S.storyTitle = room.title;
            S.grade = room.grade;
            S.wordTarget = room.wordTarget;
            S.isAIStory = true;
          }
        } catch(e) { console.warn('Could not refresh story:', e); }
      }
      setupReadScreen(); show('screen-read');
    }, 400);
  };
  tick();
}

function setupReadScreen() {
  renderStory(S.storyTitle, S.story);
  updateReadBadge();
  // Fix 4: Show connected indicator when reading together
  const existingConnected = document.getElementById('together-connected-badge');
  if (existingConnected) existingConnected.remove();
  if (S.isRace) {
    const badge = document.createElement('div');
    badge.id = 'together-connected-badge';
    badge.style.cssText = 'text-align:center;font-size:0.78rem;font-weight:800;color:var(--green);margin:4px 0 8px;';
    badge.textContent = '🟢 Connected — reading together';
    document.getElementById('story-title').after(badge);
  }
  document.getElementById('together-progress').style.display = S.isRace ? 'block' : 'none';
  document.getElementById('solo-progress-wrap').style.display = S.isRace ? 'none' : 'block';
  // Show "I Finished Reading" button after 10 seconds for silent readers
  const finishedBtn = document.getElementById('btn-finished-reading');
  finishedBtn.style.display = 'none';
  if (!S.isRace) {
    clearTimeout(S._finishedBtnTimer);
    S._finishedBtnTimer = setTimeout(() => {
      finishedBtn.style.display = 'block';
    }, 10000);
  }
  if (S.isRace) {
    document.getElementById('together-bar').style.width = '0%';
    document.getElementById('together-pct').textContent = '0%';
    listenForPartnerPlayback();
  }
  // Preload TTS audio in background so Play is instant (both solo and together)
  if (navigator.onLine && S.story) {
    fetchTTSAudio(S.story, S.grade, S.voiceGender).catch(() => {});
  }
}

function renderStory(title, body) {
  const titleEl = document.getElementById('story-title');
  titleEl.innerHTML = S.isAIStory ? title + ' <span class="ai-badge">✨ AI</span>' : '';
  if (!S.isAIStory) titleEl.textContent = title;
  const container = document.getElementById('story-text');
  container.innerHTML = ''; S.wordEls = [];

  // Split into paragraphs, then words within each paragraph
  const paragraphs = body.split(/\n\s*\n/);
  paragraphs.forEach((para, pIdx) => {
    para.trim().split(/(\s+)/).forEach(chunk => {
      if (/\S/.test(chunk)) {
        const span = document.createElement('span');
        span.className = 'word'; span.textContent = chunk;
        span.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = S.wordEls.indexOf(span);
          if (idx >= 0 && !dictPopupOpen) showDictionaryPopup(span.textContent.trim(), idx);
        });
        container.appendChild(span); S.wordEls.push(span);
      } else { container.appendChild(document.createTextNode(chunk)); }
    });
    if (pIdx < paragraphs.length - 1) {
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
    }
  });
  document.getElementById('progress-bar').style.width = '0%';
  S.wordEls.forEach(w => { w.style.color = ''; w.style.background = ''; });

  // Show story info bar
  const gradeLabels = { prek: 'Pre-K', k: 'Kindergarten', '1': '1st Grade', '2': '2nd Grade', '3': '3rd Grade' };
  const wordCount = S.wordEls.length;
  const infoBar = document.getElementById('story-info-bar');
  const infoText = document.getElementById('story-info-text');
  if (S.category === 'scanned') {
    infoText.textContent = `📸 ${wordCount} words`;
  } else {
    infoText.textContent = `📚 ${gradeLabels[S.grade] || S.grade} Level · ${wordCount} words`;
  }
  infoBar.style.display = 'block';

  stopRAF();
  if (ttsAudio) { ttsAudio.pause(); ttsAudio.src = ''; ttsAudio = null; }
  resetTTSButtons();
  ttsWordTimings = []; ttsPausedAtMs = 0;
  requestAnimationFrame(() => {
    const scrollContainer = document.getElementById('story-scroll-container');
    if (scrollContainer) scrollContainer.scrollTop = 0;
    window.scrollTo({ top: 0, behavior: 'instant' });
  });
}

// ── Dictionary Cache ──────────────────────────────────────
const DICT_CACHE_KEY = 'readup_dict_cache';

function getDictCache() {
  try { return JSON.parse(localStorage.getItem(DICT_CACHE_KEY)) || {}; } catch(e) { return {}; }
}

function saveDictCache(cache) {
  // Cap at 500 entries
  const keys = Object.keys(cache);
  if (keys.length > 500) {
    keys.slice(0, keys.length - 500).forEach(k => delete cache[k]);
  }
  try { localStorage.setItem(DICT_CACHE_KEY, JSON.stringify(cache)); } catch(e) {}
}

async function getWordDefinition(word, grade) {
  const clean = word.toLowerCase().replace(/[^a-z']/g, '');
  if (!clean) return null;
  const cacheKey = `${clean}_${grade}`;
  const cache = getDictCache();
  if (cache[cacheKey]) return cache[cacheKey];

  const gradeNames = { "prek": "Pre-K (age 3-4)", "k": "Kindergarten (age 5-6)", "1": "1st grade (age 6-7)", "2": "2nd grade (age 7-8)", "3": "3rd grade (age 8-9)" };
  const gradeLabel = gradeNames[grade] || "1st grade (age 6-7)";

  const prompt = `Define the word "${clean}" for a ${gradeLabel} child in ONE simple sentence. Use words they already know. Do not include the word "means" or start with "It means". Just give the definition directly. Example: for "enormous" you might say "Really, really big — bigger than a house!"`;

  try {
    const response = await fetch(CF_STORY, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        grade: gradeLabel,
        topic: 'definition',
        wordCount: 20,
        instructions: prompt
      })
    });
    if (!response.ok) throw new Error('CF error');
    const data = await response.json();
    const rawDef = (data.story || '').trim()
      .replace(/^["']+|["']+$/g, '')   // strip leading/trailing quotes
      .replace(/^#+\s*/g, '')          // strip markdown headers
      .replace(/^\*\*(.*?)\*\*/g, '$1') // strip bold markers
      .trim();
    // Remove word echo at the start (e.g. "Walked You moved..." → "You moved...")
    const wordPattern = new RegExp('^' + clean + '[\\s:—–\\-]*', 'i');
    const definition = rawDef.replace(wordPattern, '').replace(/^["']+\s*/g, '').trim();
    if (definition) {
      cache[cacheKey] = definition;
      saveDictCache(cache);
      return definition;
    }
  } catch(e) {
    console.warn('Definition fetch failed:', e);
  }
  return null;
}

// ── Dictionary Popup State ────────────────────────────────
let dictPopupOpen = false;
let teacherWasPaused = false;
let teacherPausePosition = 0;
let dictAudio = null;

function showDictionaryPopup(word, idx) {
  if (dictPopupOpen) return;
  dictPopupOpen = true;

  // Pause teacher if playing
  teacherWasPaused = false;
  if (ttsState === 'playing' && ttsAudio) {
    teacherPausePosition = ttsAudio.currentTime * 1000;
    ttsAudio.pause();
    stopRAF();
    ttsState = 'paused';
    document.getElementById('btn-pause').textContent = '⏸ Pause';
    document.getElementById('btn-play').disabled = true;
    teacherWasPaused = true;
  }

  // Save word to bank (only if tapped from story, not word bank review)
  if (idx >= 0) saveWordToBank(word);

  // Show popup with loading state
  document.getElementById('dict-word').textContent = word;
  document.getElementById('dict-definition').innerHTML = '<div class="dict-loading"><div class="spin-circle"></div>Looking it up...</div>';
  document.getElementById('dict-hear-btn').style.display = 'none';
  document.getElementById('dict-overlay').style.display = 'flex';

  // Highlight the tapped word (only if in story, not word bank)
  S.wordEls.forEach(w => w.classList.remove('highlight'));
  if (idx >= 0 && S.wordEls[idx]) {
    S.wordEls[idx].style.background = '#A259FF';
    S.wordEls[idx].style.color = '#ffffff';
  }

  // Fetch definition
  getWordDefinition(word, S.grade).then(definition => {
    if (!dictPopupOpen) return; // popup was closed already
    if (definition) {
      document.getElementById('dict-definition').textContent = definition;
      document.getElementById('dict-hear-btn').style.display = 'block';
      // Auto-read word + definition
      sayDictEntry(word, definition);
    } else {
      document.getElementById('dict-definition').textContent = 'Tap 🔊 to hear the word!';
      document.getElementById('dict-hear-btn').style.display = 'block';
      sayWordOnly(word);
    }
  });
}

function closeDictionaryPopup() {
  dictPopupOpen = false;
  document.getElementById('dict-overlay').style.display = 'none';

  // Stop any dictionary audio
  if (dictAudio) { dictAudio.pause(); dictAudio = null; }

  // Clear word highlight
  S.wordEls.forEach(w => { w.style.background = ''; w.style.color = ''; w.classList.remove('highlight'); });

  // Resume teacher if we paused it
  if (teacherWasPaused && ttsState === 'paused') {
    teacherWasPaused = false;
    playSpeech(teacherPausePosition);
  }
}

async function sayDictEntry(word, definition) {
  const fullText = word + '. ' + definition;
  try {
    const gradeNum = (S.grade === 'prek' || S.grade === 'k') ? 0 : parseInt(S.grade) || 1;
    const gradeKey = (S.grade === 'prek' || S.grade === 'k') ? S.grade : parseInt(S.grade);
    const voiceName = VOICE_NAMES[S.voiceGender]?.[gradeKey] || 'en-US-Wavenet-F';
    const response = await fetch(CF_TTS, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: fullText, grade: gradeNum, voiceName })
    });
    const data = await response.json();
    if (data.audioBase64) {
      if (dictAudio) { dictAudio.pause(); }
      dictAudio = new Audio('data:audio/mp3;base64,' + data.audioBase64);
      dictAudio.playbackRate = 0.85;
      dictAudio.play();
      return;
    }
  } catch(e) {}
  // Fallback browser voice
  const utt = new SpeechSynthesisUtterance(fullText);
  utt.rate = 0.8; utt.pitch = 1.1;
  window.speechSynthesis.speak(utt);
}

async function sayWordOnly(word) {
  try {
    const gradeNum = (S.grade === 'prek' || S.grade === 'k') ? 0 : parseInt(S.grade) || 1;
    const gradeKey = (S.grade === 'prek' || S.grade === 'k') ? S.grade : parseInt(S.grade);
    const voiceName = VOICE_NAMES[S.voiceGender]?.[gradeKey] || 'en-US-Wavenet-F';
    const response = await fetch(CF_TTS, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: word, grade: gradeNum, voiceName })
    });
    const data = await response.json();
    if (data.audioBase64) {
      if (dictAudio) { dictAudio.pause(); }
      dictAudio = new Audio('data:audio/mp3;base64,' + data.audioBase64);
      dictAudio.playbackRate = 0.85;
      dictAudio.play();
      return;
    }
  } catch(e) {}
  const utt = new SpeechSynthesisUtterance(word);
  utt.rate = 0.8; utt.pitch = 1.1;
  window.speechSynthesis.speak(utt);
}

// Wire up popup buttons
document.getElementById('dict-close-btn').addEventListener('click', closeDictionaryPopup);
document.getElementById('dict-overlay').addEventListener('click', (e) => {
  if (e.target.id === 'dict-overlay') closeDictionaryPopup();
});
document.getElementById('dict-hear-btn').addEventListener('click', () => {
  const word = document.getElementById('dict-word').textContent;
  const def = document.getElementById('dict-definition').textContent;
  if (def && !def.includes('Tap')) {
    sayDictEntry(word, def);
  } else {
    sayWordOnly(word);
  }
});

// ── Nav ───────────────────────────────────────────────────
document.getElementById('btn-cancel-host').addEventListener('click', async () => {
  if (S.roomRef) try { await remove(S.roomRef); } catch(e) {}
  cleanupRoom(); show('screen-pick');
});
document.getElementById('btn-new').addEventListener('click', () => {
  const count = getCurrentReadCount();
  if (count > 0 && count < 3) {
    if (!confirm(`You're on Read #${count}! Leave this story?`)) return;
  }
  stopTTS(); cleanupRoom();
  clearTimeout(S._finishedBtnTimer);
  document.getElementById('btn-finished-reading').style.display = 'none';
  show('screen-pick');
});
document.getElementById('btn-finished-reading').addEventListener('click', () => {
  document.getElementById('btn-finished-reading').style.display = 'none';
  clearTimeout(S._finishedBtnTimer);
  recordReadComplete();
});
document.getElementById('btn-solo-retry').addEventListener('click', () => {
  setupReadScreen(); show('screen-read');
});
document.getElementById('btn-solo-new').addEventListener('click', () => {
  stopTTS(); cleanupRoom(); show('screen-pick');
});
document.getElementById('btn-solo-wordbank').addEventListener('click', () => {
  openWordBankReview();
});
document.getElementById('btn-wordbank-done').addEventListener('click', () => {
  show('screen-solo-complete');
});

// ── Word Bank Review Screen Logic ─────────────────────────
function openWordBankReview() {
  const d = getData();
  const listEl = document.getElementById('wordbank-review-list');
  const emptyEl = document.getElementById('wordbank-empty');
  const countEl = document.getElementById('wordbank-count-msg');
  listEl.innerHTML = '';

  // Get words sorted by most recently seen
  const words = [...d.wordBank].sort((a, b) => new Date(b.lastSeen) - new Date(a.lastSeen));

  if (words.length === 0) {
    emptyEl.style.display = 'block';
    listEl.style.display = 'none';
    countEl.textContent = '';
  } else {
    emptyEl.style.display = 'none';
    listEl.style.display = 'block';
    countEl.textContent = `You have ${words.length} word${words.length === 1 ? '' : 's'} to practice!`;

    const dictCache = getDictCache();
    words.forEach(w => {
      const clean = w.word.toLowerCase().replace(/[^a-z']/g, '');
      const cacheKey = `${clean}_${S.grade}`;
      const definition = dictCache[cacheKey] || '';

      const item = document.createElement('div');
      item.className = 'wb-review-item';
      item.style.flexDirection = 'column';
      item.style.alignItems = 'flex-start';
      item.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
          <div class="wb-review-word">${w.word}</div>
          <div class="wb-review-tap">tap to hear 🔊</div>
        </div>
        ${definition ? `<div style="font-size:0.88rem;font-weight:700;color:var(--body);margin-top:4px;line-height:1.4;">${definition}</div>` : '<div style="font-size:0.82rem;font-weight:700;color:var(--muted);margin-top:4px;">Tap to look up meaning</div>'}
      `;
      item.addEventListener('click', () => {
        showDictionaryPopup(w.word, -1);
      });
      listEl.appendChild(item);
    });
  }
  show('screen-wordbank');
}

// ── WPM Timer (Read It Myself) ────────────────────────────
const WPM_BENCHMARKS = {
  prek: { label: 'Pre-K Goal', min: 10, max: 30 },
  k:    { label: 'Kindergarten Goal', min: 20, max: 50 },
  '1':  { label: '1st Grade Goal', min: 53, max: 111 },
  '2':  { label: '2nd Grade Goal', min: 89, max: 142 },
  '3':  { label: '3rd Grade Goal', min: 107, max: 162 },
};

let wpmTimerInterval = null;
let wpmStartTime = null;

function formatTimer(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2, '0')}`;
}

function startWPMRead() {
  // Render story text (plain, no highlights)
  const container = document.getElementById('wpm-story-text');
  container.innerHTML = '';
  const paragraphs = S.story.split(/\n\s*\n/);
  paragraphs.forEach((para, pIdx) => {
    const span = document.createElement('span');
    span.style.cssText = 'font-size:1.3rem;line-height:2.1rem;color:var(--ink);font-weight:700;';
    span.textContent = para.trim();
    container.appendChild(span);
    if (pIdx < paragraphs.length - 1) {
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
    }
  });

  // Reset timer
  document.getElementById('wpm-timer').textContent = '0:00';
  document.getElementById('wpm-read-tip').textContent = 'Read the story out loud. Tap "I\'m Done!" when you finish.';

  // Show countdown first
  show('screen-countdown');
  const el = document.getElementById('countdown-display');
  const steps = ['3','2','1','READ!']; let i = 0;
  const tick = () => {
    el.textContent = steps[i];
    el.className = steps[i] === 'READ!' ? 'countdown-go' : 'countdown-number';
    el.style.animation = 'none'; el.offsetHeight; el.style.animation = '';
    i++;
    if (i < steps.length) setTimeout(tick, 900);
    else setTimeout(() => {
      show('screen-wpm-read');
      // Start timer
      wpmStartTime = Date.now();
      if (wpmTimerInterval) clearInterval(wpmTimerInterval);
      wpmTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - wpmStartTime) / 1000);
        document.getElementById('wpm-timer').textContent = formatTimer(elapsed);
      }, 1000);
    }, 400);
  };
  tick();
}

function finishWPMRead() {
  // Stop timer
  if (wpmTimerInterval) { clearInterval(wpmTimerInterval); wpmTimerInterval = null; }
  const elapsedMs = Date.now() - wpmStartTime;
  const elapsedSec = elapsedMs / 1000;

  // Count words in story
  const wordCount = S.story.trim().split(/\s+/).length;

  // Calculate WPM
  const wpm = Math.round((wordCount / elapsedSec) * 60);

  // Save WPM to localStorage
  saveWPMScore(wpm, elapsedSec, wordCount);

  // Show results
  showWPMResults(wpm, wordCount, elapsedSec);
}

function saveWPMScore(wpm, seconds, wordCount) {
  const d = getData();
  const hash = storyHash(S.story);
  let entry = d.stories.find(s => s.hash === hash);
  if (!entry) return;
  if (!entry.wpmScores) entry.wpmScores = [];
  entry.wpmScores.push({ wpm, seconds: Math.round(seconds), wordCount, date: new Date().toISOString() });
  // Keep last 10 scores per story
  if (entry.wpmScores.length > 10) entry.wpmScores = entry.wpmScores.slice(-10);
  saveData(d);
}

function getWPMScores() {
  const d = getData();
  const hash = storyHash(S.story || '');
  const entry = d.stories.find(s => s.hash === hash);
  return entry?.wpmScores || [];
}

function showWPMResults(wpm, wordCount, elapsedSec) {
  // Big number
  document.getElementById('wpm-result-number').textContent = wpm;

  // Summary line: "You read 50 words in 40 sec" or "You read 120 words in 1 min 30 sec"
  const totalSec = Math.round(elapsedSec);
  let timeStr;
  if (totalSec >= 60) {
    const mins = Math.floor(totalSec / 60);
    const secs = totalSec % 60;
    timeStr = secs > 0 ? `${mins} min ${secs} sec` : `${mins} min`;
  } else {
    timeStr = `${totalSec} sec`;
  }
  document.getElementById('wpm-read-summary').textContent = `You read ${wordCount} words in ${timeStr}`;

  // Benchmark
  const bench = WPM_BENCHMARKS[S.grade] || WPM_BENCHMARKS['1'];
  document.getElementById('wpm-benchmark-label').textContent = bench.label;
  document.getElementById('wpm-benchmark-range').textContent = `${bench.min} – ${bench.max} WPM`;

  // Improvement badge
  const scores = getWPMScores();
  const badgeEl = document.getElementById('wpm-improvement-badge');
  badgeEl.innerHTML = '';
  if (scores.length >= 2) {
    const prev = scores[scores.length - 2].wpm;
    const diff = wpm - prev;
    if (diff > 0) {
      badgeEl.innerHTML = `<div class="wpm-improvement">⬆️ +${diff} WPM from last read!</div>`;
    } else if (diff === 0) {
      badgeEl.innerHTML = `<div class="wpm-improvement" style="background:var(--purple-soft);border-color:var(--purple);color:var(--purple-deep);">Same speed — nice consistency!</div>`;
    }
  }

  // History bars
  const historyEl = document.getElementById('wpm-history-section');
  historyEl.innerHTML = '';
  if (scores.length > 1) {
    const maxWpm = Math.max(...scores.map(s => s.wpm), bench.max);
    scores.forEach((s, i) => {
      const pct = Math.round((s.wpm / maxWpm) * 100);
      const row = document.createElement('div');
      row.className = 'wpm-history-row';
      row.innerHTML = `
        <div class="wpm-history-read">Read #${i + 1}</div>
        <div class="wpm-history-bar-wrap"><div class="wpm-history-bar" style="width:${pct}%"></div></div>
        <div class="wpm-history-num">${s.wpm}</div>
      `;
      historyEl.appendChild(row);
    });
  }

  show('screen-wpm-results');
}

// WPM button handlers
document.getElementById('btn-solo-wpm').addEventListener('click', () => {
  startWPMRead();
});
document.getElementById('btn-wpm-done').addEventListener('click', () => {
  finishWPMRead();
});
document.getElementById('btn-wpm-cancel').addEventListener('click', () => {
  if (wpmTimerInterval) { clearInterval(wpmTimerInterval); wpmTimerInterval = null; }
  show('screen-solo-complete');
});
document.getElementById('btn-wpm-retry').addEventListener('click', () => {
  startWPMRead();
});
document.getElementById('btn-wpm-back-complete').addEventListener('click', () => {
  show('screen-solo-complete');
});

document.getElementById('btn-race-retry').addEventListener('click', () => {
  setupReadScreen(); show('screen-read');
});
document.getElementById('btn-race-new').addEventListener('click', async () => {
  stopTTS();
  if (S.roomRef) try { await remove(S.roomRef); } catch(e) {}
  cleanupRoom(); show('screen-pick');
});

// ═══════════════════════════════════════════════════════════
// ── localStorage Engine ──────────────────────────────────
// ═══════════════════════════════════════════════════════════
const LS_KEY = 'readup_data';

function loadData() {
  try {
    return JSON.parse(localStorage.getItem(LS_KEY)) || {};
  } catch(e) { return {}; }
}

function saveData(d) {
  try { localStorage.setItem(LS_KEY, JSON.stringify(d)); } catch(e) {}
}

function getData() {
  const d = loadData();
  if (!d.pin) d.pin = '1234';
  if (!d.bedtimeMode) d.bedtimeMode = false;
  if (!d.stories) d.stories = [];
  if (!d.wordBank) d.wordBank = [];
  if (!d.spellingLists) d.spellingLists = [];
  if (!d.weeklyLog) d.weeklyLog = [];
  return d;
}

// Simple hash for story text
function storyHash(text) {
  let h = 0;
  for (let i = 0; i < Math.min(text.length, 200); i++) {
    h = ((h << 5) - h) + text.charCodeAt(i);
    h |= 0;
  }
  return Math.abs(h).toString(36);
}

// WPM estimates by grade for reading time calc
const GRADE_WPM = { prek: 20, k: 30, '1': 60, '2': 80, '3': 100 };

// Today's date string
function today() { return new Date().toISOString().slice(0, 10); }

// Get or create today's weekly log entry
function getTodayLog(d) {
  let entry = d.weeklyLog.find(e => e.date === today());
  if (!entry) {
    entry = { date: today(), storiesStarted: 0, totalReads: 0, minutesEstimated: 0 };
    d.weeklyLog.push(entry);
    // Cap at 90 days
    if (d.weeklyLog.length > 90) d.weeklyLog.splice(0, d.weeklyLog.length - 90);
  }
  return entry;
}

// Record a story start
function recordStoryStart() {
  const d = getData();
  const hash = storyHash(S.story);
  const now = new Date().toISOString();
  let entry = d.stories.find(s => s.hash === hash);
  if (!entry) {
    entry = { hash, topic: S.category, grade: S.grade, wordCount: S.wordTarget, readCount: 0, firstRead: now, lastRead: now };
    d.stories.push(entry);
    // Cap at 50
    if (d.stories.length > 50) d.stories.splice(0, d.stories.length - 50);
    // Log as new story started
    getTodayLog(d).storiesStarted++;
  }
  saveData(d);
  return entry;
}

// Record a completed read (called when TTS finishes or hits 100%)
function recordReadComplete() {
  const d = getData();
  const hash = storyHash(S.story);
  let entry = d.stories.find(s => s.hash === hash);
  if (!entry) { recordStoryStart(); return recordReadComplete(); }
  entry.readCount++;
  entry.lastRead = new Date().toISOString();
  const log = getTodayLog(d);
  log.totalReads++;
  const wpm = GRADE_WPM[S.grade] || 60;
  const mins = Math.round((S.wordTarget / wpm) * 10) / 10;
  log.minutesEstimated = Math.round((log.minutesEstimated + mins) * 10) / 10;
  saveData(d);
  updateReadBadge();
  showReadComplete(entry.readCount);
}

// Get current read count for active story
function getCurrentReadCount() {
  const d = getData();
  const hash = storyHash(S.story || '');
  return (d.stories.find(s => s.hash === hash) || {}).readCount || 0;
}

// Update the "Read #N" badge on story title
function updateReadBadge() {
  const count = getCurrentReadCount();
  const existing = document.getElementById('reread-badge');
  if (existing) existing.remove();
  if (count > 0) {
    const badge = document.createElement('span');
    badge.id = 'reread-badge';
    badge.className = 'reread-badge';
    badge.textContent = `Read #${count}`;
    document.getElementById('story-title').appendChild(badge);
  }
}

// Show completion / encouragement for rereading
function showReadComplete(readCount) {
  const title = document.getElementById('solo-complete-title');
  const msg = document.getElementById('solo-complete-msg');
  const retryBtn = document.getElementById('btn-solo-retry');
  const newBtn = document.getElementById('btn-solo-new');
  if (readCount >= 3) {
    title.textContent = '⭐ Superstar Reader!';
    msg.innerHTML = `You read this story ${readCount} times! You're amazing!`;
    retryBtn.textContent = '🔄 Read Again';
    retryBtn.className = 'btn-main btn-outline';
    newBtn.className = 'btn-main btn-green';
    newBtn.style.marginTop = '0';
    retryBtn.style.marginTop = '10px';
  } else {
    const next = readCount + 1;
    title.textContent = `✅ Read #${readCount} Complete!`;
    msg.innerHTML = `Great readers read stories 3 times!<br><span style="font-size:0.9rem;opacity:0.8;">Ready for read #${next}?</span>`;
    retryBtn.textContent = `▶ Read #${next} — Let's Go!`;
    retryBtn.className = 'btn-main btn-green';
    retryBtn.style.marginTop = '0';
    newBtn.className = 'btn-main btn-outline';
    newBtn.style.marginTop = '10px';
  }
  show('screen-solo-complete');
}

// ── Word Bank ─────────────────────────────────────────────
function saveWordToBank(word) {
  if (!word || word.length < 2) return;
  const clean = word.toLowerCase().replace(/[^a-z']/g, '');
  if (!clean) return;
  const d = getData();
  const existing = d.wordBank.find(w => w.word === clean);
  if (existing) {
    existing.count++;
    existing.lastSeen = new Date().toISOString();
  } else {
    d.wordBank.push({ word: clean, count: 1, lastSeen: new Date().toISOString() });
    if (d.wordBank.length > 200) d.wordBank.splice(0, d.wordBank.length - 200);
  }
  saveData(d);
  showWordToast(clean);
}

function showWordToast(word) {
  const t = document.getElementById('word-toast');
  t.textContent = `💾 "${word}" saved!`;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1500);
}

// ── Spelling Words ───────────────────────────────────────
let currentSpellingList = null;

function triggerSpellingUpload() {
  document.getElementById('spelling-file-input').click();
}

document.getElementById('btn-spelling-start').addEventListener('click', () => {
  // Always trigger fresh upload — no grade required
  document.getElementById('spelling-file-input').click();
});

document.getElementById('btn-spelling-upload-empty').addEventListener('click', triggerSpellingUpload);

document.getElementById('btn-spelling-new').addEventListener('click', triggerSpellingUpload);

document.getElementById('btn-spelling-done').addEventListener('click', () => {
  show('screen-pick');
});

document.getElementById('spelling-file-input').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';

  // Show loading state
  show('screen-spelling');
  document.getElementById('spelling-word-list').innerHTML = '';
  document.getElementById('spelling-empty').style.display = 'none';
  document.getElementById('spelling-loading').style.display = 'block';
  document.getElementById('spelling-actions').style.display = 'none';
  document.getElementById('spelling-count-bar').style.display = 'none';
  document.getElementById('spelling-week-label').textContent = '';

  try {
    // Convert image to base64 with compression
    const base64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const maxDim = 1600;
          let w = img.width, h = img.height;
          if (w > maxDim || h > maxDim) {
            if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
            else { w = Math.round(w * maxDim / h); h = maxDim; }
          }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
          resolve(dataUrl.split(',')[1]);
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    // Send to spelling extraction Cloud Function
    const response = await fetch(CF_SPELLING, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imageBase64: base64, mediaType: 'image/jpeg', grade: S.grade || '2' })
    });

    if (!response.ok) throw new Error('Extraction failed');
    const data = await response.json();

    if (!data.words || data.words.length === 0) throw new Error('No words found');

    // Build the spelling list object
    const spellingList = {
      id: Date.now().toString(36),
      date: new Date().toISOString(),
      grade: S.grade || '2',
      words: data.words.map((w, i) => ({
        word: w.word.toLowerCase().trim(),
        syllables: w.syllables || w.word,
        isRedWord: w.isRedWord || false,
        num: i + 1,
        practiced: 0,
        mastered: false
      }))
    };

    // Save to localStorage — replace existing or push new
    const d = getData();
    d.spellingLists.push(spellingList);
    // Keep max 10 lists
    if (d.spellingLists.length > 10) d.spellingLists.splice(0, d.spellingLists.length - 10);
    saveData(d);

    currentSpellingList = spellingList;
    renderSpellingWords(spellingList);

  } catch (err) {
    console.error('Spelling extraction error:', err);
    document.getElementById('spelling-loading').style.display = 'none';
    document.getElementById('spelling-word-list').innerHTML = `
      <div style="text-align:center;padding:30px 0;">
        <div style="font-size:2.5rem;margin-bottom:8px;">😕</div>
        <p style="font-weight:800;color:#e74c3c;font-size:1rem;">Couldn't read those words</p>
        <p style="font-weight:700;color:var(--muted);font-size:0.85rem;margin-top:6px;">Try again with a clearer photo of the spelling list.</p>
        <button class="btn-main" id="btn-spelling-retry-error" style="margin-top:16px;font-size:0.95rem;background:linear-gradient(135deg, #FF8C42, #FF6B6B);">📸 Try Again</button>
      </div>`;
    document.getElementById('btn-spelling-retry-error').addEventListener('click', triggerSpellingUpload);
  }
});

function showSpellingEmpty() {
  document.getElementById('spelling-word-list').innerHTML = '';
  document.getElementById('spelling-empty').style.display = 'block';
  document.getElementById('spelling-loading').style.display = 'none';
  document.getElementById('spelling-actions').style.display = 'none';
  document.getElementById('spelling-count-bar').style.display = 'none';
  document.getElementById('spelling-week-label').textContent = '';
}

function renderSpellingWords(list) {
  const listEl = document.getElementById('spelling-word-list');
  const loadingEl = document.getElementById('spelling-loading');
  const emptyEl = document.getElementById('spelling-empty');
  const actionsEl = document.getElementById('spelling-actions');
  const countBar = document.getElementById('spelling-count-bar');
  const weekLabel = document.getElementById('spelling-week-label');

  loadingEl.style.display = 'none';
  emptyEl.style.display = 'none';
  actionsEl.style.display = 'flex';
  countBar.style.display = 'flex';

  // Show word count
  document.getElementById('spelling-word-count').textContent = list.words.length;

  // Show date
  const d = new Date(list.date);
  const options = { month: 'long', day: 'numeric', year: 'numeric' };
  weekLabel.textContent = `Uploaded ${d.toLocaleDateString('en-US', options)}`;

  // Render word cards
  listEl.innerHTML = '';
  const dictCache = getDictCache();
  const cardsNeedingDefs = [];

  list.words.forEach((w, idx) => {
    const cacheKey = `${w.word}_${S.grade}`;
    const definition = dictCache[cacheKey] || '';

    // Format syllables with colored dots
    const syllableHTML = w.syllables.includes('·')
      ? w.syllables.split('·').map((s, i, arr) =>
          i < arr.length - 1 ? `${s}<span class="syl-dot">·</span>` : s
        ).join('')
      : w.syllables;

    const card = document.createElement('div');
    card.className = 'spelling-word-card' + (w.isRedWord ? ' red-word' : '');
    card.innerHTML = `
      <div class="spelling-word-num">${w.num}</div>
      <div class="spelling-word-main">
        <div>
          <span class="spelling-word-text">${w.word}</span>
          ${w.isRedWord ? '<span class="spelling-red-badge">TRICKY</span>' : ''}
        </div>
        <div class="spelling-syllables">${syllableHTML}</div>
        ${definition
          ? `<div class="spelling-word-def">${definition}</div>`
          : '<div class="spelling-word-def" style="font-style:italic;display:flex;align-items:center;gap:6px;"><span class="spell-def-spinner"></span> Loading definition...</div>'}
      </div>
      <div class="spelling-word-tap">🔊</div>
    `;

    card.addEventListener('click', () => {
      w.practiced = (w.practiced || 0) + 1;
      const data = getData();
      const savedList = data.spellingLists.find(l => l.id === list.id);
      if (savedList) {
        const savedWord = savedList.words.find(sw => sw.word === w.word);
        if (savedWord) savedWord.practiced = w.practiced;
        saveData(data);
      }
      showDictionaryPopup(w.word, -1);
    });

    listEl.appendChild(card);

    // Queue cards that need definitions
    if (!definition) {
      cardsNeedingDefs.push({ word: w.word, card });
    }
  });

  // Batch-fetch definitions for words that don't have cached defs
  fetchDefinitionsBatch(cardsNeedingDefs);
}

async function fetchDefinitionsBatch(queue) {
  if (queue.length === 0) return;

  // Split into chunks of 20
  const chunks = [];
  for (let i = 0; i < queue.length; i += 20) {
    chunks.push(queue.slice(i, i + 20));
  }

  // Process chunks sequentially (to avoid hammering the API)
  for (const chunk of chunks) {
    try {
      const words = chunk.map(c => c.word);
      const response = await fetch(CF_BATCH_DEF, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ words, grade: S.grade || '2' })
      });

      if (!response.ok) throw new Error('Batch define failed');
      const data = await response.json();

      if (data.definitions) {
        // Save to dict cache and update cards
        const cache = getDictCache();
        for (const item of chunk) {
          // Try exact match or lowercase match
          const def = data.definitions[item.word] || data.definitions[item.word.toLowerCase()];
          if (def) {
            const cacheKey = `${item.word}_${S.grade}`;
            cache[cacheKey] = def;
            const defEl = item.card.querySelector('.spelling-word-def');
            if (defEl) {
              defEl.style.fontStyle = 'normal';
              defEl.style.display = 'block';
              defEl.innerHTML = def;
            }
          } else {
            const defEl = item.card.querySelector('.spelling-word-def');
            if (defEl) {
              defEl.style.fontStyle = 'italic';
              defEl.innerHTML = 'Tap to look up meaning';
            }
          }
        }
        saveDictCache(cache);
      }
    } catch (e) {
      console.warn('Batch definition fetch failed:', e);
      // Fallback: mark remaining as tap-to-look-up
      for (const item of chunk) {
        const defEl = item.card.querySelector('.spelling-word-def');
        if (defEl && defEl.innerHTML.includes('Loading')) {
          defEl.style.fontStyle = 'italic';
          defEl.innerHTML = 'Tap to look up meaning';
        }
      }
    }
  }
}

// ── Spelling Word Picker ─────────────────────────────────
let spellingPickedWords = [];
let spellingPracticeMode = 'practice'; // 'practice' or 'test' (future)

document.getElementById('btn-spelling-practice').addEventListener('click', () => {
  if (!currentSpellingList || !currentSpellingList.words.length) return;
  spellingPracticeMode = 'practice';
  openSpellingPicker();
});

function openSpellingPicker() {
  spellingPickedWords = [];
  const listEl = document.getElementById('spell-picker-list');
  listEl.innerHTML = '';

  // Update picker title based on mode
  const pickerTitle = document.querySelector('#screen-spell-picker .card-title');
  if (spellingPracticeMode === 'quiz') {
    pickerTitle.textContent = '📝 Which words do you want to be quizzed on?';
  } else {
    pickerTitle.textContent = '🎯 Which words do you want to practice?';
  }

  // Highlight current voice gender
  document.querySelectorAll('.spell-voice-btn').forEach(b => {
    b.classList.toggle('sel-voice', b.dataset.voice === S.voiceGender);
  });

  currentSpellingList.words.forEach((w, idx) => {
    const row = document.createElement('div');
    row.className = 'spell-picker-word';
    row.dataset.idx = idx;
    row.innerHTML = `
      <div class="spell-picker-check"></div>
      <div class="spell-picker-label">${w.word}${w.isRedWord ? ' <span class="spelling-red-badge">TRICKY</span>' : ''}</div>
    `;
    row.addEventListener('click', () => {
      row.classList.toggle('picked');
      const check = row.querySelector('.spell-picker-check');
      if (row.classList.contains('picked')) {
        check.textContent = '✓';
        if (!spellingPickedWords.includes(idx)) spellingPickedWords.push(idx);
      } else {
        check.textContent = '';
        spellingPickedWords = spellingPickedWords.filter(i => i !== idx);
      }
      updatePickerCount();
    });
    listEl.appendChild(row);
  });

  updatePickerCount();
  updateSelectAllBtn();
  show('screen-spell-picker');
}

function updatePickerCount() {
  const count = spellingPickedWords.length;
  document.getElementById('spell-picker-count').textContent = `${count} word${count !== 1 ? 's' : ''} selected`;
  document.getElementById('btn-spell-picker-go').disabled = count < 1;
  updateSelectAllBtn();
}

function updateSelectAllBtn() {
  const btn = document.getElementById('btn-spell-select-all');
  const allSelected = spellingPickedWords.length === currentSpellingList.words.length;
  btn.classList.toggle('all-selected', allSelected);
  btn.textContent = allSelected ? '✓ All Selected' : 'Select All';
}

document.getElementById('btn-spell-select-all').addEventListener('click', () => {
  const allSelected = spellingPickedWords.length === currentSpellingList.words.length;
  const rows = document.querySelectorAll('#spell-picker-list .spell-picker-word');

  if (allSelected) {
    // Deselect all
    spellingPickedWords = [];
    rows.forEach(row => {
      row.classList.remove('picked');
      row.querySelector('.spell-picker-check').textContent = '';
    });
  } else {
    // Select all
    spellingPickedWords = currentSpellingList.words.map((_, i) => i);
    rows.forEach(row => {
      row.classList.add('picked');
      row.querySelector('.spell-picker-check').textContent = '✓';
    });
  }
  updatePickerCount();
});

document.getElementById('btn-spell-picker-back').addEventListener('click', () => {
  show('screen-spelling');
});

// Voice gender toggle in picker
document.querySelectorAll('.spell-voice-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    S.voiceGender = btn.dataset.voice;
    document.querySelectorAll('.spell-voice-btn').forEach(b => {
      b.classList.toggle('sel-voice', b.dataset.voice === S.voiceGender);
    });
    // Also update the main voice buttons if they exist
    document.querySelectorAll('.voice-btn').forEach(b => {
      b.classList.toggle('sel-voice', b.dataset.voice === S.voiceGender);
    });
  });
});

document.getElementById('btn-spell-picker-go').addEventListener('click', () => {
  if (spellingPickedWords.length < 1) return;
  const selectedWords = spellingPickedWords.map(i => currentSpellingList.words[i]);
  if (spellingPracticeMode === 'quiz') {
    startSpellingQuiz(selectedWords);
  } else {
    startSpellingPractice(selectedWords);
  }
});

// ── Spelling Practice Engine (2 Rounds: MC + Fill) ──────
let practiceWords = [];
let practiceIndex = 0;
let practiceResults = [];
let practiceAnswered = false;
let practiceRound = 1; // 1 = multiple choice, 2 = fill-in-the-blank
let practiceTotalSteps = 0;
let practiceCurrentStep = 0;

function startSpellingPractice(words) {
  practiceWords = shuffleArray([...words]);
  practiceIndex = 0;
  practiceResults = [];
  practiceRound = 1;
  practiceCurrentStep = 0;
  practiceTotalSteps = words.length * 2; // both rounds
  showPracticeQuestion();
  show('screen-spell-practice');
}

function showPracticeQuestion() {
  // Check if current round is done
  if (practiceIndex >= practiceWords.length) {
    if (practiceRound === 1) {
      // Move to round 2: fill-in-the-blank
      practiceRound = 2;
      practiceIndex = 0;
      practiceWords = shuffleArray([...practiceWords]); // reshuffle for round 2
      showPracticeQuestion();
      return;
    } else {
      // Both rounds complete
      showPracticeResults();
      return;
    }
  }

  const word = practiceWords[practiceIndex];
  practiceAnswered = false;
  practiceCurrentStep++;

  // Update round label
  const roundLabel = document.getElementById('spell-round-label');
  if (practiceRound === 1) {
    roundLabel.textContent = 'ROUND 1: MULTIPLE CHOICE';
    roundLabel.className = 'spell-round-label round-mc';
    document.getElementById('spell-practice-hint').textContent = 'Tap the speaker to hear the word, then pick the right spelling!';
  } else {
    roundLabel.textContent = 'ROUND 2: SPELL IT OUT';
    roundLabel.className = 'spell-round-label round-fill';
    document.getElementById('spell-practice-hint').textContent = 'Tap the speaker to hear the word, then type the missing letters!';
  }

  // Update progress across both rounds
  const overallNum = practiceCurrentStep;
  document.getElementById('spell-practice-num').textContent = `${overallNum} / ${practiceTotalSteps}`;
  const pct = ((overallNum - 1) / practiceTotalSteps) * 100;
  document.getElementById('spell-practice-bar').style.width = pct + '%';

  // Clear feedback
  document.getElementById('spell-practice-feedback').innerHTML = '';

  if (practiceRound === 1) {
    // Multiple choice mode
    document.getElementById('spell-practice-choices').style.display = 'grid';
    document.getElementById('spell-fill-area').style.display = 'none';

    const choices = generateSmartChoices(word.word);
    const choicesEl = document.getElementById('spell-practice-choices');
    choicesEl.innerHTML = '';
    choices.forEach(choice => {
      const btn = document.createElement('button');
      btn.className = 'spell-choice-btn';
      btn.textContent = choice;
      btn.addEventListener('click', () => handleMCAnswer(btn, choice, word));
      choicesEl.appendChild(btn);
    });
  } else {
    // Fill-in-the-blank mode
    document.getElementById('spell-practice-choices').style.display = 'none';
    document.getElementById('spell-fill-area').style.display = 'block';

    setupFillInBlank(word);
  }

  // Auto-play the word
  setTimeout(() => sayWordForPractice(word.word), 400);
}

// Wire up the speaker button to replay
document.getElementById('spell-practice-hear').addEventListener('click', () => {
  if (practiceIndex < practiceWords.length) {
    sayWordForPractice(practiceWords[practiceIndex].word);
  }
});

async function sayWordForPractice(word) {
  try {
    const gradeNum = (S.grade === 'prek' || S.grade === 'k') ? 0 : parseInt(S.grade) || 1;
    const gradeKey = (S.grade === 'prek' || S.grade === 'k') ? S.grade : parseInt(S.grade);
    const voiceName = VOICE_NAMES[S.voiceGender]?.[gradeKey] || 'en-US-Wavenet-F';
    const response = await fetch(CF_TTS, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: word, grade: gradeNum, voiceName })
    });
    const data = await response.json();
    if (data.audioBase64) {
      if (dictAudio) { dictAudio.pause(); }
      dictAudio = new Audio('data:audio/mp3;base64,' + data.audioBase64);
      dictAudio.playbackRate = 0.72;
      dictAudio.volume = 1.0;
      dictAudio.play();
      return;
    }
  } catch(e) {}
  const utt = new SpeechSynthesisUtterance(word);
  utt.rate = 0.65; utt.pitch = 1.1; utt.volume = 1.0;
  window.speechSynthesis.speak(utt);
}

// ── Smart Distractor Generation (look-alike words) ──────
function generateSmartChoices(correctWord) {
  const distractors = new Set();
  let attempts = 0;

  // Generate 3 unique distractors that look/sound similar
  while (distractors.size < 3 && attempts < 30) {
    const fake = generateSmartDistractor(correctWord);
    if (fake !== correctWord && !distractors.has(fake)) {
      distractors.add(fake);
    }
    attempts++;
  }

  // Fallback if we couldn't generate enough
  while (distractors.size < 3) {
    distractors.add(correctWord + ['s','ed','er','ly','ing'][distractors.size]);
  }

  return shuffleArray([correctWord, ...distractors]);
}

function generateSmartDistractor(word) {
  const strategies = [
    // Phonetic swaps — sounds the same, spelled differently
    () => {
      const phonSwaps = [
        ['ph','f'],['f','ph'],['gh','g'],['g','gh'],
        ['tion','shun'],['shun','tion'],['sion','cion'],
        ['ough','uff'],['uff','ough'],['ight','ite'],['ite','ight'],
        ['ck','k'],['k','ck'],['ee','ea'],['ea','ee'],
        ['ou','ow'],['ow','ou'],['ai','ay'],['ay','ai'],
        ['ei','ey'],['ey','ei'],['ie','y'],['y','ie'],
        ['er','ur'],['ur','er'],['ir','er'],['or','er'],
        ['oo','ew'],['ew','oo'],['aw','au'],['au','aw'],
        ['dge','ge'],['ge','dge'],['tch','ch'],['ch','tch'],
        ['ce','se'],['se','ce'],['le','el'],['el','le'],
        ['ble','bal'],['ple','pal'],['ful','fle'],
        ['ous','us'],['ious','eous'],['able','ible'],
        ['ence','ance'],['ance','ence'],['ant','ent'],['ent','ant']
      ];
      const shuffled = shuffleArray([...phonSwaps]);
      for (const [from, to] of shuffled) {
        if (word.includes(from)) {
          return word.replace(from, to);
        }
      }
      return null;
    },
    // Swap two adjacent letters (common typo pattern)
    () => {
      if (word.length < 4) return null;
      const i = 1 + Math.floor(Math.random() * (word.length - 3));
      return word.slice(0, i) + word[i + 1] + word[i] + word.slice(i + 2);
    },
    // Double/undouble a consonant
    () => {
      const consonants = 'bcdfghjklmnpqrstvwxyz';
      for (let i = 0; i < word.length - 1; i++) {
        if (word[i] === word[i + 1] && consonants.includes(word[i])) {
          return word.slice(0, i) + word.slice(i + 1); // undouble
        }
      }
      // Or double a consonant
      const cIdxs = word.split('').map((c, i) => consonants.includes(c) ? i : -1).filter(i => i > 0);
      if (cIdxs.length > 0) {
        const idx = cIdxs[Math.floor(Math.random() * cIdxs.length)];
        return word.slice(0, idx) + word[idx] + word.slice(idx);
      }
      return null;
    },
    // Replace a vowel with a similar-sounding vowel
    () => {
      const vowelSwaps = {'a':['e','u'],'e':['a','i'],'i':['e','y'],'o':['u','a'],'u':['o','a']};
      const chars = word.split('');
      const vowelIdxs = chars.map((c, i) => vowelSwaps[c] ? i : -1).filter(i => i >= 0);
      if (vowelIdxs.length === 0) return null;
      const idx = vowelIdxs[Math.floor(Math.random() * vowelIdxs.length)];
      const swapOptions = vowelSwaps[chars[idx]];
      chars[idx] = swapOptions[Math.floor(Math.random() * swapOptions.length)];
      return chars.join('');
    },
    // Add/remove silent e
    () => {
      if (word.endsWith('e') && word.length > 3) {
        return word.slice(0, -1);
      } else if (!word.endsWith('e') && word.length > 2) {
        return word + 'e';
      }
      return null;
    },
    // Similar-sounding real word endings
    () => {
      const endSwaps = [
        ['er','ar'],['ar','er'],['or','er'],['er','or'],
        ['le','al'],['al','le'],['ful','fle'],
        ['ment','mant'],['ment','mint'],
        ['ness','niss'],['ness','nes'],
        ['tion','sion'],['sion','tion'],
        ['ble','bel'],['ple','pel'],
        ['ough','ow'],['ough','off']
      ];
      const shuffled = shuffleArray([...endSwaps]);
      for (const [from, to] of shuffled) {
        if (word.endsWith(from)) {
          return word.slice(0, -from.length) + to;
        }
      }
      return null;
    }
  ];

  // Try strategies in random order until one works
  const shuffled = shuffleArray([...strategies]);
  for (const strategy of shuffled) {
    const result = strategy();
    if (result && result !== word && result.length >= 2) {
      return result;
    }
  }

  // Ultimate fallback: swap a random middle letter
  if (word.length >= 3) {
    const i = 1 + Math.floor(Math.random() * (word.length - 2));
    const chars = word.split('');
    chars[i] = String.fromCharCode(97 + Math.floor(Math.random() * 26));
    return chars.join('');
  }
  return word + 's';
}

// ── Fill-in-the-Blank Logic ─────────────────────────────
let fillWord = '';
let fillGiven = 0;

function setupFillInBlank(wordObj) {
  fillWord = wordObj.word;
  // Show first ~40% of letters (at least 1, at most half)
  fillGiven = Math.max(1, Math.min(Math.ceil(fillWord.length * 0.4), Math.floor(fillWord.length / 2)));

  updateFillDisplay('');

  const input = document.getElementById('spell-fill-input');
  input.value = '';
  input.className = 'spell-fill-input';
  input.disabled = false;
  input.placeholder = 'Type the missing letters...';
  input.focus();
}

function updateFillDisplay(typed) {
  const display = document.getElementById('spell-fill-display');
  let html = '';
  for (let i = 0; i < fillWord.length; i++) {
    if (i < fillGiven) {
      html += `<span class="given">${fillWord[i]}</span>`;
    } else {
      const typedIdx = i - fillGiven;
      if (typedIdx < typed.length) {
        html += `<span class="typed">${typed[typedIdx]}</span>`;
      } else {
        html += `<span class="blank">_</span>`;
      }
    }
  }
  display.innerHTML = html;
}

document.getElementById('spell-fill-input').addEventListener('input', (e) => {
  const typed = e.target.value.toLowerCase();
  const needed = fillWord.length - fillGiven;
  // Limit input length
  if (typed.length > needed) {
    e.target.value = typed.slice(0, needed);
  }
  updateFillDisplay(e.target.value.toLowerCase());
});

document.getElementById('spell-fill-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    checkFillAnswer();
  }
});

document.getElementById('btn-spell-fill-check').addEventListener('click', checkFillAnswer);

function checkFillAnswer() {
  if (practiceAnswered) return;
  practiceAnswered = true;

  const input = document.getElementById('spell-fill-input');
  const typed = input.value.toLowerCase().trim();
  const needed = fillWord.slice(fillGiven);
  const isCorrect = typed === needed;

  input.disabled = true;

  if (isCorrect) {
    input.classList.add('correct');
    // Show full word in green
    const display = document.getElementById('spell-fill-display');
    display.innerHTML = fillWord.split('').map(c => `<span class="typed">${c}</span>`).join('');
    document.getElementById('spell-practice-feedback').innerHTML =
      '<div class="spell-practice-feedback-msg" style="color:var(--green);">✅ Perfect spelling!</div>';
    practiceResults.push({ word: fillWord, correct: true, round: 'fill' });
  } else {
    input.classList.add('wrong');
    // Show correct answer
    const display = document.getElementById('spell-fill-display');
    let html = '';
    for (let i = 0; i < fillWord.length; i++) {
      if (i < fillGiven) {
        html += `<span class="given">${fillWord[i]}</span>`;
      } else {
        const typedIdx = i - fillGiven;
        if (typedIdx < typed.length && typed[typedIdx] === fillWord[i]) {
          html += `<span class="typed">${fillWord[i]}</span>`;
        } else {
          html += `<span class="wrong-char">${fillWord[i]}</span>`;
        }
      }
    }
    display.innerHTML = html;
    document.getElementById('spell-practice-feedback').innerHTML =
      `<div class="spell-practice-feedback-msg" style="color:var(--coral);">The correct spelling is <strong>${fillWord}</strong></div>`;
    practiceResults.push({ word: fillWord, correct: false, round: 'fill' });
  }

  // Save practice data
  const d = getData();
  const savedList = d.spellingLists.find(l => l.id === currentSpellingList.id);
  if (savedList) {
    const savedWord = savedList.words.find(sw => sw.word === fillWord);
    if (savedWord) {
      savedWord.practiced = (savedWord.practiced || 0) + 1;
      if (isCorrect) savedWord.mastered = true;
    }
    saveData(d);
  }

  setTimeout(() => {
    practiceIndex++;
    showPracticeQuestion();
  }, isCorrect ? 1200 : 2500);
}

// ── Multiple Choice Answer Handler ──────────────────────
function handleMCAnswer(btn, choice, word) {
  if (practiceAnswered) return;
  practiceAnswered = true;

  const isCorrect = choice === word.word;
  const allBtns = document.querySelectorAll('.spell-choice-btn');

  allBtns.forEach(b => b.disabled = true);

  if (isCorrect) {
    btn.classList.add('correct');
    document.getElementById('spell-practice-feedback').innerHTML =
      '<div class="spell-practice-feedback-msg" style="color:var(--green);">✅ That\'s right!</div>';
    practiceResults.push({ word: word.word, correct: true, round: 'mc' });
  } else {
    btn.classList.add('wrong');
    allBtns.forEach(b => {
      if (b.textContent === word.word) b.classList.add('reveal');
    });
    document.getElementById('spell-practice-feedback').innerHTML =
      `<div class="spell-practice-feedback-msg" style="color:var(--coral);">The correct spelling is <strong>${word.word}</strong></div>`;
    practiceResults.push({ word: word.word, correct: false, round: 'mc' });
  }

  // Save practice data
  const d = getData();
  const savedList = d.spellingLists.find(l => l.id === currentSpellingList.id);
  if (savedList) {
    const savedWord = savedList.words.find(sw => sw.word === word.word);
    if (savedWord) {
      savedWord.practiced = (savedWord.practiced || 0) + 1;
      if (isCorrect) savedWord.mastered = true;
    }
    saveData(d);
  }

  setTimeout(() => {
    practiceIndex++;
    showPracticeQuestion();
  }, isCorrect ? 1200 : 2200);
}

function showPracticeResults() {
  const mcResults = practiceResults.filter(r => r.round === 'mc');
  const fillResults = practiceResults.filter(r => r.round === 'fill');
  const correct = practiceResults.filter(r => r.correct).length;
  const total = practiceResults.length;
  const pct = Math.round((correct / total) * 100);

  // Score
  document.getElementById('spell-results-score').textContent = `${correct}/${total}`;

  // Stars based on percentage
  let stars = '';
  if (pct === 100) { stars = '⭐⭐⭐'; }
  else if (pct >= 80) { stars = '⭐⭐'; }
  else if (pct >= 50) { stars = '⭐'; }
  else { stars = '💪'; }
  document.getElementById('spell-results-stars').textContent = stars;

  // Title
  if (pct === 100) {
    document.getElementById('spell-results-title').textContent = '🎉 Perfect Score!';
  } else if (pct >= 80) {
    document.getElementById('spell-results-title').textContent = '🌟 Great Job!';
  } else if (pct >= 50) {
    document.getElementById('spell-results-title').textContent = '👍 Good Effort!';
  } else {
    document.getElementById('spell-results-title').textContent = '💪 Keep Practicing!';
  }

  // Result list — grouped by round
  const listEl = document.getElementById('spell-results-list');
  const mcCorrect = mcResults.filter(r => r.correct).length;
  const fillCorrect = fillResults.filter(r => r.correct).length;
  listEl.innerHTML = `
    <div style="font-weight:800;font-size:0.85rem;color:var(--purple-deep);margin:8px 0 4px;">Multiple Choice: ${mcCorrect}/${mcResults.length}</div>
    ${mcResults.map(r => `
      <div class="spell-result-item ${r.correct ? 'got-right' : 'got-wrong'}">
        <span>${r.correct ? '✅' : '❌'}</span>
        <span>${r.word}</span>
      </div>`).join('')}
    <div style="font-weight:800;font-size:0.85rem;color:#C47000;margin:12px 0 4px;">Spell It Out: ${fillCorrect}/${fillResults.length}</div>
    ${fillResults.map(r => `
      <div class="spell-result-item ${r.correct ? 'got-right' : 'got-wrong'}">
        <span>${r.correct ? '✅' : '❌'}</span>
        <span>${r.word}</span>
      </div>`).join('')}
  `;

  // Show retry missed button if there are wrong answers
  const missedWords = practiceResults.filter(r => !r.correct);
  const retryMissedBtn = document.getElementById('btn-spell-retry-missed');
  if (missedWords.length > 0 && missedWords.length < total) {
    retryMissedBtn.style.display = 'block';
    retryMissedBtn.textContent = `🔄 Practice ${missedWords.length} Missed Word${missedWords.length > 1 ? 's' : ''}`;
  } else {
    retryMissedBtn.style.display = 'none';
  }

  // Update progress bar to 100%
  document.getElementById('spell-practice-bar').style.width = '100%';

  show('screen-spell-results');
}

// Results screen buttons
document.getElementById('btn-spell-retry-missed').addEventListener('click', () => {
  const missedWordNames = practiceResults.filter(r => !r.correct).map(r => r.word);
  const missedWordObjects = currentSpellingList.words.filter(w => missedWordNames.includes(w.word));
  startSpellingPractice(missedWordObjects);
});

document.getElementById('btn-spell-retry-all').addEventListener('click', () => {
  // Re-practice the same selected words
  const selectedWords = spellingPickedWords.map(i => currentSpellingList.words[i]);
  startSpellingPractice(selectedWords);
});

document.getElementById('btn-spell-results-done').addEventListener('click', () => {
  show('screen-spelling');
  if (currentSpellingList) renderSpellingWords(currentSpellingList);
});

// Take Quiz Now — quiz the same words they just practiced
document.getElementById('btn-spell-take-quiz').addEventListener('click', () => {
  const selectedWords = spellingPickedWords.map(i => currentSpellingList.words[i]);
  startSpellingQuiz(selectedWords);
});

// ── Spelling Quiz (Full Test Mode) ──────────────────────
let quizWords = [];
let quizIndex = 0;
let quizResults = [];
let quizAnswered = false;

document.getElementById('btn-spelling-quiz').addEventListener('click', () => {
  if (!currentSpellingList || !currentSpellingList.words.length) return;
  spellingPracticeMode = 'quiz';
  openSpellingPicker();
});

function startSpellingQuiz(words) {
  quizWords = shuffleArray([...words]);
  quizIndex = 0;
  quizResults = [];

  // Show 3-2-1 countdown
  show('screen-quiz-countdown');
  let count = 3;
  document.getElementById('quiz-countdown-num').textContent = count;

  const countdownInterval = setInterval(() => {
    count--;
    if (count > 0) {
      document.getElementById('quiz-countdown-num').textContent = count;
      document.getElementById('quiz-countdown-num').style.animation = 'none';
      void document.getElementById('quiz-countdown-num').offsetHeight; // trigger reflow
      document.getElementById('quiz-countdown-num').style.animation = 'quizPulse 0.6s ease';
    } else if (count === 0) {
      document.getElementById('quiz-countdown-num').textContent = 'GO!';
      document.getElementById('quiz-countdown-num').style.animation = 'none';
      void document.getElementById('quiz-countdown-num').offsetHeight;
      document.getElementById('quiz-countdown-num').style.animation = 'quizPulse 0.6s ease';
    } else {
      clearInterval(countdownInterval);
      show('screen-quiz');
      showQuizWord();
    }
  }, 800);
}

function showQuizWord() {
  if (quizIndex >= quizWords.length) {
    showQuizResults();
    return;
  }

  quizAnswered = false;
  const word = quizWords[quizIndex];

  // Update progress
  document.getElementById('quiz-progress-label').textContent = `${quizIndex + 1} / ${quizWords.length}`;
  const pct = (quizIndex / quizWords.length) * 100;
  document.getElementById('quiz-progress-bar').style.width = pct + '%';

  // Reset input
  const input = document.getElementById('quiz-input');
  input.value = '';
  input.className = 'quiz-input';
  input.disabled = false;
  input.placeholder = 'Type the word...';
  input.focus();

  // Clear feedback & correction
  document.getElementById('quiz-feedback').innerHTML = '';
  document.getElementById('quiz-correction').style.display = 'none';
  document.getElementById('quiz-hint').textContent = 'Listen to the word, then spell it!';

  // Auto-play the word
  setTimeout(() => sayWordForPractice(word.word), 300);
}

// Hear word again
document.getElementById('quiz-hear').addEventListener('click', () => {
  if (quizIndex < quizWords.length) {
    sayWordForPractice(quizWords[quizIndex].word);
  }
});

document.getElementById('btn-quiz-replay').addEventListener('click', () => {
  if (quizIndex < quizWords.length) {
    sayWordForPractice(quizWords[quizIndex].word);
  }
});

// Submit answer
document.getElementById('btn-quiz-submit').addEventListener('click', submitQuizAnswer);
document.getElementById('quiz-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') submitQuizAnswer();
});

function submitQuizAnswer() {
  if (quizAnswered) return;
  const input = document.getElementById('quiz-input');
  const typed = input.value.trim().toLowerCase();

  if (!typed) {
    // Shake the input if empty
    input.style.animation = 'choiceShake 0.4s ease';
    setTimeout(() => input.style.animation = '', 400);
    return;
  }

  quizAnswered = true;
  input.disabled = true;

  const word = quizWords[quizIndex];
  const isCorrect = typed === word.word.toLowerCase();

  if (isCorrect) {
    input.classList.add('correct');
    document.getElementById('quiz-feedback').innerHTML =
      '<div class="spell-practice-feedback-msg" style="color:var(--green);">✅ Correct!</div>';
    quizResults.push({ word: word.word, typed, correct: true });
  } else {
    input.classList.add('wrong');
    document.getElementById('quiz-correction').textContent = `Correct: ${word.word}`;
    document.getElementById('quiz-correction').style.display = 'block';
    document.getElementById('quiz-feedback').innerHTML =
      `<div class="spell-practice-feedback-msg" style="color:var(--coral);">Not quite!</div>`;
    quizResults.push({ word: word.word, typed, correct: false });
  }

  // Save practice data
  const d = getData();
  const savedList = d.spellingLists.find(l => l.id === currentSpellingList.id);
  if (savedList) {
    const savedWord = savedList.words.find(sw => sw.word === word.word);
    if (savedWord) {
      savedWord.practiced = (savedWord.practiced || 0) + 1;
      if (isCorrect) savedWord.mastered = true;
    }
    saveData(d);
  }

  setTimeout(() => {
    quizIndex++;
    showQuizWord();
  }, isCorrect ? 1200 : 2500);
}

function showQuizResults() {
  const correct = quizResults.filter(r => r.correct).length;
  const total = quizResults.length;
  const pct = Math.round((correct / total) * 100);

  document.getElementById('quiz-results-score').textContent = `${correct}/${total}`;
  document.getElementById('quiz-progress-bar').style.width = '100%';

  // Stars
  let stars = '';
  if (pct === 100) { stars = '⭐⭐⭐'; }
  else if (pct >= 80) { stars = '⭐⭐'; }
  else if (pct >= 50) { stars = '⭐'; }
  else { stars = '💪'; }
  document.getElementById('quiz-results-stars').textContent = stars;

  // Title
  if (pct === 100) {
    document.getElementById('quiz-results-title').textContent = '🎉 Perfect Score!';
  } else if (pct >= 80) {
    document.getElementById('quiz-results-title').textContent = '🌟 Great Job!';
  } else if (pct >= 50) {
    document.getElementById('quiz-results-title').textContent = '👍 Good Effort!';
  } else {
    document.getElementById('quiz-results-title').textContent = '💪 Keep Studying!';
  }

  // Result list with what they typed vs correct
  const listEl = document.getElementById('quiz-results-list');
  listEl.innerHTML = quizResults.map(r => `
    <div class="spell-result-item ${r.correct ? 'got-right' : 'got-wrong'}">
      <span>${r.correct ? '✅' : '❌'}</span>
      <span style="flex:1;">${r.word}</span>
      ${!r.correct ? `<span style="font-size:0.8rem;opacity:0.7;">wrote: ${r.typed}</span>` : ''}
    </div>
  `).join('');

  // Retry missed
  const missed = quizResults.filter(r => !r.correct);
  const retryBtn = document.getElementById('btn-quiz-retry-missed');
  if (missed.length > 0 && missed.length < total) {
    retryBtn.style.display = 'block';
    retryBtn.textContent = `🔄 Retry ${missed.length} Missed Word${missed.length > 1 ? 's' : ''}`;
  } else {
    retryBtn.style.display = 'none';
  }

  show('screen-quiz-results');
}

// Quiz results buttons
document.getElementById('btn-quiz-retry-missed').addEventListener('click', () => {
  const missedWords = quizResults.filter(r => !r.correct).map(r => r.word);
  const missedObjs = currentSpellingList.words.filter(w => missedWords.includes(w.word));
  startSpellingQuiz(missedObjs);
});

document.getElementById('btn-quiz-retry-all').addEventListener('click', () => {
  const selectedWords = spellingPickedWords.map(i => currentSpellingList.words[i]);
  startSpellingQuiz(selectedWords);
});

document.getElementById('btn-quiz-results-done').addEventListener('click', () => {
  show('screen-spelling');
  if (currentSpellingList) renderSpellingWords(currentSpellingList);
});

// Utility: shuffle array
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ── Bedtime Mode ──────────────────────────────────────────
function applyBedtime(on) {
  document.body.classList.toggle('bedtime', on);
  document.getElementById('btn-bedtime').textContent = on ? '☀️' : '🌙';
  if (on) {
    const slider = document.getElementById('speed-slider');
    if (slider && parseFloat(slider.value) > 0.8) {
      slider.value = 0.8;
      S.speed = 0.8;
      document.getElementById('speed-display').textContent = '0.8×';
    }
  }
}

document.getElementById('btn-bedtime').addEventListener('click', () => {
  const d = getData();
  d.bedtimeMode = !d.bedtimeMode;
  saveData(d);
  applyBedtime(d.bedtimeMode);
});

// Init bedtime on load
(function initBedtime() {
  const d = getData();
  if (d.bedtimeMode) applyBedtime(true);
})();

// ── Parent PIN ────────────────────────────────────────────
let pinBuffer = '';

function updatePinDots() {
  for (let i = 0; i < 4; i++) {
    document.getElementById('pd' + i).classList.toggle('filled', i < pinBuffer.length);
  }
}

document.getElementById('btn-open-parent').addEventListener('click', () => {
  pinBuffer = '';
  updatePinDots();
  document.getElementById('pin-error').textContent = '';
  document.getElementById('screen-pin').style.display = 'flex';
});

document.querySelectorAll('.pin-key').forEach(btn => {
  btn.addEventListener('click', () => {
    const k = btn.dataset.k;
    if (k === 'clear') { pinBuffer = ''; }
    else if (k === 'del') { pinBuffer = pinBuffer.slice(0, -1); }
    else if (pinBuffer.length < 4) { pinBuffer += k; }
    updatePinDots();
    if (pinBuffer.length === 4) {
      const d = getData();
      if (pinBuffer === (d.pin || '1234')) {
        document.getElementById('screen-pin').style.display = 'none';
        pinBuffer = '';
        openParentDashboard();
      } else {
        document.getElementById('pin-error').textContent = 'Incorrect PIN. Try again.';
        pinBuffer = '';
        updatePinDots();
      }
    }
  });
});

document.getElementById('btn-pin-cancel').addEventListener('click', () => {
  document.getElementById('screen-pin').style.display = 'none';
  pinBuffer = '';
});

// ── Parent Dashboard ──────────────────────────────────────
function openParentDashboard() {
  const d = getData();
  const now = new Date();
  const weekStart = new Date(now);
  weekStart.setDate(now.getDate() - now.getDay()); // Sunday
  weekStart.setHours(0, 0, 0, 0);

  // This week stats
  const weekLogs = d.weeklyLog.filter(e => new Date(e.date) >= weekStart);
  const wkStories = weekLogs.reduce((a, e) => a + (e.storiesStarted || 0), 0);
  const wkReads = weekLogs.reduce((a, e) => a + (e.totalReads || 0), 0);
  const wkMins = weekLogs.reduce((a, e) => a + (e.minutesEstimated || 0), 0);
  const wkRereads = d.stories.filter(s => {
    const lastRead = new Date(s.lastRead);
    return lastRead >= weekStart && s.readCount >= 3;
  }).length;

  document.getElementById('week-stories').textContent = wkStories;
  document.getElementById('week-reads').textContent = wkReads;
  document.getElementById('week-mins').textContent = Math.round(wkMins);
  document.getElementById('week-rereads').textContent = wkRereads;

  // All time stats
  const allReads = d.weeklyLog.reduce((a, e) => a + (e.totalReads || 0), 0);
  const allMins = d.weeklyLog.reduce((a, e) => a + (e.minutesEstimated || 0), 0);
  const allRereads = d.stories.filter(s => s.readCount >= 3).length;
  const firstDate = d.weeklyLog.length ? d.weeklyLog[0].date : null;

  document.getElementById('all-stories').textContent = d.stories.length;
  document.getElementById('all-reads').textContent = allReads;
  document.getElementById('all-mins').textContent = Math.round(allMins);
  document.getElementById('all-rereads').textContent = allRereads;
  document.getElementById('first-used-label').textContent = firstDate ? `Using ReadUp! since ${firstDate}` : '';

  // Favorite topics bar chart
  const topicCounts = {};
  d.stories.forEach(s => { topicCounts[s.topic] = (topicCounts[s.topic] || 0) + s.readCount; });
  const sortedTopics = Object.entries(topicCounts).sort((a,b) => b[1]-a[1]).slice(0, 8);
  const maxCount = sortedTopics[0]?.[1] || 1;
  const topicBarsEl = document.getElementById('topic-bars');
  topicBarsEl.innerHTML = sortedTopics.length ? sortedTopics.map(([topic, count]) => `
    <div class="topic-bar-row">
      <div class="topic-bar-name">${topic}</div>
      <div class="topic-bar-wrap"><div class="topic-bar-fill" style="width:${Math.round(count/maxCount*100)}%"></div></div>
      <div class="topic-bar-count">${count}</div>
    </div>`).join('') : '<p style="color:var(--muted);font-size:0.85rem;font-weight:700;">No stories yet!</p>';

  // Reading Speed (WPM)
  const wpmEl = document.getElementById('dash-wpm-content');
  const allWpmScores = [];
  d.stories.forEach(s => {
    if (s.wpmScores && s.wpmScores.length > 0) {
      s.wpmScores.forEach(w => allWpmScores.push({ ...w, topic: s.topic, grade: s.grade }));
    }
  });
  if (allWpmScores.length === 0) {
    wpmEl.innerHTML = '<p style="color:var(--muted);font-size:0.85rem;font-weight:700;">No reading speed data yet. Use "🎤 Read It Myself" after a story!</p>';
  } else {
    const latestWpm = allWpmScores[allWpmScores.length - 1].wpm;
    const bestWpm = Math.max(...allWpmScores.map(s => s.wpm));
    const avgWpm = Math.round(allWpmScores.reduce((a, s) => a + s.wpm, 0) / allWpmScores.length);
    wpmEl.innerHTML = `
      <div class="dash-stat-grid">
        <div class="dash-stat"><div class="dash-stat-num">${latestWpm}</div><div class="dash-stat-label">Latest WPM</div></div>
        <div class="dash-stat"><div class="dash-stat-num">${bestWpm}</div><div class="dash-stat-label">Best WPM</div></div>
        <div class="dash-stat"><div class="dash-stat-num">${avgWpm}</div><div class="dash-stat-label">Average WPM</div></div>
        <div class="dash-stat"><div class="dash-stat-num">${allWpmScores.length}</div><div class="dash-stat-label">Total Reads</div></div>
      </div>
    `;
  }

  // Word bank
  const wordBankEl = document.getElementById('word-bank-display');
  const sorted = [...d.wordBank].sort((a,b) => new Date(b.lastSeen) - new Date(a.lastSeen));
  wordBankEl.innerHTML = sorted.length ? sorted.map(w => `
    <div class="word-bank-item">
      <span class="word-bank-word">${w.word}</span>
      <span style="display:flex;gap:6px;align-items:center;">
        ${w.count >= 3 ? '<span class="word-bank-flag">needs practice</span>' : ''}
        <span class="word-bank-count">×${w.count}</span>
      </span>
    </div>`).join('') : '<p style="color:var(--muted);font-size:0.85rem;font-weight:700;">No words saved yet!</p>';

  // Spelling Words dashboard
  const spellingEl = document.getElementById('dash-spelling-content');
  if (d.spellingLists && d.spellingLists.length > 0) {
    const latest = d.spellingLists[d.spellingLists.length - 1];
    const listDate = new Date(latest.date);
    const dateStr = listDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    const practiced = latest.words.filter(w => (w.practiced || 0) > 0).length;
    spellingEl.innerHTML = `
      <p style="font-size:0.78rem;color:var(--muted);font-weight:700;margin:6px 0 8px;">Latest list: ${dateStr} · ${latest.words.length} words · ${practiced} practiced</p>
      <div class="word-bank-list" style="max-height:160px;">
        ${latest.words.map(w => `
          <div class="word-bank-item">
            <span class="word-bank-word">${w.word}${w.isRedWord ? ' <span style="font-size:0.65rem;background:var(--coral);color:#fff;padding:1px 6px;border-radius:6px;font-weight:800;vertical-align:middle;">TRICKY</span>' : ''}</span>
            <span style="display:flex;gap:6px;align-items:center;">
              ${(w.practiced || 0) > 0 ? '<span style="font-size:0.7rem;background:#EFFFF4;border:1.5px solid var(--green);color:#1B7A3E;padding:2px 7px;border-radius:8px;font-weight:800;">practiced</span>' : '<span class="word-bank-flag">not yet</span>'}
            </span>
          </div>`).join('')}
      </div>
      ${d.spellingLists.length > 1 ? `<p style="font-size:0.75rem;color:var(--muted);font-weight:700;margin-top:8px;">${d.spellingLists.length} total lists saved</p>` : ''}
    `;
  } else {
    spellingEl.innerHTML = '<p style="font-size:0.78rem;color:var(--muted);font-weight:700;margin:6px 0 10px;">No spelling lists uploaded yet.</p>';
  }

  document.getElementById('screen-parent').style.display = 'block';
}

document.getElementById('btn-parent-done').addEventListener('click', () => {
  document.getElementById('screen-parent').style.display = 'none';
});

document.getElementById('btn-clear-words').addEventListener('click', () => {
  if (!confirm('Clear all saved words?')) return;
  const d = getData(); d.wordBank = []; saveData(d);
  openParentDashboard();
});

document.getElementById('btn-clear-spelling').addEventListener('click', () => {
  if (!confirm('Clear all spelling word lists?')) return;
  const d = getData(); d.spellingLists = []; saveData(d);
  currentSpellingList = null;
  openParentDashboard();
});

document.getElementById('btn-save-pin').addEventListener('click', () => {
  const input = document.getElementById('new-pin-input').value.trim();
  if (!/^\d{4}$/.test(input)) {
    document.getElementById('pin-save-msg').textContent = 'PIN must be exactly 4 digits.';
    document.getElementById('pin-save-msg').style.color = 'var(--coral)';
    return;
  }
  const d = getData(); d.pin = input; saveData(d);
  document.getElementById('new-pin-input').value = '';
  document.getElementById('pin-save-msg').textContent = '✓ PIN saved!';
  document.getElementById('pin-save-msg').style.color = 'var(--green)';
  setTimeout(() => { document.getElementById('pin-save-msg').textContent = ''; }, 2000);
});

document.getElementById('btn-reset-data').addEventListener('click', () => {
  if (!confirm('Reset ALL ReadUp! data? This cannot be undone.')) return;
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(DICT_CACHE_KEY);
  openParentDashboard();
  alert('All data has been reset.');
});
// ── Fix 3: Lock page scroll when touching inside story container ──
(function initStoryScrollLock() {
  const container = document.getElementById('story-scroll-container');
  if (!container) return;
  
  container.addEventListener('touchstart', function(e) {
    // Record starting scroll position so we can tell if we're at the edge
    this._scrollTop = this.scrollTop;
    this._scrollHeight = this.scrollHeight;
    this._clientHeight = this.clientHeight;
  }, { passive: true });

  container.addEventListener('touchmove', function(e) {
    const atTop = this.scrollTop <= 0;
    const atBottom = this.scrollTop + this._clientHeight >= this._scrollHeight;
    const scrollingUp = e.touches[0].clientY > (this._lastTouchY || 0);
    const scrollingDown = !scrollingUp;
    this._lastTouchY = e.touches[0].clientY;

    // Only allow page scroll if story is at the very top/bottom AND user is trying to scroll past it
    if ((atTop && scrollingUp) || (atBottom && scrollingDown)) {
      return; // Let page scroll naturally
    }
    // Otherwise prevent page from scrolling — only story scrolls
    e.stopPropagation();
  }, { passive: true });
})();

// Change 7: Offline detection banner
window.addEventListener('offline', () => {
  const t = document.getElementById('word-toast');
  t.textContent = '📡 No internet — stories still work offline!';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 4000);
});
// ── Welcome / Onboarding Flow ─────────────────────────────
(function initWelcome() {
  const d = getData();
  if (d.onboardingDone) return; // Already completed — skip

  // Hide pick screen, show welcome screen 1
  document.getElementById('screen-pick').classList.remove('active');
  document.getElementById('screen-welcome-1').style.display = 'block';
  document.getElementById('screen-welcome-1').classList.add('active');

  document.getElementById('btn-welcome-next-1').addEventListener('click', () => {
    document.getElementById('screen-welcome-1').classList.remove('active');
    document.getElementById('screen-welcome-1').style.display = 'none';
    document.getElementById('screen-welcome-2').style.display = 'block';
    document.getElementById('screen-welcome-2').classList.add('active');
    window.scrollTo({ top: 0, behavior: 'instant' });
  });

  document.getElementById('btn-welcome-next-2').addEventListener('click', () => {
    document.getElementById('screen-welcome-2').classList.remove('active');
    document.getElementById('screen-welcome-2').style.display = 'none';
    document.getElementById('screen-welcome-3').style.display = 'block';
    document.getElementById('screen-welcome-3').classList.add('active');
    window.scrollTo({ top: 0, behavior: 'instant' });
  });

  document.getElementById('btn-welcome-next-3').addEventListener('click', () => {
    document.getElementById('screen-welcome-3').classList.remove('active');
    document.getElementById('screen-welcome-3').style.display = 'none';
    document.getElementById('screen-welcome-4').style.display = 'block';
    document.getElementById('screen-welcome-4').classList.add('active');
    window.scrollTo({ top: 0, behavior: 'instant' });
  });

  // Grade selection on welcome screen 4
  let welcomeGrade = null;
  document.querySelectorAll('#welcome-grade-row .opt-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#welcome-grade-row .opt-btn').forEach(b => b.classList.remove('sel-grade'));
      btn.classList.add('sel-grade');
      welcomeGrade = btn.dataset.wgrade;
      document.getElementById('btn-welcome-go').disabled = false;
    });
  });

  document.getElementById('btn-welcome-go').addEventListener('click', () => {
    if (!welcomeGrade) return;
    // Set grade in app state and sync to pick screen
    S.grade = welcomeGrade;
    const defaultWords = GRADE_DEFAULTS[S.grade] || 100;
    S.wordTarget = defaultWords;
    document.querySelectorAll('#grade-row .opt-btn').forEach(b => {
      b.classList.remove('sel-grade');
      if (b.dataset.grade === welcomeGrade) b.classList.add('sel-grade');
    });
    document.querySelectorAll('#words-row .opt-btn').forEach(b => {
      b.classList.remove('sel-words');
      if (parseInt(b.dataset.words) === defaultWords) b.classList.add('sel-words');
    });
    // Mark onboarding complete
    const d = getData();
    d.onboardingDone = true;
    saveData(d);
    // Go to pick screen
    document.getElementById('screen-welcome-4').classList.remove('active');
    document.getElementById('screen-welcome-4').style.display = 'none';
    show('screen-pick');
  });
})();

// ── How it works (footer) ─────────────────────────────────
document.getElementById('btn-show-welcome').addEventListener('click', () => {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  ['screen-welcome-2', 'screen-welcome-3', 'screen-welcome-4'].forEach(id => {
    document.getElementById(id).style.display = 'none';
    document.getElementById(id).classList.remove('active');
  });
  document.getElementById('screen-welcome-1').style.display = 'block';
  document.getElementById('screen-welcome-1').classList.add('active');

  // Rebind next buttons for screens 1→2→3→4
  const rebind = (fromId, toId) => {
    const btn = document.getElementById('btn-welcome-next-' + fromId);
    const fresh = btn.cloneNode(true);
    btn.parentNode.replaceChild(fresh, btn);
    fresh.addEventListener('click', () => {
      document.getElementById('screen-welcome-' + fromId).classList.remove('active');
      document.getElementById('screen-welcome-' + fromId).style.display = 'none';
      document.getElementById('screen-welcome-' + toId).style.display = 'block';
      document.getElementById('screen-welcome-' + toId).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'instant' });
    });
  };
  rebind(1, 2); rebind(2, 3); rebind(3, 4);

  // On replay, screen 4 "Start Reading" just returns to pick screen
  const goBtn = document.getElementById('btn-welcome-go');
  const freshGo = goBtn.cloneNode(true);
  freshGo.disabled = false;
  freshGo.textContent = '← Back to ReadUp!';
  goBtn.parentNode.replaceChild(freshGo, goBtn);
  freshGo.addEventListener('click', () => {
    document.getElementById('screen-welcome-4').classList.remove('active');
    document.getElementById('screen-welcome-4').style.display = 'none';
    show('screen-pick');
  });

  window.scrollTo({ top: 0, behavior: 'instant' });
});

// ── Reading Mode (Fullscreen) ────────────────────────────
const readingOverlay = document.createElement('div');
readingOverlay.className = 'reading-mode-overlay';
readingOverlay.id = 'reading-mode-overlay';
readingOverlay.innerHTML = `
  <div class="reading-mode-inner">
    <div class="reading-mode-title" id="rm-title"></div>
    <div class="reading-mode-text" id="rm-text"></div>
  </div>
  <div class="reading-mode-fab">
    <button class="btn-rm-close" id="btn-rm-close">✕ Exit</button>
    <button class="btn-rm-listen" id="btn-rm-listen">🔊 Listen</button>
  </div>
`;
document.body.appendChild(readingOverlay);

document.getElementById('btn-reading-mode').addEventListener('click', () => {
  if (!S.story) return;
  // Copy story title
  document.getElementById('rm-title').textContent = document.getElementById('story-title').textContent;
  // Copy story text with tappable words
  const storyText = S.story;
  const words = storyText.split(/(\s+)/);
  const html = words.map(w => {
    if (w.trim() === '') return w;
    const clean = w.replace(/[^a-zA-Z'-]/g, '');
    if (clean) {
      return `<span class="word-span" data-word="${clean}">${w}</span>`;
    }
    return w;
  }).join('');
  document.getElementById('rm-text').innerHTML = html;

  // Make words tappable for dictionary
  document.querySelectorAll('#rm-text .word-span').forEach(span => {
    span.addEventListener('click', () => {
      const w = span.dataset.word;
      showDictionaryPopup(w, -1);
    });
  });

  readingOverlay.classList.add('active');
  document.body.style.overflow = 'hidden';
});

document.getElementById('btn-rm-close').addEventListener('click', closeReadingMode);

function closeReadingMode() {
  readingOverlay.classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('btn-rm-listen').textContent = '🔊 Listen';
  // Clear reading mode highlights
  document.querySelectorAll('#rm-text .word-span').forEach(w => w.classList.remove('active-word'));
}

// Listen button in reading mode — toggles TTS play/pause
document.getElementById('btn-rm-listen').addEventListener('click', () => {
  if (ttsState === 'playing') {
    // Already playing, pause it
    const pauseBtn = document.getElementById('btn-pause');
    if (pauseBtn && !pauseBtn.disabled) pauseBtn.click();
    document.getElementById('btn-rm-listen').textContent = '🔊 Listen';
  } else if (ttsState === 'paused') {
    // Resume
    const playBtn = document.getElementById('btn-play');
    if (playBtn) playBtn.click();
    document.getElementById('btn-rm-listen').textContent = '⏸ Pause';
  } else {
    // Not playing, start
    const playBtn = document.getElementById('btn-play');
    if (playBtn && !playBtn.disabled) playBtn.click();
    document.getElementById('btn-rm-listen').textContent = '⏸ Pause';
  }
});

// Close reading mode on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && readingOverlay.classList.contains('active')) {
    closeReadingMode();
  }
});

// ── Floating Play/Pause Button (works in both modes) ────
const floatTTSBtn = document.createElement('button');
floatTTSBtn.className = 'float-tts-btn';
floatTTSBtn.id = 'float-tts-btn';
floatTTSBtn.textContent = '⏸ Pause';
document.body.appendChild(floatTTSBtn);

floatTTSBtn.addEventListener('click', () => {
  if (ttsState === 'playing') {
    const pauseBtn = document.getElementById('btn-pause');
    if (pauseBtn && !pauseBtn.disabled) pauseBtn.click();
  } else if (ttsState === 'paused') {
    const playBtn = document.getElementById('btn-play');
    if (playBtn) playBtn.click();
  }
});

// Poll TTS state to show/hide and update the floating button
let lastFloatState = '';
setInterval(() => {
  const isReadScreen = document.getElementById('screen-read')?.classList.contains('active');
  const isReadingMode = readingOverlay.classList.contains('active');
  const shouldShow = (isReadScreen || isReadingMode) && (ttsState === 'playing' || ttsState === 'paused');

  if (shouldShow) {
    floatTTSBtn.style.display = 'block';
    if (ttsState !== lastFloatState) {
      lastFloatState = ttsState;
      if (ttsState === 'playing') {
        floatTTSBtn.textContent = '⏸ Pause';
        floatTTSBtn.className = 'float-tts-btn playing';
        // Also sync reading mode button
        const rmBtn = document.getElementById('btn-rm-listen');
        if (rmBtn) rmBtn.textContent = '⏸ Pause';
      } else if (ttsState === 'paused') {
        floatTTSBtn.textContent = '▶ Play';
        floatTTSBtn.className = 'float-tts-btn paused';
        const rmBtn = document.getElementById('btn-rm-listen');
        if (rmBtn) rmBtn.textContent = '🔊 Listen';
      }
    }
  } else {
    floatTTSBtn.style.display = 'none';
    lastFloatState = '';
  }
}, 200);

</script>
</body>
</html>